import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Injectable } from '@angular/core';
import moment from 'moment-es6';
import { from, throwError } from 'rxjs';
import { WidgetTypeEnum } from '../models/widget-visibility.model';
import { map, catchError } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
export class WidgetVisibilityService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    refreshVisibility(form, processVarList) {
        this.form = form;
        if (processVarList) {
            this.processVarList = processVarList;
        }
        if (form && form.tabs && form.tabs.length > 0) {
            form.tabs.map((tabModel) => this.refreshEntityVisibility(tabModel));
        }
        if (form && form.outcomes && form.outcomes.length > 0) {
            form.outcomes.map((outcomeModel) => this.refreshOutcomeVisibility(outcomeModel));
        }
        if (form) {
            form.getFormFields().map((field) => this.refreshEntityVisibility(field));
        }
    }
    refreshEntityVisibility(element) {
        const visible = this.evaluateVisibility(element.form, element.visibilityCondition);
        element.isVisible = visible && this.isParentTabVisible(this.form, element);
    }
    refreshOutcomeVisibility(element) {
        element.isVisible = this.evaluateVisibility(element.form, element.visibilityCondition);
    }
    evaluateVisibility(form, visibilityObj) {
        const isLeftFieldPresent = visibilityObj && (visibilityObj.leftType || visibilityObj.leftValue);
        if (!isLeftFieldPresent || isLeftFieldPresent === 'null') {
            return true;
        }
        else {
            return this.isFieldVisible(form, visibilityObj);
        }
    }
    isFieldVisible(form, visibilityObj, accumulator = [], result = false) {
        const leftValue = this.getLeftValue(form, visibilityObj);
        const rightValue = this.getRightValue(form, visibilityObj);
        const actualResult = this.evaluateCondition(leftValue, rightValue, visibilityObj.operator);
        if (this.isValidOperator(visibilityObj.nextConditionOperator)) {
            accumulator.push({ value: actualResult, operator: visibilityObj.nextConditionOperator });
        }
        if (this.isValidCondition(visibilityObj.nextCondition)) {
            result = this.isFieldVisible(form, visibilityObj.nextCondition, accumulator);
        }
        else if (accumulator[0] !== undefined) {
            result = accumulator[0].value;
            for (let i = 1; i < accumulator.length; i++) {
                if (accumulator[i] !== undefined) {
                    result = this.evaluateLogicalOperation(accumulator[i - 1].operator, result, accumulator[i].value);
                }
            }
        }
        else {
            result = actualResult;
        }
        return !!result;
    }
    getLeftValue(form, visibilityObj) {
        let leftValue = '';
        if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.variable) {
            leftValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
        }
        else if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.field) {
            leftValue = this.getFormValue(form, visibilityObj.leftValue);
            if (leftValue === undefined || leftValue === '') {
                const variableValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
                leftValue = !this.isInvalidValue(variableValue) ? variableValue : leftValue;
            }
        }
        return leftValue;
    }
    getRightValue(form, visibilityObj) {
        let valueFound = '';
        if (visibilityObj.rightType === WidgetTypeEnum.variable) {
            valueFound = this.getVariableValue(form, visibilityObj.rightValue, this.processVarList);
        }
        else if (visibilityObj.rightType === WidgetTypeEnum.field) {
            valueFound = this.getFormValue(form, visibilityObj.rightValue);
        }
        else {
            if (moment(visibilityObj.rightValue, 'YYYY-MM-DD', true).isValid()) {
                valueFound = visibilityObj.rightValue + 'T00:00:00.000Z';
            }
            else {
                valueFound = visibilityObj.rightValue;
            }
        }
        return valueFound;
    }
    getFormValue(form, fieldId) {
        const formField = this.getFormFieldById(form, fieldId);
        let value = undefined;
        if (this.isFormFieldValid(formField)) {
            value = this.getFieldValue(form.values, fieldId);
            if (this.isInvalidValue(value)) {
                value = this.searchValueInForm(formField, fieldId);
            }
        }
        return value;
    }
    isFormFieldValid(formField) {
        return formField && formField.isValid;
    }
    getFieldValue(valueList, fieldId) {
        let labelFilterByName, valueFound;
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            labelFilterByName = fieldId.substring(0, fieldId.length - 6);
            if (valueList[labelFilterByName]) {
                valueFound = valueList[labelFilterByName].name;
            }
        }
        else if (valueList[fieldId] && valueList[fieldId].id) {
            valueFound = valueList[fieldId].id;
        }
        else {
            valueFound = valueList[fieldId];
        }
        return valueFound;
    }
    isInvalidValue(value) {
        return value === undefined || value === null;
    }
    getFormFieldById(form, fieldId) {
        return form.getFormFields().find((formField) => this.isSearchedField(formField, fieldId));
    }
    searchValueInForm(formField, fieldId) {
        let fieldValue = '';
        if (formField) {
            fieldValue = this.getObjectValue(formField, fieldId);
            if (!fieldValue) {
                if (formField.value && formField.value.id) {
                    fieldValue = formField.value.id;
                }
                else if (!this.isInvalidValue(formField.value)) {
                    fieldValue = formField.value;
                }
            }
        }
        return fieldValue;
    }
    isParentTabVisible(form, currentFormField) {
        const containers = this.getFormTabContainers(form);
        let isVisible = true;
        containers.map((container) => {
            if (!!this.getCurrentFieldFromTabById(container, currentFormField.id)) {
                const currentTab = form.tabs.find((tab) => tab.id === container.tab);
                if (!!currentTab) {
                    isVisible = currentTab.isVisible;
                }
            }
        });
        return isVisible;
    }
    getCurrentFieldFromTabById(container, fieldId) {
        const tabFields = Object.keys(container.field.fields).map(key => container.field.fields[key]);
        let currentField;
        for (const tabField of tabFields) {
            currentField = tabField.find((tab) => tab.id === fieldId);
            if (currentField) {
                return currentField;
            }
        }
        return null;
    }
    getFormTabContainers(form) {
        if (!!form) {
            return form.fields.filter(field => field.type === 'container' && field.tab);
        }
        return [];
    }
    getObjectValue(field, fieldId) {
        let value = '';
        if (field.value && field.value.name) {
            value = field.value.name;
        }
        else if (field.options) {
            const option = field.options.find((opt) => opt.id === field.value);
            if (option) {
                value = this.getValueFromOption(fieldId, option);
            }
        }
        return value;
    }
    getValueFromOption(fieldId, option) {
        let optionValue = '';
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            optionValue = option.name;
        }
        else {
            optionValue = option.id;
        }
        return optionValue;
    }
    isSearchedField(field, fieldId) {
        const fieldToFind = (fieldId === null || fieldId === void 0 ? void 0 : fieldId.indexOf('_LABEL')) > 0 ? fieldId.replace('_LABEL', '') : fieldId;
        return (field.id && fieldToFind) ? field.id.toUpperCase() === fieldToFind.toUpperCase() : false;
    }
    getVariableValue(form, name, processVarList) {
        const processVariableValue = this.getProcessVariableValue(name, processVarList);
        const variableDefaultValue = form.getFormVariableValue(name);
        return (processVariableValue === undefined) ? variableDefaultValue : processVariableValue;
    }
    getProcessVariableValue(name, processVarList) {
        if (processVarList) {
            const processVariable = processVarList.find(variable => variable.id === name ||
                variable.id === `variables.${name}`);
            if (processVariable) {
                return processVariable.value;
            }
        }
        return undefined;
    }
    evaluateLogicalOperation(logicOp, previousValue, newValue) {
        switch (logicOp) {
            case 'and':
                return previousValue && newValue;
            case 'or':
                return previousValue || newValue;
            case 'and-not':
                return previousValue && !newValue;
            case 'or-not':
                return previousValue || !newValue;
            default:
                this.logService.error(`Invalid operator: ${logicOp}`);
                return undefined;
        }
    }
    evaluateCondition(leftValue, rightValue, operator) {
        switch (operator) {
            case '==':
                return leftValue + '' === rightValue + '';
            case '<':
                return leftValue < rightValue;
            case '!=':
                return leftValue + '' !== rightValue + '';
            case '>':
                return leftValue > rightValue;
            case '>=':
                return leftValue >= rightValue;
            case '<=':
                return leftValue <= rightValue;
            case 'empty':
                return leftValue ? leftValue === '' : true;
            case '!empty':
                return leftValue ? leftValue !== '' : false;
            default:
                this.logService.error(`Invalid operator: ${operator}`);
                return undefined;
        }
    }
    cleanProcessVariable() {
        this.processVarList = [];
    }
    getTaskProcessVariable(taskId) {
        return from(this.apiService.getInstance().activiti.taskFormsApi.getTaskFormVariables(taskId))
            .pipe(map((res) => {
            const jsonRes = this.toJson(res);
            this.processVarList = jsonRes;
            return jsonRes;
        }), catchError(() => this.handleError()));
    }
    toJson(res) {
        return res || {};
    }
    isValidOperator(operator) {
        return operator !== undefined;
    }
    isValidCondition(condition) {
        return !!(condition && condition.operator);
    }
    handleError() {
        this.logService.error('Error while performing a call');
        return throwError('Error while performing a call - Server error');
    }
}
WidgetVisibilityService.ɵprov = i0.ɵɵdefineInjectable({ factory: function WidgetVisibilityService_Factory() { return new WidgetVisibilityService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: WidgetVisibilityService, providedIn: "root" });
WidgetVisibilityService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
WidgetVisibilityService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXZpc2liaWxpdHkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJmb3JtL3NlcnZpY2VzL3dpZGdldC12aXNpYmlsaXR5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sTUFBTSxNQUFNLFlBQVksQ0FBQztBQUNoQyxPQUFPLEVBQWMsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVNwRCxPQUFPLEVBQXlCLGNBQWMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQzFGLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFLakQsTUFBTSxPQUFPLHVCQUF1QjtJQUtoQyxZQUFvQixVQUE4QixFQUM5QixVQUFzQjtRQUR0QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQzFDLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxJQUFlLEVBQUUsY0FBMkM7UUFDakYsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxjQUFjLEVBQUU7WUFDaEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7U0FDeEM7UUFDRCxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxF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QUM7WUFDakMsSUFBSSxDQUFDLGNBQWMsR0FBZ0MsT0FBTyxDQUFDO1lBQzNELE9BQU8sT0FBTyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FDdkMsQ0FBQztJQUNWLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBUTtRQUNYLE9BQU8sR0FBRyxJQUFJLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRU8sZUFBZSxDQUFDLFFBQWdCO1FBQ3BDLE9BQU8sUUFBUSxLQUFLLFNBQVMsQ0FBQztJQUNsQyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsU0FBZ0M7UUFDckQsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTyxXQUFXO1FBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUN2RCxPQUFPLFVBQVUsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7Ozs7WUFoVUosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFsQlEsa0JBQWtCO1lBQ2xCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtZXM2JztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gICAgRm9ybUZpZWxkTW9kZWwsXG4gICAgRm9ybU1vZGVsLFxuICAgIFRhYk1vZGVsLFxuICAgIENvbnRhaW5lck1vZGVsLFxuICAgIEZvcm1PdXRjb21lTW9kZWxcbn0gZnJvbSAnLi4vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL3Rhc2stcHJvY2Vzcy12YXJpYWJsZS5tb2RlbCc7XG5pbXBvcnQgeyBXaWRnZXRWaXNpYmlsaXR5TW9kZWwsIFdpZGdldFR5cGVFbnVtIH0gZnJvbSAnLi4vbW9kZWxzL3dpZGdldC12aXNpYmlsaXR5Lm1vZGVsJztcbmltcG9ydCB7IG1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBXaWRnZXRWaXNpYmlsaXR5U2VydmljZSB7XG5cbiAgICBwcml2YXRlIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXTtcbiAgICBwcml2YXRlIGZvcm06IEZvcm1Nb2RlbDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSkge1xuICAgIH1cblxuICAgIHB1YmxpYyByZWZyZXNoVmlzaWJpbGl0eShmb3JtOiBGb3JtTW9kZWwsIHByb2Nlc3NWYXJMaXN0PzogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pIHtcbiAgICAgICAgdGhpcy5mb3JtID0gZm9ybTtcbiAgICAgICAgaWYgKHByb2Nlc3NWYXJMaXN0KSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gcHJvY2Vzc1Zhckxpc3Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvcm0gJiYgZm9ybS50YWJzICYmIGZvcm0udGFicy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmb3JtLnRhYnMubWFwKCh0YWJNb2RlbCkgPT4gdGhpcy5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eSh0YWJNb2RlbCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvcm0gJiYgZm9ybS5vdXRjb21lcyAmJiBmb3JtLm91dGNvbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvcm0ub3V0Y29tZXMubWFwKChvdXRjb21lTW9kZWwpID0+IHRoaXMucmVmcmVzaE91dGNvbWVWaXNpYmlsaXR5KG91dGNvbWVNb2RlbCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgIGZvcm0uZ2V0Rm9ybUZpZWxkcygpLm1hcCgoZmllbGQpID0+IHRoaXMucmVmcmVzaEVudGl0eVZpc2liaWxpdHkoZmllbGQpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KGVsZW1lbnQ6IEZvcm1GaWVsZE1vZGVsIHwgVGFiTW9kZWwpIHtcbiAgICAgICAgY29uc3QgdmlzaWJsZSA9IHRoaXMuZXZhbHVhdGVWaXNpYmlsaXR5KGVsZW1lbnQuZm9ybSwgZWxlbWVudC52aXNpYmlsaXR5Q29uZGl0aW9uKTtcbiAgICAgICAgZWxlbWVudC5pc1Zpc2libGUgPSB2aXNpYmxlICYmIHRoaXMuaXNQYXJlbnRUYWJWaXNpYmxlKHRoaXMuZm9ybSwgZWxlbWVudCk7XG4gICAgfVxuXG4gICAgcmVmcmVzaE91dGNvbWVWaXNpYmlsaXR5KGVsZW1lbnQ6IEZvcm1PdXRjb21lTW9kZWwpIHtcbiAgICAgICAgZWxlbWVudC5pc1Zpc2libGUgPSB0aGlzLmV2YWx1YXRlVmlzaWJpbGl0eShlbGVtZW50LmZvcm0sIGVsZW1lbnQudmlzaWJpbGl0eUNvbmRpdGlvbik7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGlzTGVmdEZpZWxkUHJlc2VudCA9IHZpc2liaWxpdHlPYmogJiYgKHZpc2liaWxpdHlPYmoubGVmdFR5cGUgfHwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUpO1xuICAgICAgICBpZiAoIWlzTGVmdEZpZWxkUHJlc2VudCB8fCBpc0xlZnRGaWVsZFByZXNlbnQgPT09ICdudWxsJykge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc0ZpZWxkVmlzaWJsZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzRmllbGRWaXNpYmxlKGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsLCBhY2N1bXVsYXRvcjogYW55W10gPSBbXSwgcmVzdWx0OiBib29sZWFuID0gZmFsc2UpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgbGVmdFZhbHVlID0gdGhpcy5nZXRMZWZ0VmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIGNvbnN0IHJpZ2h0VmFsdWUgPSB0aGlzLmdldFJpZ2h0VmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iaik7XG4gICAgICAgIGNvbnN0IGFjdHVhbFJlc3VsdCA9IHRoaXMuZXZhbHVhdGVDb25kaXRpb24obGVmdFZhbHVlLCByaWdodFZhbHVlLCB2aXNpYmlsaXR5T2JqLm9wZXJhdG9yKTtcblxuICAgICAgICBpZiAodGhpcy5pc1ZhbGlkT3BlcmF0b3IodmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uT3BlcmF0b3IpKSB7XG4gICAgICAgICAgICBhY2N1bXVsYXRvci5wdXNoKHsgdmFsdWU6IGFjdHVhbFJlc3VsdCwgb3BlcmF0b3I6IHZpc2liaWxpdHlPYmoubmV4dENvbmRpdGlvbk9wZXJhdG9yIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaXNWYWxpZENvbmRpdGlvbih2aXNpYmlsaXR5T2JqLm5leHRDb25kaXRpb24pKSB7XG4gICAgICAgICAgICByZXN1bHQgPSB0aGlzLmlzRmllbGRWaXNpYmxlKGZvcm0sIHZpc2liaWxpdHlPYmoubmV4dENvbmRpdGlvbiwgYWNjdW11bGF0b3IpO1xuICAgICAgICB9IGVsc2UgaWYgKGFjY3VtdWxhdG9yWzBdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGFjY3VtdWxhdG9yWzBdLnZhbHVlO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBhY2N1bXVsYXRvci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChhY2N1bXVsYXRvcltpXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuZXZhbHVhdGVMb2dpY2FsT3BlcmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0b3JbaSAtIDFdLm9wZXJhdG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LFxuICAgICAgICAgICAgICAgICAgICAgICAgYWNjdW11bGF0b3JbaV0udmFsdWVcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgPSBhY3R1YWxSZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICEhcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgZ2V0TGVmdFZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgdmlzaWJpbGl0eU9iajogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGxlZnRWYWx1ZSA9ICcnO1xuICAgICAgICBpZiAodmlzaWJpbGl0eU9iai5sZWZ0VHlwZSAmJiB2aXNpYmlsaXR5T2JqLmxlZnRUeXBlID09PSBXaWRnZXRUeXBlRW51bS52YXJpYWJsZSkge1xuICAgICAgICAgICAgbGVmdFZhbHVlID0gdGhpcy5nZXRWYXJpYWJsZVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdFZhbHVlLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmlsaXR5T2JqLmxlZnRUeXBlICYmIHZpc2liaWxpdHlPYmoubGVmdFR5cGUgPT09IFdpZGdldFR5cGVFbnVtLmZpZWxkKSB7XG4gICAgICAgICAgICBsZWZ0VmFsdWUgPSB0aGlzLmdldEZvcm1WYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSk7XG4gICAgICAgICAgICBpZiAobGVmdFZhbHVlID09PSB1bmRlZmluZWQgfHwgbGVmdFZhbHVlID09PSAnJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhcmlhYmxlVmFsdWUgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUsIHRoaXMucHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICAgICAgICAgIGxlZnRWYWx1ZSA9ICF0aGlzLmlzSW52YWxpZFZhbHVlKHZhcmlhYmxlVmFsdWUpID8gdmFyaWFibGVWYWx1ZSA6IGxlZnRWYWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGVmdFZhbHVlO1xuICAgIH1cblxuICAgIGdldFJpZ2h0VmFsdWUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBzdHJpbmcge1xuICAgICAgICBsZXQgdmFsdWVGb3VuZCA9ICcnO1xuICAgICAgICBpZiAodmlzaWJpbGl0eU9iai5yaWdodFR5cGUgPT09IFdpZGdldFR5cGVFbnVtLnZhcmlhYmxlKSB7XG4gICAgICAgICAgICB2YWx1ZUZvdW5kID0gdGhpcy5nZXRWYXJpYWJsZVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSwgdGhpcy5wcm9jZXNzVmFyTGlzdCk7XG4gICAgICAgIH0gZWxzZSBpZiAodmlzaWJpbGl0eU9iai5yaWdodFR5cGUgPT09IFdpZGdldFR5cGVFbnVtLmZpZWxkKSB7XG4gICAgICAgICAgICB2YWx1ZUZvdW5kID0gdGhpcy5nZXRGb3JtVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5yaWdodFZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChtb21lbnQodmlzaWJpbGl0eU9iai5yaWdodFZhbHVlLCAnWVlZWS1NTS1ERCcsIHRydWUpLmlzVmFsaWQoKSkge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUgKyAnVDAwOjAwOjAwLjAwMFonO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmlzaWJpbGl0eU9iai5yaWdodFZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZUZvdW5kO1xuICAgIH1cblxuICAgIGdldEZvcm1WYWx1ZShmb3JtOiBGb3JtTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGNvbnN0IGZvcm1GaWVsZCA9IHRoaXMuZ2V0Rm9ybUZpZWxkQnlJZChmb3JtLCBmaWVsZElkKTtcbiAgICAgICAgbGV0IHZhbHVlID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIGlmICh0aGlzLmlzRm9ybUZpZWxkVmFsaWQoZm9ybUZpZWxkKSkge1xuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldEZpZWxkVmFsdWUoZm9ybS52YWx1ZXMsIGZpZWxkSWQpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pc0ludmFsaWRWYWx1ZSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuc2VhcmNoVmFsdWVJbkZvcm0oZm9ybUZpZWxkLCBmaWVsZElkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgaXNGb3JtRmllbGRWYWxpZChmb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBmb3JtRmllbGQgJiYgZm9ybUZpZWxkLmlzVmFsaWQ7XG4gICAgfVxuXG4gICAgZ2V0RmllbGRWYWx1ZSh2YWx1ZUxpc3Q6IGFueSwgZmllbGRJZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgbGV0IGxhYmVsRmlsdGVyQnlOYW1lLCB2YWx1ZUZvdW5kO1xuICAgICAgICBpZiAoZmllbGRJZCAmJiBmaWVsZElkLmluZGV4T2YoJ19MQUJFTCcpID4gMCkge1xuICAgICAgICAgICAgbGFiZWxGaWx0ZXJCeU5hbWUgPSBmaWVsZElkLnN1YnN0cmluZygwLCBmaWVsZElkLmxlbmd0aCAtIDYpO1xuICAgICAgICAgICAgaWYgKHZhbHVlTGlzdFtsYWJlbEZpbHRlckJ5TmFtZV0pIHtcbiAgICAgICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmFsdWVMaXN0W2xhYmVsRmlsdGVyQnlOYW1lXS5uYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlTGlzdFtmaWVsZElkXSAmJiB2YWx1ZUxpc3RbZmllbGRJZF0uaWQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGRJZF0uaWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWx1ZUZvdW5kID0gdmFsdWVMaXN0W2ZpZWxkSWRdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZUZvdW5kO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNJbnZhbGlkVmFsdWUodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRGb3JtRmllbGRCeUlkKGZvcm06IEZvcm1Nb2RlbCwgZmllbGRJZDogc3RyaW5nKTogRm9ybUZpZWxkTW9kZWwge1xuICAgICAgICByZXR1cm4gZm9ybS5nZXRGb3JtRmllbGRzKCkuZmluZCgoZm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCkgPT4gdGhpcy5pc1NlYXJjaGVkRmllbGQoZm9ybUZpZWxkLCBmaWVsZElkKSk7XG4gICAgfVxuXG4gICAgc2VhcmNoVmFsdWVJbkZvcm0oZm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCwgZmllbGRJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGZpZWxkVmFsdWUgPSAnJztcblxuICAgICAgICBpZiAoZm9ybUZpZWxkKSB7XG4gICAgICAgICAgICBmaWVsZFZhbHVlID0gdGhpcy5nZXRPYmplY3RWYWx1ZShmb3JtRmllbGQsIGZpZWxkSWQpO1xuXG4gICAgICAgICAgICBpZiAoIWZpZWxkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9ybUZpZWxkLnZhbHVlICYmIGZvcm1GaWVsZC52YWx1ZS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlID0gZm9ybUZpZWxkLnZhbHVlLmlkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuaXNJbnZhbGlkVmFsdWUoZm9ybUZpZWxkLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFZhbHVlID0gZm9ybUZpZWxkLnZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmllbGRWYWx1ZTtcbiAgICB9XG5cbiAgICBpc1BhcmVudFRhYlZpc2libGUoZm9ybTogRm9ybU1vZGVsLCBjdXJyZW50Rm9ybUZpZWxkOiBGb3JtRmllbGRNb2RlbCB8IFRhYk1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSB0aGlzLmdldEZvcm1UYWJDb250YWluZXJzKGZvcm0pO1xuICAgICAgICBsZXQgaXNWaXNpYmxlOiBib29sZWFuID0gdHJ1ZTtcbiAgICAgICAgY29udGFpbmVycy5tYXAoKGNvbnRhaW5lcjogQ29udGFpbmVyTW9kZWwpID0+IHtcbiAgICAgICAgICAgIGlmICghIXRoaXMuZ2V0Q3VycmVudEZpZWxkRnJvbVRhYkJ5SWQoY29udGFpbmVyLCBjdXJyZW50Rm9ybUZpZWxkLmlkKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRUYWIgPSBmb3JtLnRhYnMuZmluZCgodGFiOiBUYWJNb2RlbCkgPT4gdGFiLmlkID09PSBjb250YWluZXIudGFiKTtcbiAgICAgICAgICAgICAgICBpZiAoISFjdXJyZW50VGFiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVmlzaWJsZSA9IGN1cnJlbnRUYWIuaXNWaXNpYmxlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpc1Zpc2libGU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDdXJyZW50RmllbGRGcm9tVGFiQnlJZChjb250YWluZXI6IENvbnRhaW5lck1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIGNvbnN0IHRhYkZpZWxkczogRm9ybUZpZWxkTW9kZWxbXVtdID0gT2JqZWN0LmtleXMoY29udGFpbmVyLmZpZWxkLmZpZWxkcykubWFwKGtleSA9PiBjb250YWluZXIuZmllbGQuZmllbGRzW2tleV0pO1xuICAgICAgICBsZXQgY3VycmVudEZpZWxkOiBGb3JtRmllbGRNb2RlbDtcblxuICAgICAgICBmb3IgKGNvbnN0IHRhYkZpZWxkIG9mIHRhYkZpZWxkcykge1xuICAgICAgICAgICAgY3VycmVudEZpZWxkID0gdGFiRmllbGQuZmluZCgodGFiOiBGb3JtRmllbGRNb2RlbCkgPT4gdGFiLmlkID09PSBmaWVsZElkKTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50RmllbGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZpZWxkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Rm9ybVRhYkNvbnRhaW5lcnMoZm9ybTogRm9ybU1vZGVsKTogQ29udGFpbmVyTW9kZWxbXSB7XG4gICAgICAgIGlmICghIWZvcm0pIHtcbiAgICAgICAgICAgIHJldHVybiA8Q29udGFpbmVyTW9kZWxbXT4gZm9ybS5maWVsZHMuZmlsdGVyKGZpZWxkID0+IGZpZWxkLnR5cGUgPT09ICdjb250YWluZXInICYmIGZpZWxkLnRhYik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0T2JqZWN0VmFsdWUoZmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgdmFsdWUgPSAnJztcbiAgICAgICAgaWYgKGZpZWxkLnZhbHVlICYmIGZpZWxkLnZhbHVlLm5hbWUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gZmllbGQudmFsdWUubmFtZTtcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5vcHRpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBmaWVsZC5vcHRpb25zLmZpbmQoKG9wdCkgPT4gb3B0LmlkID09PSBmaWVsZC52YWx1ZSk7XG4gICAgICAgICAgICBpZiAob3B0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlRnJvbU9wdGlvbihmaWVsZElkLCBvcHRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFZhbHVlRnJvbU9wdGlvbihmaWVsZElkOiBzdHJpbmcsIG9wdGlvbik6IHN0cmluZyB7XG4gICAgICAgIGxldCBvcHRpb25WYWx1ZSA9ICcnO1xuICAgICAgICBpZiAoZmllbGRJZCAmJiBmaWVsZElkLmluZGV4T2YoJ19MQUJFTCcpID4gMCkge1xuICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBvcHRpb24ubmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9wdGlvblZhbHVlID0gb3B0aW9uLmlkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvcHRpb25WYWx1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzU2VhcmNoZWRGaWVsZChmaWVsZDogRm9ybUZpZWxkTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBmaWVsZFRvRmluZCA9IGZpZWxkSWQ/LmluZGV4T2YoJ19MQUJFTCcpID4gMCA/IGZpZWxkSWQucmVwbGFjZSgnX0xBQkVMJywgJycpIDogZmllbGRJZDtcbiAgICAgICAgcmV0dXJuIChmaWVsZC5pZCAmJiBmaWVsZFRvRmluZCkgPyBmaWVsZC5pZC50b1VwcGVyQ2FzZSgpID09PSBmaWVsZFRvRmluZC50b1VwcGVyQ2FzZSgpIDogZmFsc2U7XG4gICAgfVxuXG4gICAgZ2V0VmFyaWFibGVWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIG5hbWU6IHN0cmluZywgcHJvY2Vzc1Zhckxpc3Q6IFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcHJvY2Vzc1ZhcmlhYmxlVmFsdWUgPSB0aGlzLmdldFByb2Nlc3NWYXJpYWJsZVZhbHVlKG5hbWUsIHByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgY29uc3QgdmFyaWFibGVEZWZhdWx0VmFsdWUgPSBmb3JtLmdldEZvcm1WYXJpYWJsZVZhbHVlKG5hbWUpO1xuXG4gICAgICAgIHJldHVybiAocHJvY2Vzc1ZhcmlhYmxlVmFsdWUgPT09IHVuZGVmaW5lZCkgPyB2YXJpYWJsZURlZmF1bHRWYWx1ZSA6IHByb2Nlc3NWYXJpYWJsZVZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UHJvY2Vzc1ZhcmlhYmxlVmFsdWUobmFtZTogc3RyaW5nLCBwcm9jZXNzVmFyTGlzdDogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pOiBzdHJpbmcge1xuICAgICAgICBpZiAocHJvY2Vzc1Zhckxpc3QpIHtcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NWYXJpYWJsZSA9IHByb2Nlc3NWYXJMaXN0LmZpbmQoXG4gICAgICAgICAgICAgICAgdmFyaWFibGUgPT5cbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUuaWQgPT09IG5hbWUgfHxcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUuaWQgPT09IGB2YXJpYWJsZXMuJHtuYW1lfWBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzVmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc1ZhcmlhYmxlLnZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgZXZhbHVhdGVMb2dpY2FsT3BlcmF0aW9uKGxvZ2ljT3A6IHN0cmluZywgcHJldmlvdXNWYWx1ZTogYW55LCBuZXdWYWx1ZTogYW55KTogYm9vbGVhbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHN3aXRjaCAobG9naWNPcCkge1xuICAgICAgICAgICAgY2FzZSAnYW5kJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSAmJiBuZXdWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ29yJyA6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWUgfHwgbmV3VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdhbmQtbm90JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSAmJiAhbmV3VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdvci1ub3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlIHx8ICFuZXdWYWx1ZTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGBJbnZhbGlkIG9wZXJhdG9yOiAke2xvZ2ljT3B9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGV2YWx1YXRlQ29uZGl0aW9uKGxlZnRWYWx1ZTogYW55LCByaWdodFZhbHVlOiBhbnksIG9wZXJhdG9yOiBzdHJpbmcpOiBib29sZWFuIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgc3dpdGNoIChvcGVyYXRvcikge1xuICAgICAgICAgICAgY2FzZSAnPT0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgKyAnJyA9PT0gcmlnaHRWYWx1ZSArICcnO1xuICAgICAgICAgICAgY2FzZSAnPCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA8IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICchPSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSArICcnICE9PSByaWdodFZhbHVlICsgJyc7XG4gICAgICAgICAgICBjYXNlICc+JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID4gcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJz49JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID49IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICc8PSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA8PSByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnZW1wdHknOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPyBsZWZ0VmFsdWUgPT09ICcnIDogdHJ1ZTtcbiAgICAgICAgICAgIGNhc2UgJyFlbXB0eSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA/IGxlZnRWYWx1ZSAhPT0gJycgOiBmYWxzZTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGBJbnZhbGlkIG9wZXJhdG9yOiAke29wZXJhdG9yfWApO1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbGVhblByb2Nlc3NWYXJpYWJsZSgpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzVmFyTGlzdCA9IFtdO1xuICAgIH1cblxuICAgIGdldFRhc2tQcm9jZXNzVmFyaWFibGUodGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tGb3Jtc0FwaS5nZXRUYXNrRm9ybVZhcmlhYmxlcyh0YXNrSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QganNvblJlcyA9IHRoaXMudG9Kc29uKHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1Zhckxpc3QgPSA8VGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10+IGpzb25SZXM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uUmVzO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gdGhpcy5oYW5kbGVFcnJvcigpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICB0b0pzb24ocmVzOiBhbnkpOiBhbnkge1xuICAgICAgICByZXR1cm4gcmVzIHx8IHt9O1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNWYWxpZE9wZXJhdG9yKG9wZXJhdG9yOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIG9wZXJhdG9yICE9PSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1ZhbGlkQ29uZGl0aW9uKGNvbmRpdGlvbjogV2lkZ2V0VmlzaWJpbGl0eU1vZGVsKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIShjb25kaXRpb24gJiYgY29uZGl0aW9uLm9wZXJhdG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKCkge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoJ0Vycm9yIHdoaWxlIHBlcmZvcm1pbmcgYSBjYWxsJyk7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdFcnJvciB3aGlsZSBwZXJmb3JtaW5nIGEgY2FsbCAtIFNlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==
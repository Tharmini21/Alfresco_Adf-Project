import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Injectable } from '@angular/core';
import { Observable, Subject, from, of, throwError } from 'rxjs';
import { FormDefinitionModel } from '../models/form-definition.model';
import { FormModel, FormOutcomeModel } from './../components/widgets/core/index';
import { EcmModelService } from './ecm-model.service';
import { map, catchError, switchMap, combineAll, defaultIfEmpty } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "./ecm-model.service";
import * as i2 from "../../services/alfresco-api.service";
import * as i3 from "../../services/log.service";
export class FormService {
    constructor(ecmModelService, apiService, logService) {
        this.ecmModelService = ecmModelService;
        this.apiService = apiService;
        this.logService = logService;
        this.formLoaded = new Subject();
        this.formDataRefreshed = new Subject();
        this.formFieldValueChanged = new Subject();
        this.formEvents = new Subject();
        this.taskCompleted = new Subject();
        this.taskCompletedError = new Subject();
        this.taskSaved = new Subject();
        this.taskSavedError = new Subject();
        this.formContentClicked = new Subject();
        this.validateForm = new Subject();
        this.validateFormField = new Subject();
        this.validateDynamicTableRow = new Subject();
        this.executeOutcome = new Subject();
        this.updateFormValuesRequested = new Subject();
    }
    get taskApi() {
        return this.apiService.getInstance().activiti.taskApi;
    }
    get modelsApi() {
        return this.apiService.getInstance().activiti.modelsApi;
    }
    get editorApi() {
        return this.apiService.getInstance().activiti.editorApi;
    }
    get processApi() {
        return this.apiService.getInstance().activiti.processApi;
    }
    get processInstanceVariablesApi() {
        return this.apiService.getInstance().activiti.processInstanceVariablesApi;
    }
    get usersWorkflowApi() {
        return this.apiService.getInstance().activiti.usersWorkflowApi;
    }
    get groupsApi() {
        return this.apiService.getInstance().activiti.groupsApi;
    }
    parseForm(json, data, readOnly = false, fixedSpace) {
        if (json) {
            const form = new FormModel(json, data, readOnly, this, fixedSpace);
            if (!json.fields) {
                form.outcomes = [
                    new FormOutcomeModel(form, {
                        id: '$save',
                        name: FormOutcomeModel.SAVE_ACTION,
                        isSystem: true
                    })
                ];
            }
            return form;
        }
        return null;
    }
    createFormFromANode(formName) {
        return new Observable((observer) => {
            this.createForm(formName).subscribe((form) => {
                this.ecmModelService.searchEcmType(formName, EcmModelService.MODEL_NAME).subscribe((customType) => {
                    const formDefinitionModel = new FormDefinitionModel(form.id, form.name, form.lastUpdatedByFullName, form.lastUpdated, customType.entry.properties);
                    from(this.editorApi.saveForm(form.id, formDefinitionModel)).subscribe((formData) => {
                        observer.next(formData);
                        observer.complete();
                    }, (err) => this.handleError(err));
                }, (err) => this.handleError(err));
            }, (err) => this.handleError(err));
        });
    }
    createForm(formName) {
        const dataModel = {
            name: formName,
            description: '',
            modelType: 2,
            stencilSet: 0
        };
        return from(this.modelsApi.createModel(dataModel));
    }
    saveForm(formId, formModel) {
        return from(this.editorApi.saveForm(formId, formModel));
    }
    searchFrom(name) {
        const opts = {
            'modelType': 2
        };
        return from(this.modelsApi.getModels(opts))
            .pipe(map(function (forms) {
            return forms.data.find((formData) => formData.name === name);
        }), catchError((err) => this.handleError(err)));
    }
    getForms() {
        const opts = {
            'modelType': 2
        };
        return from(this.modelsApi.getModels(opts))
            .pipe(map(this.toJsonArray), catchError((err) => this.handleError(err)));
    }
    getProcessDefinitions() {
        return from(this.processApi.getProcessDefinitions({}))
            .pipe(map(this.toJsonArray), catchError((err) => this.handleError(err)));
    }
    getProcessVariablesById(processInstanceId) {
        return from(this.processInstanceVariablesApi.getProcessInstanceVariables(processInstanceId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getTasks() {
        return from(this.taskApi.listTasks({}))
            .pipe(map(this.toJsonArray), catchError((err) => this.handleError(err)));
    }
    getTask(taskId) {
        return from(this.taskApi.getTask(taskId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    saveTaskForm(taskId, formValues) {
        const saveFormRepresentation = { values: formValues };
        return from(this.taskApi.saveTaskForm(taskId, saveFormRepresentation))
            .pipe(catchError((err) => this.handleError(err)));
    }
    completeTaskForm(taskId, formValues, outcome) {
        const completeFormRepresentation = { values: formValues };
        if (outcome) {
            completeFormRepresentation.outcome = outcome;
        }
        return from(this.taskApi.completeTaskForm(taskId, completeFormRepresentation))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getTaskForm(taskId) {
        return from(this.taskApi.getTaskForm(taskId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getFormDefinitionById(formId) {
        return from(this.editorApi.getForm(formId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getFormDefinitionByName(name) {
        const opts = {
            'filter': 'myReusableForms',
            'filterText': name,
            'modelType': 2
        };
        return from(this.modelsApi.getModels(opts))
            .pipe(map(this.getFormId), catchError((err) => this.handleError(err)));
    }
    getStartFormInstance(processId) {
        return from(this.processApi.getProcessInstanceStartForm(processId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getProcessInstance(processId) {
        return from(this.processApi.getProcessInstance(processId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getStartFormDefinition(processId) {
        return from(this.processApi.getProcessDefinitionStartForm(processId))
            .pipe(map(this.toJson), catchError((err) => this.handleError(err)));
    }
    getRestFieldValues(taskId, field) {
        return from(this.taskApi.getRestFieldValues(taskId, field))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getRestFieldValuesByProcessId(processDefinitionId, field) {
        return from(this.processApi.getRestFieldValues(processDefinitionId, field))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getRestFieldValuesColumnByProcessId(processDefinitionId, field, column) {
        return from(this.processApi.getRestTableFieldValues(processDefinitionId, field, column))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getRestFieldValuesColumn(taskId, field, column) {
        return from(this.taskApi.getRestFieldValuesColumn(taskId, field, column))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getUserProfileImageApi(userId) {
        return this.apiService.getInstance().activiti.userApi.getUserProfilePictureUrl(userId);
    }
    getWorkflowUsers(filter, groupId) {
        const option = { filter: filter };
        if (groupId) {
            option.groupId = groupId;
        }
        return from(this.usersWorkflowApi.getUsers(option))
            .pipe(switchMap(response => response.data || []), map((user) => {
            user.userImage = this.getUserProfileImageApi(user.id.toString());
            return of(user);
        }), combineAll(), defaultIfEmpty([]), catchError((err) => this.handleError(err)));
    }
    getWorkflowGroups(filter, groupId) {
        const option = { filter: filter };
        if (groupId) {
            option.groupId = groupId;
        }
        return from(this.groupsApi.getGroups(option))
            .pipe(map((response) => response.data || []), catchError((err) => this.handleError(err)));
    }
    getFormId(form) {
        let result = null;
        if (form && form.data && form.data.length > 0) {
            result = form.data[0].id;
        }
        return result;
    }
    toJson(res) {
        if (res) {
            return res || {};
        }
        return {};
    }
    toJsonArray(res) {
        if (res) {
            return res.data || [];
        }
        return [];
    }
    handleError(error) {
        let errMsg = FormService.UNKNOWN_ERROR_MESSAGE;
        if (error) {
            errMsg = (error.message) ? error.message :
                error.status ? `${error.status} - ${error.statusText}` : FormService.GENERIC_ERROR_MESSAGE;
        }
        this.logService.error(errMsg);
        return throwError(errMsg);
    }
}
FormService.UNKNOWN_ERROR_MESSAGE = 'Unknown error';
FormService.GENERIC_ERROR_MESSAGE = 'Server error';
FormService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FormService_Factory() { return new FormService(i0.ɵɵinject(i1.EcmModelService), i0.ɵɵinject(i2.AlfrescoApiService), i0.ɵɵinject(i3.LogService)); }, token: FormService, providedIn: "root" });
FormService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
FormService.ctorParameters = () => [
    { type: EcmModelService },
    { type: AlfrescoApiService },
    { type: LogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vc2VydmljZXMvZm9ybS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUd0RSxPQUFPLEVBQUUsU0FBUyxFQUFvQixnQkFBZ0IsRUFBYyxNQUFNLG9DQUFvQyxDQUFDO0FBSy9HLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQVV4RixNQUFNLE9BQU8sV0FBVztJQXVCcEIsWUFBb0IsZUFBZ0MsRUFDaEMsVUFBOEIsRUFDNUIsVUFBc0I7UUFGeEIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFwQjVDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBYSxDQUFDO1FBQ3RDLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFhLENBQUM7UUFDN0MsMEJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQWtCLENBQUM7UUFDdEQsZUFBVSxHQUFHLElB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QU8sQ0FBQyxDQUFDO2dCQUN0QyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLE1BQU0sS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUM7U0FDbEc7UUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QixPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixDQUFDOztBQS9lTSxpQ0FBcUIsR0FBVyxlQUFlLENBQUM7QUFDaEQsaUNBQXFCLEdBQVcsY0FBYyxDQUFDOzs7WUFOekQsVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFWUSxlQUFlO1lBYmYsa0JBQWtCO1lBQ2xCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXNlclByb2Nlc3NNb2RlbCB9IGZyb20gJy4uLy4uL21vZGVscyc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBmcm9tLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRm9ybURlZmluaXRpb25Nb2RlbCB9IGZyb20gJy4uL21vZGVscy9mb3JtLWRlZmluaXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgQ29udGVudExpbmtNb2RlbCB9IGZyb20gJy4vLi4vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvY29udGVudC1saW5rLm1vZGVsJztcbmltcG9ydCB7IEdyb3VwTW9kZWwgfSBmcm9tICcuLy4uL2NvbXBvbmVudHMvd2lkZ2V0cy9jb3JlL2dyb3VwLm1vZGVsJztcbmltcG9ydCB7IEZvcm1Nb2RlbCwgRm9ybU91dGNvbWVFdmVudCwgRm9ybU91dGNvbWVNb2RlbCwgRm9ybVZhbHVlcyB9IGZyb20gJy4vLi4vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHtcbiAgICBGb3JtRXJyb3JFdmVudCwgRm9ybUV2ZW50LCBGb3JtRmllbGRFdmVudCxcbiAgICBWYWxpZGF0ZUR5bmFtaWNUYWJsZVJvd0V2ZW50LCBWYWxpZGF0ZUZvcm1FdmVudCwgVmFsaWRhdGVGb3JtRmllbGRFdmVudFxufSBmcm9tICcuLy4uL2V2ZW50cy9pbmRleCc7XG5pbXBvcnQgeyBFY21Nb2RlbFNlcnZpY2UgfSBmcm9tICcuL2VjbS1tb2RlbC5zZXJ2aWNlJztcbmltcG9ydCB7IG1hcCwgY2F0Y2hFcnJvciwgc3dpdGNoTWFwLCBjb21iaW5lQWxsLCBkZWZhdWx0SWZFbXB0eSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gICAgQWN0aXZpdGksXG4gICAgQ29tcGxldGVGb3JtUmVwcmVzZW50YXRpb24sXG4gICAgU2F2ZUZvcm1SZXByZXNlbnRhdGlvblxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBGb3JtU2VydmljZSB7XG5cbiAgICBzdGF0aWMgVU5LTk9XTl9FUlJPUl9NRVNTQUdFOiBzdHJpbmcgPSAnVW5rbm93biBlcnJvcic7XG4gICAgc3RhdGljIEdFTkVSSUNfRVJST1JfTUVTU0FHRTogc3RyaW5nID0gJ1NlcnZlciBlcnJvcic7XG5cbiAgICBmb3JtTG9hZGVkID0gbmV3IFN1YmplY3Q8Rm9ybUV2ZW50PigpO1xuICAgIGZvcm1EYXRhUmVmcmVzaGVkID0gbmV3IFN1YmplY3Q8Rm9ybUV2ZW50PigpO1xuICAgIGZvcm1GaWVsZFZhbHVlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PEZvcm1GaWVsZEV2ZW50PigpO1xuICAgIGZvcm1FdmVudHMgPSBuZXcgU3ViamVjdDxFdmVudD4oKTtcbiAgICB0YXNrQ29tcGxldGVkID0gbmV3IFN1YmplY3Q8Rm9ybUV2ZW50PigpO1xuICAgIHRhc2tDb21wbGV0ZWRFcnJvciA9IG5ldyBTdWJqZWN0PEZvcm1FcnJvckV2ZW50PigpO1xuICAgIHRhc2tTYXZlZCA9IG5ldyBTdWJqZWN0PEZvcm1FdmVudD4oKTtcbiAgICB0YXNrU2F2ZWRFcnJvciA9IG5ldyBTdWJqZWN0PEZvcm1FcnJvckV2ZW50PigpO1xuICAgIGZvcm1Db250ZW50Q2xpY2tlZCA9IG5ldyBTdWJqZWN0PENvbnRlbnRMaW5rTW9kZWw+KCk7XG5cbiAgICB2YWxpZGF0ZUZvcm0gPSBuZXcgU3ViamVjdDxWYWxpZGF0ZUZvcm1FdmVudD4oKTtcbiAgICB2YWxpZGF0ZUZvcm1GaWVsZCA9IG5ldyBTdWJqZWN0PFZhbGlkYXRlRm9ybUZpZWxkRXZlbnQ+KCk7XG4gICAgdmFsaWRhdGVEeW5hbWljVGFibGVSb3cgPSBuZXcgU3ViamVjdDxWYWxpZGF0ZUR5bmFtaWNUYWJsZVJvd0V2ZW50PigpO1xuXG4gICAgZXhlY3V0ZU91dGNvbWUgPSBuZXcgU3ViamVjdDxGb3JtT3V0Y29tZUV2ZW50PigpO1xuXG4gICAgdXBkYXRlRm9ybVZhbHVlc1JlcXVlc3RlZCA9IG5ldyBTdWJqZWN0PEZvcm1WYWx1ZXM+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVjbU1vZGVsU2VydmljZTogRWNtTW9kZWxTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgdGFza0FwaSgpOiBBY3Rpdml0aS5UYXNrQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgbW9kZWxzQXBpKCk6IEFjdGl2aXRpLk1vZGVsc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5tb2RlbHNBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgZWRpdG9yQXBpKCk6IEFjdGl2aXRpLkVkaXRvckFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5lZGl0b3JBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgcHJvY2Vzc0FwaSgpOiBBY3Rpdml0aS5Qcm9jZXNzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnByb2Nlc3NBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgcHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpKCk6IEFjdGl2aXRpLlByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5wcm9jZXNzSW5zdGFuY2VWYXJpYWJsZXNBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgdXNlcnNXb3JrZmxvd0FwaSgpOiBBY3Rpdml0aS5Vc2Vyc1dvcmtmbG93QXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnVzZXJzV29ya2Zsb3dBcGk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgZ3JvdXBzQXBpKCk6IEFjdGl2aXRpLkdyb3Vwc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS5ncm91cHNBcGk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2VzIEpTT04gZGF0YSB0byBjcmVhdGUgYSBjb3JyZXNwb25kaW5nIEZvcm0gbW9kZWwuXG4gICAgICogQHBhcmFtIGpzb24gSlNPTiB0byBjcmVhdGUgdGhlIGZvcm1cbiAgICAgKiBAcGFyYW0gZGF0YSBWYWx1ZXMgZm9yIHRoZSBmb3JtIGZpZWxkc1xuICAgICAqIEBwYXJhbSByZWFkT25seSBTaG91bGQgdGhlIGZvcm0gZmllbGRzIGJlIHJlYWQtb25seT9cbiAgICAgKiBAcmV0dXJucyBGb3JtIG1vZGVsIGNyZWF0ZWQgZnJvbSBpbnB1dCBkYXRhXG4gICAgICovXG4gICAgcGFyc2VGb3JtKGpzb246IGFueSwgZGF0YT86IEZvcm1WYWx1ZXMsIHJlYWRPbmx5OiBib29sZWFuID0gZmFsc2UsIGZpeGVkU3BhY2U/OiBib29sZWFuKTogRm9ybU1vZGVsIHtcbiAgICAgICAgaWYgKGpzb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGZvcm0gPSBuZXcgRm9ybU1vZGVsKGpzb24sIGRhdGEsIHJlYWRPbmx5LCB0aGlzLCBmaXhlZFNwYWNlKTtcbiAgICAgICAgICAgIGlmICghanNvbi5maWVsZHMpIHtcbiAgICAgICAgICAgICAgICBmb3JtLm91dGNvbWVzID0gW1xuICAgICAgICAgICAgICAgICAgICBuZXcgRm9ybU91dGNvbWVNb2RlbCg8YW55PiBmb3JtLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogJyRzYXZlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IEZvcm1PdXRjb21lTW9kZWwuU0FWRV9BQ1RJT04sXG4gICAgICAgICAgICAgICAgICAgICAgICBpc1N5c3RlbTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZm9ybTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgRm9ybSB3aXRoIGEgZmllbGQgZm9yIGVhY2ggbWV0YWRhdGEgcHJvcGVydHkuXG4gICAgICogQHBhcmFtIGZvcm1OYW1lIE5hbWUgb2YgdGhlIG5ldyBmb3JtXG4gICAgICogQHJldHVybnMgVGhlIG5ldyBmb3JtXG4gICAgICovXG4gICAgY3JlYXRlRm9ybUZyb21BTm9kZShmb3JtTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtKGZvcm1OYW1lKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGZvcm0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lY21Nb2RlbFNlcnZpY2Uuc2VhcmNoRWNtVHlwZShmb3JtTmFtZSwgRWNtTW9kZWxTZXJ2aWNlLk1PREVMX05BTUUpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgIChjdXN0b21UeXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9ybURlZmluaXRpb25Nb2RlbCA9IG5ldyBGb3JtRGVmaW5pdGlvbk1vZGVsKGZvcm0uaWQsIGZvcm0ubmFtZSwgZm9ybS5sYXN0VXBkYXRlZEJ5RnVsbE5hbWUsIGZvcm0ubGFzdFVwZGF0ZWQsIGN1c3RvbVR5cGUuZW50cnkucHJvcGVydGllcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3JBcGkuc2F2ZUZvcm0oZm9ybS5pZCwgZm9ybURlZmluaXRpb25Nb2RlbClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnN1YnNjcmliZSgoZm9ybURhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChmb3JtRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgRm9ybS5cbiAgICAgKiBAcGFyYW0gZm9ybU5hbWUgTmFtZSBvZiB0aGUgbmV3IGZvcm1cbiAgICAgKiBAcmV0dXJucyBUaGUgbmV3IGZvcm1cbiAgICAgKi9cbiAgICBjcmVhdGVGb3JtKGZvcm1OYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCBkYXRhTW9kZWwgPSB7XG4gICAgICAgICAgICBuYW1lOiBmb3JtTmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICAgIG1vZGVsVHlwZTogMixcbiAgICAgICAgICAgIHN0ZW5jaWxTZXQ6IDBcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMubW9kZWxzQXBpLmNyZWF0ZU1vZGVsKGRhdGFNb2RlbClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTYXZlcyBhIGZvcm0uXG4gICAgICogQHBhcmFtIGZvcm1JZCBJRCBvZiB0aGUgZm9ybSB0byBzYXZlXG4gICAgICogQHBhcmFtIGZvcm1Nb2RlbCBNb2RlbCBkYXRhIGZvciB0aGUgZm9ybVxuICAgICAqIEByZXR1cm5zIERhdGEgZm9yIHRoZSBzYXZlZCBmb3JtXG4gICAgICovXG4gICAgc2F2ZUZvcm0oZm9ybUlkOiBudW1iZXIsIGZvcm1Nb2RlbDogRm9ybURlZmluaXRpb25Nb2RlbCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5lZGl0b3JBcGkuc2F2ZUZvcm0oZm9ybUlkLCBmb3JtTW9kZWwpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VhcmNoZXMgZm9yIGEgZm9ybSBieSBuYW1lLlxuICAgICAqIEBwYXJhbSBuYW1lIFRoZSBmb3JtIG5hbWUgdG8gc2VhcmNoIGZvclxuICAgICAqIEByZXR1cm5zIEZvcm0gbW9kZWwocykgbWF0Y2hpbmcgdGhlIHNlYXJjaCBuYW1lXG4gICAgICovXG4gICAgc2VhcmNoRnJvbShuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICAgICAgJ21vZGVsVHlwZSc6IDJcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKVxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoZnVuY3Rpb24gKGZvcm1zOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcm1zLmRhdGEuZmluZCgoZm9ybURhdGEpID0+IGZvcm1EYXRhLm5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0aGUgZm9ybXMuXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBmb3JtIG1vZGVsc1xuICAgICAqL1xuICAgIGdldEZvcm1zKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgICAgICAnbW9kZWxUeXBlJzogMlxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLnRvSnNvbkFycmF5KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwcm9jZXNzIGRlZmluaXRpb25zLlxuICAgICAqIEByZXR1cm5zIExpc3Qgb2YgcHJvY2VzcyBkZWZpbml0aW9uc1xuICAgICAqL1xuICAgIGdldFByb2Nlc3NEZWZpbml0aW9ucygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnByb2Nlc3NBcGkuZ2V0UHJvY2Vzc0RlZmluaXRpb25zKHt9KSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLnRvSnNvbkFycmF5KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBpbnN0YW5jZSB2YXJpYWJsZXMgZm9yIGEgcHJvY2Vzcy5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0luc3RhbmNlSWQgSUQgb2YgdGhlIHRhcmdldCBwcm9jZXNzXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBpbnN0YW5jZSB2YXJpYWJsZSBpbmZvcm1hdGlvblxuICAgICAqL1xuICAgIGdldFByb2Nlc3NWYXJpYWJsZXNCeUlkKHByb2Nlc3NJbnN0YW5jZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMucHJvY2Vzc0luc3RhbmNlVmFyaWFibGVzQXBpLmdldFByb2Nlc3NJbnN0YW5jZVZhcmlhYmxlcyhwcm9jZXNzSW5zdGFuY2VJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAodGhpcy50b0pzb24pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGFsbCB0aGUgdGFza3MuXG4gICAgICogQHJldHVybnMgTGlzdCBvZiB0YXNrc1xuICAgICAqL1xuICAgIGdldFRhc2tzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza0FwaS5saXN0VGFza3Moe30pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMudG9Kc29uQXJyYXkpLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgdGFzay5cbiAgICAgKiBAcGFyYW0gdGFza0lkIFRhc2sgSWRcbiAgICAgKiBAcmV0dXJucyBUYXNrIGluZm9cbiAgICAgKi9cbiAgICBnZXRUYXNrKHRhc2tJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrQXBpLmdldFRhc2sodGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLnRvSnNvbiksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhdmVzIGEgdGFzayBmb3JtLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGFzayBJZFxuICAgICAqIEBwYXJhbSBmb3JtVmFsdWVzIEZvcm0gVmFsdWVzXG4gICAgICogQHJldHVybnMgTnVsbCByZXNwb25zZSB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBzYXZlVGFza0Zvcm0odGFza0lkOiBzdHJpbmcsIGZvcm1WYWx1ZXM6IEZvcm1WYWx1ZXMpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCBzYXZlRm9ybVJlcHJlc2VudGF0aW9uID0gPFNhdmVGb3JtUmVwcmVzZW50YXRpb24+IHsgdmFsdWVzOiBmb3JtVmFsdWVzIH07XG5cbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy50YXNrQXBpLnNhdmVUYXNrRm9ybSh0YXNrSWQsIHNhdmVGb3JtUmVwcmVzZW50YXRpb24pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbXBsZXRlcyBhIFRhc2sgRm9ybS5cbiAgICAgKiBAcGFyYW0gdGFza0lkIFRhc2sgSWRcbiAgICAgKiBAcGFyYW0gZm9ybVZhbHVlcyBGb3JtIFZhbHVlc1xuICAgICAqIEBwYXJhbSBvdXRjb21lIEZvcm0gT3V0Y29tZVxuICAgICAqIEByZXR1cm5zIE51bGwgcmVzcG9uc2Ugd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgY29tcGxldGVUYXNrRm9ybSh0YXNrSWQ6IHN0cmluZywgZm9ybVZhbHVlczogRm9ybVZhbHVlcywgb3V0Y29tZT86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRlRm9ybVJlcHJlc2VudGF0aW9uOiBhbnkgPSA8Q29tcGxldGVGb3JtUmVwcmVzZW50YXRpb24+IHsgdmFsdWVzOiBmb3JtVmFsdWVzIH07XG4gICAgICAgIGlmIChvdXRjb21lKSB7XG4gICAgICAgICAgICBjb21wbGV0ZUZvcm1SZXByZXNlbnRhdGlvbi5vdXRjb21lID0gb3V0Y29tZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudGFza0FwaS5jb21wbGV0ZVRhc2tGb3JtKHRhc2tJZCwgY29tcGxldGVGb3JtUmVwcmVzZW50YXRpb24pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmb3JtIHJlbGF0ZWQgdG8gYSB0YXNrLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgSUQgb2YgdGhlIHRhcmdldCB0YXNrXG4gICAgICogQHJldHVybnMgRm9ybSBkZWZpbml0aW9uXG4gICAgICovXG4gICAgZ2V0VGFza0Zvcm0odGFza0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBcGkuZ2V0VGFza0Zvcm0odGFza0lkKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLnRvSnNvbiksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmb3JtIGRlZmluaXRpb24uXG4gICAgICogQHBhcmFtIGZvcm1JZCBJRCBvZiB0aGUgdGFyZ2V0IGZvcm1cbiAgICAgKiBAcmV0dXJucyBGb3JtIGRlZmluaXRpb25cbiAgICAgKi9cbiAgICBnZXRGb3JtRGVmaW5pdGlvbkJ5SWQoZm9ybUlkOiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmVkaXRvckFwaS5nZXRGb3JtKGZvcm1JZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAodGhpcy50b0pzb24pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBmb3JtIGRlZmluaXRpb24gd2l0aCBhIGdpdmVuIG5hbWUuXG4gICAgICogQHBhcmFtIG5hbWUgVGhlIGZvcm0gbmFtZVxuICAgICAqIEByZXR1cm5zIEZvcm0gZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGdldEZvcm1EZWZpbml0aW9uQnlOYW1lKG5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgICAgICAnZmlsdGVyJzogJ215UmV1c2FibGVGb3JtcycsXG4gICAgICAgICAgICAnZmlsdGVyVGV4dCc6IG5hbWUsXG4gICAgICAgICAgICAnbW9kZWxUeXBlJzogMlxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMubW9kZWxzQXBpLmdldE1vZGVscyhvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCh0aGlzLmdldEZvcm1JZCksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHN0YXJ0IGZvcm0gaW5zdGFuY2UgZm9yIGEgZ2l2ZW4gcHJvY2Vzcy5cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc0lkIFByb2Nlc3MgZGVmaW5pdGlvbiBJRFxuICAgICAqIEByZXR1cm5zIEZvcm0gZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGdldFN0YXJ0Rm9ybUluc3RhbmNlKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzQXBpLmdldFByb2Nlc3NJbnN0YW5jZVN0YXJ0Rm9ybShwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMudG9Kc29uKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIHByb2Nlc3MgaW5zdGFuY2UuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBJRCBvZiB0aGUgcHJvY2VzcyB0byBnZXRcbiAgICAgKiBAcmV0dXJucyBQcm9jZXNzIGluc3RhbmNlXG4gICAgICovXG4gICAgZ2V0UHJvY2Vzc0luc3RhbmNlKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzQXBpLmdldFByb2Nlc3NJbnN0YW5jZShwcm9jZXNzSWQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKHRoaXMudG9Kc29uKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgc3RhcnQgZm9ybSBkZWZpbml0aW9uIGZvciBhIGdpdmVuIHByb2Nlc3MuXG4gICAgICogQHBhcmFtIHByb2Nlc3NJZCBQcm9jZXNzIGRlZmluaXRpb24gSURcbiAgICAgKiBAcmV0dXJucyBGb3JtIGRlZmluaXRpb25cbiAgICAgKi9cbiAgICBnZXRTdGFydEZvcm1EZWZpbml0aW9uKHByb2Nlc3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzQXBpLmdldFByb2Nlc3NEZWZpbml0aW9uU3RhcnRGb3JtKHByb2Nlc3NJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAodGhpcy50b0pzb24pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHZhbHVlcyBvZiBmaWVsZHMgcG9wdWxhdGVkIGJ5IGEgUkVTVCBiYWNrZW5kLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGFzayBpZGVudGlmaWVyXG4gICAgICogQHBhcmFtIGZpZWxkIEZpZWxkIGlkZW50aWZpZXJcbiAgICAgKiBAcmV0dXJucyBGaWVsZCB2YWx1ZXNcbiAgICAgKi9cbiAgICBnZXRSZXN0RmllbGRWYWx1ZXModGFza0lkOiBzdHJpbmcsIGZpZWxkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBcGkuZ2V0UmVzdEZpZWxkVmFsdWVzKHRhc2tJZCwgZmllbGQpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdmFsdWVzIG9mIGZpZWxkcyBwb3B1bGF0ZWQgYnkgYSBSRVNUIGJhY2tlbmQgdXNpbmcgYSBwcm9jZXNzIElELlxuICAgICAqIEBwYXJhbSBwcm9jZXNzRGVmaW5pdGlvbklkIFByb2Nlc3MgaWRlbnRpZmllclxuICAgICAqIEBwYXJhbSBmaWVsZCBGaWVsZCBpZGVudGlmaWVyXG4gICAgICogQHJldHVybnMgRmllbGQgdmFsdWVzXG4gICAgICovXG4gICAgZ2V0UmVzdEZpZWxkVmFsdWVzQnlQcm9jZXNzSWQocHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nLCBmaWVsZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzQXBpLmdldFJlc3RGaWVsZFZhbHVlcyhwcm9jZXNzRGVmaW5pdGlvbklkLCBmaWVsZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBjb2x1bW4gdmFsdWVzIG9mIGZpZWxkcyBwb3B1bGF0ZWQgYnkgYSBSRVNUIGJhY2tlbmQgdXNpbmcgYSBwcm9jZXNzIElELlxuICAgICAqIEBwYXJhbSBwcm9jZXNzRGVmaW5pdGlvbklkIFByb2Nlc3MgaWRlbnRpZmllclxuICAgICAqIEBwYXJhbSBmaWVsZCBGaWVsZCBpZGVudGlmaWVyXG4gICAgICogQHBhcmFtIGNvbHVtbiBDb2x1bW4gaWRlbnRpZmllclxuICAgICAqIEByZXR1cm5zIEZpZWxkIHZhbHVlc1xuICAgICAqL1xuICAgIGdldFJlc3RGaWVsZFZhbHVlc0NvbHVtbkJ5UHJvY2Vzc0lkKHByb2Nlc3NEZWZpbml0aW9uSWQ6IHN0cmluZywgZmllbGQ6IHN0cmluZywgY29sdW1uPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5wcm9jZXNzQXBpLmdldFJlc3RUYWJsZUZpZWxkVmFsdWVzKHByb2Nlc3NEZWZpbml0aW9uSWQsIGZpZWxkLCBjb2x1bW4pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgY29sdW1uIHZhbHVlcyBvZiBmaWVsZHMgcG9wdWxhdGVkIGJ5IGEgUkVTVCBiYWNrZW5kLlxuICAgICAqIEBwYXJhbSB0YXNrSWQgVGFzayBpZGVudGlmaWVyXG4gICAgICogQHBhcmFtIGZpZWxkIEZpZWxkIGlkZW50aWZpZXJcbiAgICAgKiBAcGFyYW0gY29sdW1uIENvbHVtbiBpZGVudGlmaWVyXG4gICAgICogQHJldHVybnMgRmllbGQgdmFsdWVzXG4gICAgICovXG4gICAgZ2V0UmVzdEZpZWxkVmFsdWVzQ29sdW1uKHRhc2tJZDogc3RyaW5nLCBmaWVsZDogc3RyaW5nLCBjb2x1bW4/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnRhc2tBcGkuZ2V0UmVzdEZpZWxkVmFsdWVzQ29sdW1uKHRhc2tJZCwgZmllbGQsIGNvbHVtbikpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBhIFVSTCBmb3IgdGhlIHByb2ZpbGUgcGljdHVyZSBvZiBhIHVzZXIuXG4gICAgICogQHBhcmFtIHVzZXJJZCBJRCBvZiB0aGUgdGFyZ2V0IHVzZXJcbiAgICAgKiBAcmV0dXJucyBVUkwgc3RyaW5nXG4gICAgICovXG4gICAgZ2V0VXNlclByb2ZpbGVJbWFnZUFwaSh1c2VySWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5hY3Rpdml0aS51c2VyQXBpLmdldFVzZXJQcm9maWxlUGljdHVyZVVybCh1c2VySWQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBsaXN0IG9mIHdvcmtmbG93IHVzZXJzLlxuICAgICAqIEBwYXJhbSBmaWx0ZXIgRmlsdGVyIHRvIHNlbGVjdCBzcGVjaWZpYyB1c2Vyc1xuICAgICAqIEBwYXJhbSBncm91cElkIEdyb3VwIElEIGZvciB0aGUgc2VhcmNoXG4gICAgICogQHJldHVybnMgQXJyYXkgb2YgdXNlcnNcbiAgICAgKi9cbiAgICBnZXRXb3JrZmxvd1VzZXJzKGZpbHRlcjogc3RyaW5nLCBncm91cElkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxVc2VyUHJvY2Vzc01vZGVsW10+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9uOiBhbnkgPSB7IGZpbHRlcjogZmlsdGVyIH07XG4gICAgICAgIGlmIChncm91cElkKSB7XG4gICAgICAgICAgICBvcHRpb24uZ3JvdXBJZCA9IGdyb3VwSWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy51c2Vyc1dvcmtmbG93QXBpLmdldFVzZXJzKG9wdGlvbikpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzcG9uc2UgPT4gPFVzZXJQcm9jZXNzTW9kZWxbXT4gcmVzcG9uc2UuZGF0YSB8fCBbXSksXG4gICAgICAgICAgICAgICAgbWFwKCh1c2VyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXIudXNlckltYWdlID0gdGhpcy5nZXRVc2VyUHJvZmlsZUltYWdlQXBpKHVzZXIuaWQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih1c2VyKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjb21iaW5lQWxsKCksXG4gICAgICAgICAgICAgICAgZGVmYXVsdElmRW1wdHkoW10pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBncm91cHMgaW4gYSB3b3JrZmxvdy5cbiAgICAgKiBAcGFyYW0gZmlsdGVyIEZpbHRlciB0byBzZWxlY3Qgc3BlY2lmaWMgZ3JvdXBzXG4gICAgICogQHBhcmFtIGdyb3VwSWQgR3JvdXAgSUQgZm9yIHRoZSBzZWFyY2hcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBncm91cHNcbiAgICAgKi9cbiAgICBnZXRXb3JrZmxvd0dyb3VwcyhmaWx0ZXI6IHN0cmluZywgZ3JvdXBJZD86IHN0cmluZyk6IE9ic2VydmFibGU8R3JvdXBNb2RlbFtdPiB7XG4gICAgICAgIGNvbnN0IG9wdGlvbjogYW55ID0geyBmaWx0ZXI6IGZpbHRlciB9O1xuICAgICAgICBpZiAoZ3JvdXBJZCkge1xuICAgICAgICAgICAgb3B0aW9uLmdyb3VwSWQgPSBncm91cElkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuZ3JvdXBzQXBpLmdldEdyb3VwcyhvcHRpb24pKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChyZXNwb25zZTogYW55KSA9PiA8R3JvdXBNb2RlbFtdPiByZXNwb25zZS5kYXRhIHx8IFtdKSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgSUQgb2YgYSBmb3JtLlxuICAgICAqIEBwYXJhbSBmb3JtIE9iamVjdCByZXByZXNlbnRpbmcgYSBmb3JtXG4gICAgICogQHJldHVybnMgSUQgc3RyaW5nXG4gICAgICovXG4gICAgZ2V0Rm9ybUlkKGZvcm06IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGxldCByZXN1bHQgPSBudWxsO1xuXG4gICAgICAgIGlmIChmb3JtICYmIGZvcm0uZGF0YSAmJiBmb3JtLmRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmVzdWx0ID0gZm9ybS5kYXRhWzBdLmlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBmb3JtIGRhdGEuXG4gICAgICogQHBhcmFtIHJlcyBPYmplY3QgcmVwcmVzZW50aW5nIGZvcm0gZGF0YVxuICAgICAqIEByZXR1cm5zIEpTT04gZGF0YVxuICAgICAqL1xuICAgIHRvSnNvbihyZXM6IGFueSkge1xuICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzIHx8IHt9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgSlNPTiBhcnJheSByZXByZXNlbnRhdGlvbiBvZiBmb3JtIGRhdGEuXG4gICAgICogQHBhcmFtIHJlcyBPYmplY3QgcmVwcmVzZW50aW5nIGZvcm0gZGF0YVxuICAgICAqIEByZXR1cm5zIEpTT04gZGF0YVxuICAgICAqL1xuICAgIHRvSnNvbkFycmF5KHJlczogYW55KSB7XG4gICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YSB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwb3J0cyBhbiBlcnJvciBtZXNzYWdlLlxuICAgICAqIEBwYXJhbSBlcnJvciBEYXRhIG9iamVjdCB3aXRoIG9wdGlvbmFsIGBtZXNzYWdlYCBhbmQgYHN0YXR1c2AgZmllbGRzIGZvciB0aGUgZXJyb3JcbiAgICAgKiBAcmV0dXJucyBFcnJvciBtZXNzYWdlXG4gICAgICovXG4gICAgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBlcnJNc2cgPSBGb3JtU2VydmljZS5VTktOT1dOX0VSUk9SX01FU1NBR0U7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgZXJyTXNnID0gKGVycm9yLm1lc3NhZ2UpID8gZXJyb3IubWVzc2FnZSA6XG4gICAgICAgICAgICAgICAgZXJyb3Iuc3RhdHVzID8gYCR7ZXJyb3Iuc3RhdHVzfSAtICR7ZXJyb3Iuc3RhdHVzVGV4dH1gIDogRm9ybVNlcnZpY2UuR0VORVJJQ19FUlJPUl9NRVNTQUdFO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJNc2cpO1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJNc2cpO1xuICAgIH1cbn1cbiJdfQ==
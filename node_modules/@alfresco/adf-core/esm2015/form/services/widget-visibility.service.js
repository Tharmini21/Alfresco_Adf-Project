import { AlfrescoApiService } from '../../services/alfresco-api.service';
import { LogService } from '../../services/log.service';
import { Injectable } from '@angular/core';
import moment from 'moment-es6';
import { from, throwError } from 'rxjs';
import { WidgetTypeEnum } from '../models/widget-visibility.model';
import { map, catchError } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../services/alfresco-api.service";
import * as i2 from "../../services/log.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../services/alfresco-api.service';
import * as ɵngcc2 from '../../services/log.service';
export class WidgetVisibilityService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
    }
    refreshVisibility(form, processVarList) {
        this.form = form;
        if (processVarList) {
            this.processVarList = processVarList;
        }
        if (form && form.tabs && form.tabs.length > 0) {
            form.tabs.map((tabModel) => this.refreshEntityVisibility(tabModel));
        }
        if (form && form.outcomes && form.outcomes.length > 0) {
            form.outcomes.map((outcomeModel) => this.refreshOutcomeVisibility(outcomeModel));
        }
        if (form) {
            form.getFormFields().map((field) => this.refreshEntityVisibility(field));
        }
    }
    refreshEntityVisibility(element) {
        const visible = this.evaluateVisibility(element.form, element.visibilityCondition);
        element.isVisible = visible && this.isParentTabVisible(this.form, element);
    }
    refreshOutcomeVisibility(element) {
        element.isVisible = this.evaluateVisibility(element.form, element.visibilityCondition);
    }
    evaluateVisibility(form, visibilityObj) {
        const isLeftFieldPresent = visibilityObj && (visibilityObj.leftType || visibilityObj.leftValue);
        if (!isLeftFieldPresent || isLeftFieldPresent === 'null') {
            return true;
        }
        else {
            return this.isFieldVisible(form, visibilityObj);
        }
    }
    isFieldVisible(form, visibilityObj, accumulator = [], result = false) {
        const leftValue = this.getLeftValue(form, visibilityObj);
        const rightValue = this.getRightValue(form, visibilityObj);
        const actualResult = this.evaluateCondition(leftValue, rightValue, visibilityObj.operator);
        if (this.isValidOperator(visibilityObj.nextConditionOperator)) {
            accumulator.push({ value: actualResult, operator: visibilityObj.nextConditionOperator });
        }
        if (this.isValidCondition(visibilityObj.nextCondition)) {
            result = this.isFieldVisible(form, visibilityObj.nextCondition, accumulator);
        }
        else if (accumulator[0] !== undefined) {
            result = accumulator[0].value;
            for (let i = 1; i < accumulator.length; i++) {
                if (accumulator[i] !== undefined) {
                    result = this.evaluateLogicalOperation(accumulator[i - 1].operator, result, accumulator[i].value);
                }
            }
        }
        else {
            result = actualResult;
        }
        return !!result;
    }
    getLeftValue(form, visibilityObj) {
        let leftValue = '';
        if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.variable) {
            leftValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
        }
        else if (visibilityObj.leftType && visibilityObj.leftType === WidgetTypeEnum.field) {
            leftValue = this.getFormValue(form, visibilityObj.leftValue);
            if (leftValue === undefined || leftValue === '') {
                const variableValue = this.getVariableValue(form, visibilityObj.leftValue, this.processVarList);
                leftValue = !this.isInvalidValue(variableValue) ? variableValue : leftValue;
            }
        }
        return leftValue;
    }
    getRightValue(form, visibilityObj) {
        let valueFound = '';
        if (visibilityObj.rightType === WidgetTypeEnum.variable) {
            valueFound = this.getVariableValue(form, visibilityObj.rightValue, this.processVarList);
        }
        else if (visibilityObj.rightType === WidgetTypeEnum.field) {
            valueFound = this.getFormValue(form, visibilityObj.rightValue);
        }
        else {
            if (moment(visibilityObj.rightValue, 'YYYY-MM-DD', true).isValid()) {
                valueFound = visibilityObj.rightValue + 'T00:00:00.000Z';
            }
            else {
                valueFound = visibilityObj.rightValue;
            }
        }
        return valueFound;
    }
    getFormValue(form, fieldId) {
        const formField = this.getFormFieldById(form, fieldId);
        let value = undefined;
        if (this.isFormFieldValid(formField)) {
            value = this.getFieldValue(form.values, fieldId);
            if (this.isInvalidValue(value)) {
                value = this.searchValueInForm(formField, fieldId);
            }
        }
        return value;
    }
    isFormFieldValid(formField) {
        return formField && formField.isValid;
    }
    getFieldValue(valueList, fieldId) {
        let labelFilterByName, valueFound;
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            labelFilterByName = fieldId.substring(0, fieldId.length - 6);
            if (valueList[labelFilterByName]) {
                valueFound = valueList[labelFilterByName].name;
            }
        }
        else if (valueList[fieldId] && valueList[fieldId].id) {
            valueFound = valueList[fieldId].id;
        }
        else {
            valueFound = valueList[fieldId];
        }
        return valueFound;
    }
    isInvalidValue(value) {
        return value === undefined || value === null;
    }
    getFormFieldById(form, fieldId) {
        return form.getFormFields().find((formField) => this.isSearchedField(formField, fieldId));
    }
    searchValueInForm(formField, fieldId) {
        let fieldValue = '';
        if (formField) {
            fieldValue = this.getObjectValue(formField, fieldId);
            if (!fieldValue) {
                if (formField.value && formField.value.id) {
                    fieldValue = formField.value.id;
                }
                else if (!this.isInvalidValue(formField.value)) {
                    fieldValue = formField.value;
                }
            }
        }
        return fieldValue;
    }
    isParentTabVisible(form, currentFormField) {
        const containers = this.getFormTabContainers(form);
        let isVisible = true;
        containers.map((container) => {
            if (!!this.getCurrentFieldFromTabById(container, currentFormField.id)) {
                const currentTab = form.tabs.find((tab) => tab.id === container.tab);
                if (!!currentTab) {
                    isVisible = currentTab.isVisible;
                }
            }
        });
        return isVisible;
    }
    getCurrentFieldFromTabById(container, fieldId) {
        const tabFields = Object.keys(container.field.fields).map(key => container.field.fields[key]);
        let currentField;
        for (const tabField of tabFields) {
            currentField = tabField.find((tab) => tab.id === fieldId);
            if (currentField) {
                return currentField;
            }
        }
        return null;
    }
    getFormTabContainers(form) {
        if (!!form) {
            return form.fields.filter(field => field.type === 'container' && field.tab);
        }
        return [];
    }
    getObjectValue(field, fieldId) {
        let value = '';
        if (field.value && field.value.name) {
            value = field.value.name;
        }
        else if (field.options) {
            const option = field.options.find((opt) => opt.id === field.value);
            if (option) {
                value = this.getValueFromOption(fieldId, option);
            }
        }
        return value;
    }
    getValueFromOption(fieldId, option) {
        let optionValue = '';
        if (fieldId && fieldId.indexOf('_LABEL') > 0) {
            optionValue = option.name;
        }
        else {
            optionValue = option.id;
        }
        return optionValue;
    }
    isSearchedField(field, fieldId) {
        const fieldToFind = (fieldId === null || fieldId === void 0 ? void 0 : fieldId.indexOf('_LABEL')) > 0 ? fieldId.replace('_LABEL', '') : fieldId;
        return (field.id && fieldToFind) ? field.id.toUpperCase() === fieldToFind.toUpperCase() : false;
    }
    getVariableValue(form, name, processVarList) {
        const processVariableValue = this.getProcessVariableValue(name, processVarList);
        const variableDefaultValue = form.getFormVariableValue(name);
        return (processVariableValue === undefined) ? variableDefaultValue : processVariableValue;
    }
    getProcessVariableValue(name, processVarList) {
        if (processVarList) {
            const processVariable = processVarList.find(variable => variable.id === name ||
                variable.id === `variables.${name}`);
            if (processVariable) {
                return processVariable.value;
            }
        }
        return undefined;
    }
    evaluateLogicalOperation(logicOp, previousValue, newValue) {
        switch (logicOp) {
            case 'and':
                return previousValue && newValue;
            case 'or':
                return previousValue || newValue;
            case 'and-not':
                return previousValue && !newValue;
            case 'or-not':
                return previousValue || !newValue;
            default:
                this.logService.error(`Invalid operator: ${logicOp}`);
                return undefined;
        }
    }
    evaluateCondition(leftValue, rightValue, operator) {
        switch (operator) {
            case '==':
                return leftValue + '' === rightValue + '';
            case '<':
                return leftValue < rightValue;
            case '!=':
                return leftValue + '' !== rightValue + '';
            case '>':
                return leftValue > rightValue;
            case '>=':
                return leftValue >= rightValue;
            case '<=':
                return leftValue <= rightValue;
            case 'empty':
                return leftValue ? leftValue === '' : true;
            case '!empty':
                return leftValue ? leftValue !== '' : false;
            default:
                this.logService.error(`Invalid operator: ${operator}`);
                return undefined;
        }
    }
    cleanProcessVariable() {
        this.processVarList = [];
    }
    getTaskProcessVariable(taskId) {
        return from(this.apiService.getInstance().activiti.taskFormsApi.getTaskFormVariables(taskId))
            .pipe(map((res) => {
            const jsonRes = this.toJson(res);
            this.processVarList = jsonRes;
            return jsonRes;
        }), catchError(() => this.handleError()));
    }
    toJson(res) {
        return res || {};
    }
    isValidOperator(operator) {
        return operator !== undefined;
    }
    isValidCondition(condition) {
        return !!(condition && condition.operator);
    }
    handleError() {
        this.logService.error('Error while performing a call');
        return throwError('Error while performing a call - Server error');
    }
}
WidgetVisibilityService.ɵfac = function WidgetVisibilityService_Factory(t) { return new (t || WidgetVisibilityService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.LogService)); };
WidgetVisibilityService.ɵprov = i0.ɵɵdefineInjectable({ factory: function WidgetVisibilityService_Factory() { return new WidgetVisibilityService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: WidgetVisibilityService, providedIn: "root" });
WidgetVisibilityService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(WidgetVisibilityService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.LogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXZpc2liaWxpdHkuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvZm9ybS9zZXJ2aWNlcy93aWRnZXQtdmlzaWJpbGl0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLE1BQU0sTUFBTSxZQUFZLENBQUM7QUFDaEMsT0FBTyxFQUFjLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFTcEQsT0FBTyxFQUF5QixjQUFjLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMxRixPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pEO0FBRXNCO0FBSVA7Ozs7QUFGZixNQUFNLE9BQU8sdUJBQXVCO0FBQ3BDLElBSUksWUFBb0IsVUFBOEIsRUFDOUIsVUFBc0I7QUFDOUMsUUFGd0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7QUFBQyxRQUMvQixlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsSUFDM0MsQ0FBQztBQUNMLElBQ1csaUJBQWlCLENBQUMsSUFBZSxFQUFFLGNBQTJDO0FBQ3pGLFFBQVEsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDekIsUUFBUSxJQUFJLGNBQWMsRUFBRTtBQUM1QixZQUFZLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0FBQ2pELFNBQVM7QUFDVCxRQUFRLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElB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LENBQUMsQ0FBQztBQUNuRCxJQUFJLENBQUM7QUFDTCxJQUNZLFdBQVc7QUFDdkIsUUFBUSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQy9ELFFBQVEsT0FBTyxVQUFVLENBQUMsOENBQThDLENBQUMsQ0FBQztBQUMxRSxJQUFJLENBQUM7QUFDTDswTUFBQztBQUNELDJRQS9USztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBckJOLGtCQUFrQjtLQWlCdkIsVUFBVSxFQUFFLE1BQU0sdkJBakJTLFlBQ3RCLFVBQVU7QUFBRztTQWlCckI7Ozs7O2dIQWpCdUI7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2FsZnJlc2NvLWFwaS5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC1lczYnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBGb3JtRmllbGRNb2RlbCxcbiAgICBGb3JtTW9kZWwsXG4gICAgVGFiTW9kZWwsXG4gICAgQ29udGFpbmVyTW9kZWwsXG4gICAgRm9ybU91dGNvbWVNb2RlbFxufSBmcm9tICcuLi9jb21wb25lbnRzL3dpZGdldHMvY29yZS9pbmRleCc7XG5pbXBvcnQgeyBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvdGFzay1wcm9jZXNzLXZhcmlhYmxlLm1vZGVsJztcbmltcG9ydCB7IFdpZGdldFZpc2liaWxpdHlNb2RlbCwgV2lkZ2V0VHlwZUVudW0gfSBmcm9tICcuLi9tb2RlbHMvd2lkZ2V0LXZpc2liaWxpdHkubW9kZWwnO1xuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFdpZGdldFZpc2liaWxpdHlTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgcHJvY2Vzc1Zhckxpc3Q6IFRhc2tQcm9jZXNzVmFyaWFibGVNb2RlbFtdO1xuICAgIHByaXZhdGUgZm9ybTogRm9ybU1vZGVsO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHVibGljIHJlZnJlc2hWaXNpYmlsaXR5KGZvcm06IEZvcm1Nb2RlbCwgcHJvY2Vzc1Zhckxpc3Q/OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSkge1xuICAgICAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICAgICAgICBpZiAocHJvY2Vzc1Zhckxpc3QpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1Zhckxpc3QgPSBwcm9jZXNzVmFyTGlzdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZm9ybSAmJiBmb3JtLnRhYnMgJiYgZm9ybS50YWJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvcm0udGFicy5tYXAoKHRhYk1vZGVsKSA9PiB0aGlzLnJlZnJlc2hFbnRpdHlWaXNpYmlsaXR5KHRhYk1vZGVsKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm9ybSAmJiBmb3JtLm91dGNvbWVzICYmIGZvcm0ub3V0Y29tZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9ybS5vdXRjb21lcy5tYXAoKG91dGNvbWVNb2RlbCkgPT4gdGhpcy5yZWZyZXNoT3V0Y29tZVZpc2liaWxpdHkob3V0Y29tZU1vZGVsKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm9ybSkge1xuICAgICAgICAgICAgZm9ybS5nZXRGb3JtRmllbGRzKCkubWFwKChmaWVsZCkgPT4gdGhpcy5yZWZyZXNoRW50aXR5VmlzaWJpbGl0eShmaWVsZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVmcmVzaEVudGl0eVZpc2liaWxpdHkoZWxlbWVudDogRm9ybUZpZWxkTW9kZWwgfCBUYWJNb2RlbCkge1xuICAgICAgICBjb25zdCB2aXNpYmxlID0gdGhpcy5ldmFsdWF0ZVZpc2liaWxpdHkoZWxlbWVudC5mb3JtLCBlbGVtZW50LnZpc2liaWxpdHlDb25kaXRpb24pO1xuICAgICAgICBlbGVtZW50LmlzVmlzaWJsZSA9IHZpc2libGUgJiYgdGhpcy5pc1BhcmVudFRhYlZpc2libGUodGhpcy5mb3JtLCBlbGVtZW50KTtcbiAgICB9XG5cbiAgICByZWZyZXNoT3V0Y29tZVZpc2liaWxpdHkoZWxlbWVudDogRm9ybU91dGNvbWVNb2RlbCkge1xuICAgICAgICBlbGVtZW50LmlzVmlzaWJsZSA9IHRoaXMuZXZhbHVhdGVWaXNpYmlsaXR5KGVsZW1lbnQuZm9ybSwgZWxlbWVudC52aXNpYmlsaXR5Q29uZGl0aW9uKTtcbiAgICB9XG5cbiAgICBldmFsdWF0ZVZpc2liaWxpdHkoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgaXNMZWZ0RmllbGRQcmVzZW50ID0gdmlzaWJpbGl0eU9iaiAmJiAodmlzaWJpbGl0eU9iai5sZWZ0VHlwZSB8fCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSk7XG4gICAgICAgIGlmICghaXNMZWZ0RmllbGRQcmVzZW50IHx8IGlzTGVmdEZpZWxkUHJlc2VudCA9PT0gJ251bGwnKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzRmllbGRWaXNpYmxlKGZvcm0sIHZpc2liaWxpdHlPYmopO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNGaWVsZFZpc2libGUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwsIGFjY3VtdWxhdG9yOiBhbnlbXSA9IFtdLCByZXN1bHQ6IGJvb2xlYW4gPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBsZWZ0VmFsdWUgPSB0aGlzLmdldExlZnRWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgY29uc3QgcmlnaHRWYWx1ZSA9IHRoaXMuZ2V0UmlnaHRWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqKTtcbiAgICAgICAgY29uc3QgYWN0dWFsUmVzdWx0ID0gdGhpcy5ldmFsdWF0ZUNvbmRpdGlvbihsZWZ0VmFsdWUsIHJpZ2h0VmFsdWUsIHZpc2liaWxpdHlPYmoub3BlcmF0b3IpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzVmFsaWRPcGVyYXRvcih2aXNpYmlsaXR5T2JqLm5leHRDb25kaXRpb25PcGVyYXRvcikpIHtcbiAgICAgICAgICAgIGFjY3VtdWxhdG9yLnB1c2goeyB2YWx1ZTogYWN0dWFsUmVzdWx0LCBvcGVyYXRvcjogdmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uT3BlcmF0b3IgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pc1ZhbGlkQ29uZGl0aW9uKHZpc2liaWxpdHlPYmoubmV4dENvbmRpdGlvbikpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuaXNGaWVsZFZpc2libGUoZm9ybSwgdmlzaWJpbGl0eU9iai5uZXh0Q29uZGl0aW9uLCBhY2N1bXVsYXRvcik7XG4gICAgICAgIH0gZWxzZSBpZiAoYWNjdW11bGF0b3JbMF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmVzdWx0ID0gYWNjdW11bGF0b3JbMF0udmFsdWU7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGFjY3VtdWxhdG9yLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFjY3VtdWxhdG9yW2ldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5ldmFsdWF0ZUxvZ2ljYWxPcGVyYXRpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICBhY2N1bXVsYXRvcltpIC0gMV0ub3BlcmF0b3IsXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQsXG4gICAgICAgICAgICAgICAgICAgICAgICBhY2N1bXVsYXRvcltpXS52YWx1ZVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGFjdHVhbFJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gISFyZXN1bHQ7XG5cbiAgICB9XG5cbiAgICBnZXRMZWZ0VmFsdWUoZm9ybTogRm9ybU1vZGVsLCB2aXNpYmlsaXR5T2JqOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBzdHJpbmcge1xuICAgICAgICBsZXQgbGVmdFZhbHVlID0gJyc7XG4gICAgICAgIGlmICh2aXNpYmlsaXR5T2JqLmxlZnRUeXBlICYmIHZpc2liaWxpdHlPYmoubGVmdFR5cGUgPT09IFdpZGdldFR5cGVFbnVtLnZhcmlhYmxlKSB7XG4gICAgICAgICAgICBsZWZ0VmFsdWUgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5sZWZ0VmFsdWUsIHRoaXMucHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHZpc2liaWxpdHlPYmoubGVmdFR5cGUgJiYgdmlzaWJpbGl0eU9iai5sZWZ0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0uZmllbGQpIHtcbiAgICAgICAgICAgIGxlZnRWYWx1ZSA9IHRoaXMuZ2V0Rm9ybVZhbHVlKGZvcm0sIHZpc2liaWxpdHlPYmoubGVmdFZhbHVlKTtcbiAgICAgICAgICAgIGlmIChsZWZ0VmFsdWUgPT09IHVuZGVmaW5lZCB8fCBsZWZ0VmFsdWUgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFyaWFibGVWYWx1ZSA9IHRoaXMuZ2V0VmFyaWFibGVWYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLmxlZnRWYWx1ZSwgdGhpcy5wcm9jZXNzVmFyTGlzdCk7XG4gICAgICAgICAgICAgICAgbGVmdFZhbHVlID0gIXRoaXMuaXNJbnZhbGlkVmFsdWUodmFyaWFibGVWYWx1ZSkgPyB2YXJpYWJsZVZhbHVlIDogbGVmdFZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsZWZ0VmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0UmlnaHRWYWx1ZShmb3JtOiBGb3JtTW9kZWwsIHZpc2liaWxpdHlPYmo6IFdpZGdldFZpc2liaWxpdHlNb2RlbCk6IHN0cmluZyB7XG4gICAgICAgIGxldCB2YWx1ZUZvdW5kID0gJyc7XG4gICAgICAgIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0udmFyaWFibGUpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZm9ybSwgdmlzaWJpbGl0eU9iai5yaWdodFZhbHVlLCB0aGlzLnByb2Nlc3NWYXJMaXN0KTtcbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmlsaXR5T2JqLnJpZ2h0VHlwZSA9PT0gV2lkZ2V0VHlwZUVudW0uZmllbGQpIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB0aGlzLmdldEZvcm1WYWx1ZShmb3JtLCB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG1vbWVudCh2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWUsICdZWVlZLU1NLUREJywgdHJ1ZSkuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZpc2liaWxpdHlPYmoucmlnaHRWYWx1ZSArICdUMDA6MDA6MDAuMDAwWic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2aXNpYmlsaXR5T2JqLnJpZ2h0VmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlRm91bmQ7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybVZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgZmllbGRJZDogc3RyaW5nKTogYW55IHtcbiAgICAgICAgY29uc3QgZm9ybUZpZWxkID0gdGhpcy5nZXRGb3JtRmllbGRCeUlkKGZvcm0sIGZpZWxkSWQpO1xuICAgICAgICBsZXQgdmFsdWUgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNGb3JtRmllbGRWYWxpZChmb3JtRmllbGQpKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0RmllbGRWYWx1ZShmb3JtLnZhbHVlcywgZmllbGRJZCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmlzSW52YWxpZFZhbHVlKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5zZWFyY2hWYWx1ZUluRm9ybShmb3JtRmllbGQsIGZpZWxkSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpc0Zvcm1GaWVsZFZhbGlkKGZvcm1GaWVsZDogRm9ybUZpZWxkTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZvcm1GaWVsZCAmJiBmb3JtRmllbGQuaXNWYWxpZDtcbiAgICB9XG5cbiAgICBnZXRGaWVsZFZhbHVlKHZhbHVlTGlzdDogYW55LCBmaWVsZElkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBsZXQgbGFiZWxGaWx0ZXJCeU5hbWUsIHZhbHVlRm91bmQ7XG4gICAgICAgIGlmIChmaWVsZElkICYmIGZpZWxkSWQuaW5kZXhPZignX0xBQkVMJykgPiAwKSB7XG4gICAgICAgICAgICBsYWJlbEZpbHRlckJ5TmFtZSA9IGZpZWxkSWQuc3Vic3RyaW5nKDAsIGZpZWxkSWQubGVuZ3RoIC0gNik7XG4gICAgICAgICAgICBpZiAodmFsdWVMaXN0W2xhYmVsRmlsdGVyQnlOYW1lXSkge1xuICAgICAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbbGFiZWxGaWx0ZXJCeU5hbWVdLm5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWVMaXN0W2ZpZWxkSWRdICYmIHZhbHVlTGlzdFtmaWVsZElkXS5pZCkge1xuICAgICAgICAgICAgdmFsdWVGb3VuZCA9IHZhbHVlTGlzdFtmaWVsZElkXS5pZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhbHVlRm91bmQgPSB2YWx1ZUxpc3RbZmllbGRJZF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlRm91bmQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0ludmFsaWRWYWx1ZSh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsO1xuICAgIH1cblxuICAgIGdldEZvcm1GaWVsZEJ5SWQoZm9ybTogRm9ybU1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBGb3JtRmllbGRNb2RlbCB7XG4gICAgICAgIHJldHVybiBmb3JtLmdldEZvcm1GaWVsZHMoKS5maW5kKChmb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsKSA9PiB0aGlzLmlzU2VhcmNoZWRGaWVsZChmb3JtRmllbGQsIGZpZWxkSWQpKTtcbiAgICB9XG5cbiAgICBzZWFyY2hWYWx1ZUluRm9ybShmb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsLCBmaWVsZElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgZmllbGRWYWx1ZSA9ICcnO1xuXG4gICAgICAgIGlmIChmb3JtRmllbGQpIHtcbiAgICAgICAgICAgIGZpZWxkVmFsdWUgPSB0aGlzLmdldE9iamVjdFZhbHVlKGZvcm1GaWVsZCwgZmllbGRJZCk7XG5cbiAgICAgICAgICAgIGlmICghZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChmb3JtRmllbGQudmFsdWUgJiYgZm9ybUZpZWxkLnZhbHVlLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVmFsdWUgPSBmb3JtRmllbGQudmFsdWUuaWQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc0ludmFsaWRWYWx1ZShmb3JtRmllbGQudmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVmFsdWUgPSBmb3JtRmllbGQudmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWVsZFZhbHVlO1xuICAgIH1cblxuICAgIGlzUGFyZW50VGFiVmlzaWJsZShmb3JtOiBGb3JtTW9kZWwsIGN1cnJlbnRGb3JtRmllbGQ6IEZvcm1GaWVsZE1vZGVsIHwgVGFiTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IHRoaXMuZ2V0Rm9ybVRhYkNvbnRhaW5lcnMoZm9ybSk7XG4gICAgICAgIGxldCBpc1Zpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xuICAgICAgICBjb250YWluZXJzLm1hcCgoY29udGFpbmVyOiBDb250YWluZXJNb2RlbCkgPT4ge1xuICAgICAgICAgICAgaWYgKCEhdGhpcy5nZXRDdXJyZW50RmllbGRGcm9tVGFiQnlJZChjb250YWluZXIsIGN1cnJlbnRGb3JtRmllbGQuaWQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFRhYiA9IGZvcm0udGFicy5maW5kKCh0YWI6IFRhYk1vZGVsKSA9PiB0YWIuaWQgPT09IGNvbnRhaW5lci50YWIpO1xuICAgICAgICAgICAgICAgIGlmICghIWN1cnJlbnRUYWIpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNWaXNpYmxlID0gY3VycmVudFRhYi5pc1Zpc2libGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGlzVmlzaWJsZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEN1cnJlbnRGaWVsZEZyb21UYWJCeUlkKGNvbnRhaW5lcjogQ29udGFpbmVyTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IEZvcm1GaWVsZE1vZGVsIHtcbiAgICAgICAgY29uc3QgdGFiRmllbGRzOiBGb3JtRmllbGRNb2RlbFtdW10gPSBPYmplY3Qua2V5cyhjb250YWluZXIuZmllbGQuZmllbGRzKS5tYXAoa2V5ID0+IGNvbnRhaW5lci5maWVsZC5maWVsZHNba2V5XSk7XG4gICAgICAgIGxldCBjdXJyZW50RmllbGQ6IEZvcm1GaWVsZE1vZGVsO1xuXG4gICAgICAgIGZvciAoY29uc3QgdGFiRmllbGQgb2YgdGFiRmllbGRzKSB7XG4gICAgICAgICAgICBjdXJyZW50RmllbGQgPSB0YWJGaWVsZC5maW5kKCh0YWI6IEZvcm1GaWVsZE1vZGVsKSA9PiB0YWIuaWQgPT09IGZpZWxkSWQpO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRGaWVsZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RmllbGQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGb3JtVGFiQ29udGFpbmVycyhmb3JtOiBGb3JtTW9kZWwpOiBDb250YWluZXJNb2RlbFtdIHtcbiAgICAgICAgaWYgKCEhZm9ybSkge1xuICAgICAgICAgICAgcmV0dXJuIDxDb250YWluZXJNb2RlbFtdPiBmb3JtLmZpZWxkcy5maWx0ZXIoZmllbGQgPT4gZmllbGQudHlwZSA9PT0gJ2NvbnRhaW5lcicgJiYgZmllbGQudGFiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRPYmplY3RWYWx1ZShmaWVsZDogRm9ybUZpZWxkTW9kZWwsIGZpZWxkSWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGxldCB2YWx1ZSA9ICcnO1xuICAgICAgICBpZiAoZmllbGQudmFsdWUgJiYgZmllbGQudmFsdWUubmFtZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBmaWVsZC52YWx1ZS5uYW1lO1xuICAgICAgICB9IGVsc2UgaWYgKGZpZWxkLm9wdGlvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGZpZWxkLm9wdGlvbnMuZmluZCgob3B0KSA9PiBvcHQuaWQgPT09IGZpZWxkLnZhbHVlKTtcbiAgICAgICAgICAgIGlmIChvcHRpb24pIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tT3B0aW9uKGZpZWxkSWQsIG9wdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VmFsdWVGcm9tT3B0aW9uKGZpZWxkSWQ6IHN0cmluZywgb3B0aW9uKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IG9wdGlvblZhbHVlID0gJyc7XG4gICAgICAgIGlmIChmaWVsZElkICYmIGZpZWxkSWQuaW5kZXhPZignX0xBQkVMJykgPiAwKSB7XG4gICAgICAgICAgICBvcHRpb25WYWx1ZSA9IG9wdGlvbi5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBvcHRpb24uaWQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9wdGlvblZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNTZWFyY2hlZEZpZWxkKGZpZWxkOiBGb3JtRmllbGRNb2RlbCwgZmllbGRJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGZpZWxkVG9GaW5kID0gZmllbGRJZD8uaW5kZXhPZignX0xBQkVMJykgPiAwID8gZmllbGRJZC5yZXBsYWNlKCdfTEFCRUwnLCAnJykgOiBmaWVsZElkO1xuICAgICAgICByZXR1cm4gKGZpZWxkLmlkICYmIGZpZWxkVG9GaW5kKSA/IGZpZWxkLmlkLnRvVXBwZXJDYXNlKCkgPT09IGZpZWxkVG9GaW5kLnRvVXBwZXJDYXNlKCkgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBnZXRWYXJpYWJsZVZhbHVlKGZvcm06IEZvcm1Nb2RlbCwgbmFtZTogc3RyaW5nLCBwcm9jZXNzVmFyTGlzdDogVGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwcm9jZXNzVmFyaWFibGVWYWx1ZSA9IHRoaXMuZ2V0UHJvY2Vzc1ZhcmlhYmxlVmFsdWUobmFtZSwgcHJvY2Vzc1Zhckxpc3QpO1xuICAgICAgICBjb25zdCB2YXJpYWJsZURlZmF1bHRWYWx1ZSA9IGZvcm0uZ2V0Rm9ybVZhcmlhYmxlVmFsdWUobmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIChwcm9jZXNzVmFyaWFibGVWYWx1ZSA9PT0gdW5kZWZpbmVkKSA/IHZhcmlhYmxlRGVmYXVsdFZhbHVlIDogcHJvY2Vzc1ZhcmlhYmxlVmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQcm9jZXNzVmFyaWFibGVWYWx1ZShuYW1lOiBzdHJpbmcsIHByb2Nlc3NWYXJMaXN0OiBUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXSk6IHN0cmluZyB7XG4gICAgICAgIGlmIChwcm9jZXNzVmFyTGlzdCkge1xuICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1ZhcmlhYmxlID0gcHJvY2Vzc1Zhckxpc3QuZmluZChcbiAgICAgICAgICAgICAgICB2YXJpYWJsZSA9PlxuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZS5pZCA9PT0gbmFtZSB8fFxuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZS5pZCA9PT0gYHZhcmlhYmxlcy4ke25hbWV9YFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKHByb2Nlc3NWYXJpYWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwcm9jZXNzVmFyaWFibGUudmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBldmFsdWF0ZUxvZ2ljYWxPcGVyYXRpb24obG9naWNPcDogc3RyaW5nLCBwcmV2aW91c1ZhbHVlOiBhbnksIG5ld1ZhbHVlOiBhbnkpOiBib29sZWFuIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgc3dpdGNoIChsb2dpY09wKSB7XG4gICAgICAgICAgICBjYXNlICdhbmQnOlxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlICYmIG5ld1ZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnb3InIDpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSB8fCBuZXdWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2FuZC1ub3QnOlxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlICYmICFuZXdWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ29yLW5vdCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWUgfHwgIW5ld1ZhbHVlO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoYEludmFsaWQgb3BlcmF0b3I6ICR7bG9naWNPcH1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZXZhbHVhdGVDb25kaXRpb24obGVmdFZhbHVlOiBhbnksIHJpZ2h0VmFsdWU6IGFueSwgb3BlcmF0b3I6IHN0cmluZyk6IGJvb2xlYW4gfCB1bmRlZmluZWQge1xuICAgICAgICBzd2l0Y2ggKG9wZXJhdG9yKSB7XG4gICAgICAgICAgICBjYXNlICc9PSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSArICcnID09PSByaWdodFZhbHVlICsgJyc7XG4gICAgICAgICAgICBjYXNlICc8JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlIDwgcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJyE9JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlICsgJycgIT09IHJpZ2h0VmFsdWUgKyAnJztcbiAgICAgICAgICAgIGNhc2UgJz4nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPiByaWdodFZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnPj0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0VmFsdWUgPj0gcmlnaHRWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJzw9JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlIDw9IHJpZ2h0VmFsdWU7XG4gICAgICAgICAgICBjYXNlICdlbXB0eSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnRWYWx1ZSA/IGxlZnRWYWx1ZSA9PT0gJycgOiB0cnVlO1xuICAgICAgICAgICAgY2FzZSAnIWVtcHR5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gbGVmdFZhbHVlID8gbGVmdFZhbHVlICE9PSAnJyA6IGZhbHNlO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoYEludmFsaWQgb3BlcmF0b3I6ICR7b3BlcmF0b3J9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsZWFuUHJvY2Vzc1ZhcmlhYmxlKCkge1xuICAgICAgICB0aGlzLnByb2Nlc3NWYXJMaXN0ID0gW107XG4gICAgfVxuXG4gICAgZ2V0VGFza1Byb2Nlc3NWYXJpYWJsZSh0YXNrSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGFza1Byb2Nlc3NWYXJpYWJsZU1vZGVsW10+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudGFza0Zvcm1zQXBpLmdldFRhc2tGb3JtVmFyaWFibGVzKHRhc2tJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uUmVzID0gdGhpcy50b0pzb24ocmVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzVmFyTGlzdCA9IDxUYXNrUHJvY2Vzc1ZhcmlhYmxlTW9kZWxbXT4ganNvblJlcztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb25SZXM7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB0aGlzLmhhbmRsZUVycm9yKCkpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHRvSnNvbihyZXM6IGFueSk6IGFueSB7XG4gICAgICAgIHJldHVybiByZXMgfHwge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1ZhbGlkT3BlcmF0b3Iob3BlcmF0b3I6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gb3BlcmF0b3IgIT09IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzVmFsaWRDb25kaXRpb24oY29uZGl0aW9uOiBXaWRnZXRWaXNpYmlsaXR5TW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhKGNvbmRpdGlvbiAmJiBjb25kaXRpb24ub3BlcmF0b3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlRXJyb3IoKSB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcignRXJyb3Igd2hpbGUgcGVyZm9ybWluZyBhIGNhbGwnKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0Vycm9yIHdoaWxlIHBlcmZvcm1pbmcgYSBjYWxsIC0gU2VydmVyIGVycm9yJyk7XG4gICAgfVxufVxuIl19
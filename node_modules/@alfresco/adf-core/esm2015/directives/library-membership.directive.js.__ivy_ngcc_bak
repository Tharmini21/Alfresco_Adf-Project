/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { SiteEntry } from '@alfresco/js-api';
import { BehaviorSubject, from } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { SitesService } from '../services/sites.service';
import { VersionCompatibilityService } from '../services/version-compatibility.service';
export class LibraryMembershipDirective {
    constructor(alfrescoApiService, sitesService, versionCompatibilityService) {
        this.alfrescoApiService = alfrescoApiService;
        this.sitesService = sitesService;
        this.versionCompatibilityService = versionCompatibilityService;
        this.targetSite = null;
        this.isJoinRequested = new BehaviorSubject(false);
        this.selection = null;
        this.isAdmin = false;
        this.toggle = new EventEmitter();
        this.error = new EventEmitter();
    }
    onClick() {
        this.toggleMembershipRequest();
    }
    ngOnChanges(changes) {
        if (!changes.selection.currentValue || !changes.selection.currentValue.entry) {
            this.targetSite = null;
            return;
        }
        this.targetSite = changes.selection.currentValue.entry;
        this.markMembershipRequest();
    }
    toggleMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        if (this.targetSite.joinRequested) {
            this.cancelJoinRequest().subscribe(() => {
                this.targetSite.joinRequested = false;
                this.isJoinRequested.next(false);
                const info = {
                    updatedEntry: this.targetSite,
                    shouldReload: false,
                    i18nKey: 'APP.MESSAGES.INFO.JOIN_CANCELED'
                };
                this.toggle.emit(info);
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_CANCEL_FAILED'
                };
                this.error.emit(errWithMessage);
            });
        }
        if (!this.targetSite.joinRequested && !this.isAdmin) {
            this.joinLibraryRequest().subscribe((createdMembership) => {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
                if (createdMembership.entry && createdMembership.entry.site && createdMembership.entry.site.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
                else {
                    const info = {
                        updatedEntry: this.targetSite,
                        shouldReload: false,
                        i18nKey: 'APP.MESSAGES.INFO.JOIN_REQUESTED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
        if (this.isAdmin) {
            this.joinLibrary().subscribe((createdMembership) => {
                if (createdMembership.entry && createdMembership.entry.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
    }
    markMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        this.getMembershipRequest().subscribe((data) => {
            if (data.entry.id === this.targetSite.id) {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
            }
        }, () => {
            this.targetSite.joinRequested = false;
            this.isJoinRequested.next(false);
        });
    }
    joinLibraryRequest() {
        const memberBody = {
            id: this.targetSite.id
        };
        if (this.versionCompatibilityService.isVersionSupported('7.0.0')) {
            memberBody.client = 'workspace';
        }
        return from(this.alfrescoApiService.peopleApi.addSiteMembershipRequest('-me-', memberBody));
    }
    joinLibrary() {
        return this.sitesService.createSiteMembership(this.targetSite.id, {
            role: 'SiteConsumer',
            id: '-me-'
        });
    }
    cancelJoinRequest() {
        return from(this.alfrescoApiService.peopleApi.removeSiteMembershipRequest('-me-', this.targetSite.id));
    }
    getMembershipRequest() {
        return from(this.alfrescoApiService.peopleApi.getSiteMembershipRequest('-me-', this.targetSite.id));
    }
}
LibraryMembershipDirective.decorators = [
    { type: Directive, args: [{
                selector: '[adf-library-membership]',
                exportAs: 'libraryMembership'
            },] }
];
LibraryMembershipDirective.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SitesService },
    { type: VersionCompatibilityService }
];
LibraryMembershipDirective.propDecorators = {
    selection: [{ type: Input, args: ['adf-library-membership',] }],
    isAdmin: [{ type: Input }],
    toggle: [{ type: Output }],
    error: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS1tZW1iZXJzaGlwLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvIiwic291cmNlcyI6WyJkaXJlY3RpdmVzL2xpYnJhcnktbWVtYmVyc2hpcC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQy9HLE9BQU8sRUFBRSxTQUFTLEVBQTBFLE1BQU0sa0JBQWtCLENBQUM7QUFDckgsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBaUJ4RixNQUFNLE9BQU8sMEJBQTBCO0lBeUJuQyxZQUNZLGtCQUFzQyxFQUN0QyxZQUEwQixFQUMxQiwyQkFBd0Q7UUFGeEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBM0JwRSxlQUFVLEdBQVEsSUFBSSxDQUFDO1FBRXZCLG9CQUFlLEdBQTZCLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBSWhGLGNBQVMsR0FBYyxJQUFJLENBQUM7UUFJNUIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUdoQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQWdDLENBQUM7UUFJMUQsVUFBSyxHQUFHLElBQUksWUFBWSxFQUErQixD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TSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVPLFdBQVc7UUFDZixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUU7WUFDOUQsSUFBSSxFQUFFLGNBQWM7WUFDcEIsRUFBRSxFQUFFLE1BQU07U0FDYixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8saUJBQWlCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsMkJBQTJCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzRyxDQUFDO0lBRU8sb0JBQW9CO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4RyxDQUFDOzs7WUFoTUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSwwQkFBMEI7Z0JBQ3BDLFFBQVEsRUFBRSxtQkFBbUI7YUFDaEM7OztZQWxCUSxrQkFBa0I7WUFDbEIsWUFBWTtZQUNaLDJCQUEyQjs7O3dCQXVCL0IsS0FBSyxTQUFDLHdCQUF3QjtzQkFJOUIsS0FBSztxQkFHTCxNQUFNO29CQUlOLE1BQU07c0JBR04sWUFBWSxTQUFDLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgSG9zdExpc3RlbmVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFNpdGVFbnRyeSwgU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0Qm9keSwgU2l0ZU1lbWJlckVudHJ5LCBTaXRlTWVtYmVyc2hpcFJlcXVlc3RFbnRyeSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmcm9tLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hbGZyZXNjby1hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBTaXRlc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zaXRlcy5zZXJ2aWNlJztcbmltcG9ydCB7IFZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3ZlcnNpb24tY29tcGF0aWJpbGl0eS5zZXJ2aWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBMaWJyYXJ5TWVtYmVyc2hpcFRvZ2dsZUV2ZW50IHtcbiAgICB1cGRhdGVkRW50cnk/OiBhbnk7XG4gICAgc2hvdWxkUmVsb2FkOiBib29sZWFuO1xuICAgIGkxOG5LZXk6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMaWJyYXJ5TWVtYmVyc2hpcEVycm9yRXZlbnQge1xuICAgIGVycm9yOiBhbnk7XG4gICAgaTE4bktleTogc3RyaW5nO1xufVxuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1thZGYtbGlicmFyeS1tZW1iZXJzaGlwXScsXG4gICAgZXhwb3J0QXM6ICdsaWJyYXJ5TWVtYmVyc2hpcCdcbn0pXG5leHBvcnQgY2xhc3MgTGlicmFyeU1lbWJlcnNoaXBEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICAgIHRhcmdldFNpdGU6IGFueSA9IG51bGw7XG5cbiAgICBpc0pvaW5SZXF1ZXN0ZWQ6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xuXG4gICAgLyoqIFNpdGUgZm9yIHdoaWNoIHRvIHRvZ2dsZSB0aGUgbWVtYmVyc2hpcCByZXF1ZXN0LiAqL1xuICAgIEBJbnB1dCgnYWRmLWxpYnJhcnktbWVtYmVyc2hpcCcpXG4gICAgc2VsZWN0aW9uOiBTaXRlRW50cnkgPSBudWxsO1xuXG4gICAgLyoqIFNpdGUgZm9yIHdoaWNoIHRvIHRvZ2dsZSB0aGUgbWVtYmVyc2hpcCByZXF1ZXN0LiAqL1xuICAgIEBJbnB1dCgpXG4gICAgaXNBZG1pbiA9IGZhbHNlO1xuXG4gICAgQE91dHB1dCgpXG4gICAgdG9nZ2xlID0gbmV3IEV2ZW50RW1pdHRlcjxMaWJyYXJ5TWVtYmVyc2hpcFRvZ2dsZUV2ZW50PigpO1xuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1vdXRwdXQtbmF0aXZlXG4gICAgQE91dHB1dCgpXG4gICAgZXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPExpYnJhcnlNZW1iZXJzaGlwRXJyb3JFdmVudD4oKTtcblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJylcbiAgICBvbkNsaWNrKCkge1xuICAgICAgICB0aGlzLnRvZ2dsZU1lbWJlcnNoaXBSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgYWxmcmVzY29BcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc2l0ZXNTZXJ2aWNlOiBTaXRlc1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlOiBWZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2VcbiAgICApIHt9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIGlmICghY2hhbmdlcy5zZWxlY3Rpb24uY3VycmVudFZhbHVlIHx8ICFjaGFuZ2VzLnNlbGVjdGlvbi5jdXJyZW50VmFsdWUuZW50cnkpIHtcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0U2l0ZSA9IG51bGw7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRhcmdldFNpdGUgPSBjaGFuZ2VzLnNlbGVjdGlvbi5jdXJyZW50VmFsdWUuZW50cnk7XG4gICAgICAgIHRoaXMubWFya01lbWJlcnNoaXBSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgdG9nZ2xlTWVtYmVyc2hpcFJlcXVlc3QoKSB7XG4gICAgICAgIGlmICghdGhpcy50YXJnZXRTaXRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FuY2VsSm9pblJlcXVlc3QoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzSm9pblJlcXVlc3RlZC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRFbnRyeTogdGhpcy50YXJnZXRTaXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUmVsb2FkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuSU5GTy5KT0lOX0NBTkNFTEVEJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZS5lbWl0KGluZm8pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycldpdGhNZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLkVSUk9SUy5KT0lOX0NBTkNFTF9GQUlMRUQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnJXaXRoTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQgJiYgIXRoaXMuaXNBZG1pbikge1xuICAgICAgICAgICAgdGhpcy5qb2luTGlicmFyeVJlcXVlc3QoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGNyZWF0ZWRNZW1iZXJzaGlwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0pvaW5SZXF1ZXN0ZWQubmV4dCh0cnVlKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRlZE1lbWJlcnNoaXAuZW50cnkgJiYgY3JlYXRlZE1lbWJlcnNoaXAuZW50cnkuc2l0ZSAmJiBjcmVhdGVkTWVtYmVyc2hpcC5lbnRyeS5zaXRlLnJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUmVsb2FkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuSU5GTy5KT0lORUQnXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdChpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEVudHJ5OiB0aGlzLnRhcmdldFNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUmVsb2FkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLklORk8uSk9JTl9SRVFVRVNURUQnXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdChpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycldpdGhNZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLkVSUk9SUy5KT0lOX1JFUVVFU1RfRkFJTEVEJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbmRlckVtYWlsQ2hlY2sgPSAnRmFpbGVkIHRvIHJlc29sdmUgc2VuZGVyIG1haWwgYWRkcmVzcyc7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVyRW1haWxDaGVjayA9ICdBbGwgcmVjaXBpZW50cyBmb3IgdGhlIG1haWwgYWN0aW9uIHdlcmUgaW52YWxpZCc7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKHNlbmRlckVtYWlsQ2hlY2spKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyV2l0aE1lc3NhZ2UuaTE4bktleSA9ICdBUFAuTUVTU0FHRVMuRVJST1JTLklOVkFMSURfU0VOREVSX0VNQUlMJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhyZWNlaXZlckVtYWlsQ2hlY2spKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyV2l0aE1lc3NhZ2UuaTE4bktleSA9ICdBUFAuTUVTU0FHRVMuRVJST1JTLklOVkFMSURfUkVDRUlWRVJfRU1BSUwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycldpdGhNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaXNBZG1pbikge1xuICAgICAgICAgICAgdGhpcy5qb2luTGlicmFyeSgpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoY3JlYXRlZE1lbWJlcnNoaXA6IFNpdGVNZW1iZXJFbnRyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRlZE1lbWJlcnNoaXAuZW50cnkgJiYgY3JlYXRlZE1lbWJlcnNoaXAuZW50cnkucm9sZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRSZWxvYWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5JTkZPLkpPSU5FRCdcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZS5lbWl0KGluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyV2l0aE1lc3NhZ2UgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuRVJST1JTLkpPSU5fUkVRVUVTVF9GQUlMRUQnXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VuZGVyRW1haWxDaGVjayA9ICdGYWlsZWQgdG8gcmVzb2x2ZSBzZW5kZXIgbWFpbCBhZGRyZXNzJztcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZWl2ZXJFbWFpbENoZWNrID0gJ0FsbCByZWNpcGllbnRzIGZvciB0aGUgbWFpbCBhY3Rpb24gd2VyZSBpbnZhbGlkJztcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoc2VuZGVyRW1haWxDaGVjaykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJXaXRoTWVzc2FnZS5pMThuS2V5ID0gJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSU5WQUxJRF9TRU5ERVJfRU1BSUwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKHJlY2VpdmVyRW1haWxDaGVjaykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJXaXRoTWVzc2FnZS5pMThuS2V5ID0gJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSU5WQUxJRF9SRUNFSVZFUl9FTUFJTCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyV2l0aE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrTWVtYmVyc2hpcFJlcXVlc3QoKSB7XG4gICAgICAgIGlmICghdGhpcy50YXJnZXRTaXRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdldE1lbWJlcnNoaXBSZXF1ZXN0KCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5lbnRyeS5pZCA9PT0gdGhpcy50YXJnZXRTaXRlLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0pvaW5SZXF1ZXN0ZWQubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5pc0pvaW5SZXF1ZXN0ZWQubmV4dChmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBqb2luTGlicmFyeVJlcXVlc3QoKTogT2JzZXJ2YWJsZTxTaXRlTWVtYmVyc2hpcFJlcXVlc3RFbnRyeT4ge1xuICAgICAgICBjb25zdCBtZW1iZXJCb2R5ID0ge1xuICAgICAgICAgICAgaWQ6IHRoaXMudGFyZ2V0U2l0ZS5pZFxuICAgICAgICB9IGFzIFNpdGVNZW1iZXJzaGlwUmVxdWVzdEJvZHk7XG5cbiAgICAgICAgaWYgKHRoaXMudmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlLmlzVmVyc2lvblN1cHBvcnRlZCgnNy4wLjAnKSkge1xuICAgICAgICAgICAgbWVtYmVyQm9keS5jbGllbnQgPSAnd29ya3NwYWNlJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5wZW9wbGVBcGkuYWRkU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0KCctbWUtJywgbWVtYmVyQm9keSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgam9pbkxpYnJhcnkoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNpdGVzU2VydmljZS5jcmVhdGVTaXRlTWVtYmVyc2hpcCh0aGlzLnRhcmdldFNpdGUuaWQsIHtcbiAgICAgICAgICAgIHJvbGU6ICdTaXRlQ29uc3VtZXInLFxuICAgICAgICAgICAgaWQ6ICctbWUtJ1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbmNlbEpvaW5SZXF1ZXN0KCkge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5wZW9wbGVBcGkucmVtb3ZlU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0KCctbWUtJywgdGhpcy50YXJnZXRTaXRlLmlkKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNZW1iZXJzaGlwUmVxdWVzdCgpIHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UucGVvcGxlQXBpLmdldFNpdGVNZW1iZXJzaGlwUmVxdWVzdCgnLW1lLScsIHRoaXMudGFyZ2V0U2l0ZS5pZCkpO1xuICAgIH1cbn1cbiJdfQ==
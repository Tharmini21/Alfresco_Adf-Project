/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Directive, ElementRef, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { forkJoin, from, of } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { TranslationService } from '../services/translation.service';
import { map, catchError, retry } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../services/alfresco-api.service';
import * as ɵngcc2 from '../services/translation.service';
export class NodeDeleteDirective {
    constructor(alfrescoApiService, translation, elementRef) {
        this.alfrescoApiService = alfrescoApiService;
        this.translation = translation;
        this.elementRef = elementRef;
        this.permanent = false;
        this.delete = new EventEmitter();
    }
    onClick() {
        this.process(this.selection);
    }
    ngOnChanges() {
        if (!this.selection || (this.selection && this.selection.length === 0)) {
            this.setDisableAttribute(true);
        }
        else {
            if (!this.elementRef.nativeElement.hasAttribute('adf-check-allowable-operation')) {
                this.setDisableAttribute(false);
            }
        }
    }
    setDisableAttribute(disable) {
        this.elementRef.nativeElement.disabled = disable;
    }
    process(selection) {
        if (selection && selection.length) {
            const batch = this.getDeleteNodesBatch(selection);
            forkJoin(...batch)
                .subscribe((data) => {
                const processedItems = this.processStatus(data);
                const message = this.getMessage(processedItems);
                if (message) {
                    this.delete.emit(message);
                }
            });
        }
    }
    getDeleteNodesBatch(selection) {
        return selection.map((node) => this.deleteNode(node));
    }
    deleteNode(node) {
        const id = node.entry.nodeId || node.entry.id;
        let promise;
        if (node.entry.hasOwnProperty('archivedAt') && node.entry['archivedAt']) {
            promise = this.alfrescoApiService.nodesApi.purgeDeletedNode(id);
        }
        else {
            promise = this.alfrescoApiService.nodesApi.deleteNode(id, { permanent: this.permanent });
        }
        return from(promise).pipe(retry(3), map(() => ({
            entry: node.entry,
            status: 1
        })), catchError(() => of({
            entry: node.entry,
            status: 0
        })));
    }
    processStatus(data) {
        const deleteStatus = {
            success: [],
            failed: [],
            get someFailed() {
                return !!(this.failed.length);
            },
            get someSucceeded() {
                return !!(this.success.length);
            },
            get oneFailed() {
                return this.failed.length === 1;
            },
            get oneSucceeded() {
                return this.success.length === 1;
            },
            get allSucceeded() {
                return this.someSucceeded && !this.someFailed;
            },
            get allFailed() {
                return this.someFailed && !this.someSucceeded;
            }
        };
        return data.reduce((acc, next) => {
            if (next.status === 1) {
                acc.success.push(next);
            }
            else {
                acc.failed.push(next);
            }
            return acc;
        }, deleteStatus);
    }
    getMessage(status) {
        if (status.allFailed && !status.oneFailed) {
            return this.translation.instant('CORE.DELETE_NODE.ERROR_PLURAL', { number: status.failed.length });
        }
        if (status.allSucceeded && !status.oneSucceeded) {
            return this.translation.instant('CORE.DELETE_NODE.PLURAL', { number: status.success.length });
        }
        if (status.someFailed && status.someSucceeded && !status.oneSucceeded) {
            return this.translation.instant('CORE.DELETE_NODE.PARTIAL_PLURAL', {
                success: status.success.length,
                failed: status.failed.length
            });
        }
        if (status.someFailed && status.oneSucceeded) {
            return this.translation.instant('CORE.DELETE_NODE.PARTIAL_SINGULAR', {
                success: status.success.length,
                failed: status.failed.length
            });
        }
        if (status.oneFailed && !status.someSucceeded) {
            return this.translation.instant('CORE.DELETE_NODE.ERROR_SINGULAR', { name: status.failed[0].entry.name });
        }
        if (status.oneSucceeded && !status.someFailed) {
            return this.translation.instant('CORE.DELETE_NODE.SINGULAR', { name: status.success[0].entry.name });
        }
        return null;
    }
}
NodeDeleteDirective.ɵfac = function NodeDeleteDirective_Factory(t) { return new (t || NodeDeleteDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.TranslationService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
NodeDeleteDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: NodeDeleteDirective, selectors: [["", "adf-delete", ""]], hostBindings: function NodeDeleteDirective_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function NodeDeleteDirective_click_HostBindingHandler() { return ctx.onClick(); });
    } }, inputs: { permanent: "permanent", selection: ["adf-delete", "selection"] }, outputs: { delete: "delete" }, features: [ɵngcc0.ɵɵNgOnChangesFeature] });
NodeDeleteDirective.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: TranslationService },
    { type: ElementRef }
];
NodeDeleteDirective.propDecorators = {
    selection: [{ type: Input, args: ['adf-delete',] }],
    permanent: [{ type: Input }],
    delete: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NodeDeleteDirective, [{
        type: Directive,
        args: [{
                selector: '[adf-delete]'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.TranslationService }, { type: ɵngcc0.ElementRef }]; }, { permanent: [{
            type: Input
        }], delete: [{
            type: Output
        }], onClick: [{
            type: HostListener,
            args: ['click']
        }], selection: [{
            type: Input,
            args: ['adf-delete']
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1kZWxldGUuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS9kaXJlY3RpdmVzL25vZGUtZGVsZXRlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBSUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTVHLE9BQU8sRUFBYyxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQTJCeEQsTUFBTSxPQUFPLG1CQUFtQjtBQUFHLElBa0IvQixZQUFvQixrQkFBc0MsRUFDdEMsV0FBK0IsRUFDL0IsVUFBc0I7QUFDOUMsUUFId0IsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUFDLFFBQ3ZDLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtBQUFDLFFBQ2hDLGVBQVUsR0FBVixVQUFVLENBQVk7QUFBQyxRQWIzQyxjQUFTLEdBQVksS0FBSyxDQUFDO0FBQy9CLFFBR0ksV0FBTSxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO0FBQ25ELElBU0ksQ0FBQztBQUNMLElBUkksT0FBTztBQUNYLFFBQVEsSUFBSSxDQUFDLE9B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O0FBQUc7QUFBdUMsd0JBa0N0RSxLQUFLLFNBQUMsWUFBWTtBQUNsQix3QkFHQSxLQUFLO0FBQ1IscUJBR0csTUFBTTtBQUNULHNCQUVHLFlBQVksU0FBQyxPQUFPO0FBQ3JCOzs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpuby1pbnB1dC1yZW5hbWUgICovXG5cbmltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIElucHV0LCBPbkNoYW5nZXMsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTm9kZUVudHJ5LCBOb2RlLCBEZWxldGVkTm9kZUVudGl0eSwgRGVsZXRlZE5vZGUgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luLCBmcm9tLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdHJhbnNsYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IsIHJldHJ5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbnRlcmZhY2UgUHJvY2Vzc2VkTm9kZURhdGEge1xuICAgIGVudHJ5OiBOb2RlIHwgRGVsZXRlZE5vZGU7XG4gICAgc3RhdHVzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBQcm9jZXNzU3RhdHVzIHtcbiAgICBzdWNjZXNzOiBQcm9jZXNzZWROb2RlRGF0YVtdO1xuICAgIGZhaWxlZDogUHJvY2Vzc2VkTm9kZURhdGFbXTtcblxuICAgIHNvbWVGYWlsZWQoKTtcblxuICAgIHNvbWVTdWNjZWVkZWQoKTtcblxuICAgIG9uZUZhaWxlZCgpO1xuXG4gICAgb25lU3VjY2VlZGVkKCk7XG5cbiAgICBhbGxTdWNjZWVkZWQoKTtcblxuICAgIGFsbEZhaWxlZCgpO1xufVxuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1thZGYtZGVsZXRlXSdcbn0pXG5leHBvcnQgY2xhc3MgTm9kZURlbGV0ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gICAgLyoqIEFycmF5IG9mIG5vZGVzIHRvIGRlbGV0ZS4gKi9cbiAgICBASW5wdXQoJ2FkZi1kZWxldGUnKVxuICAgIHNlbGVjdGlvbjogTm9kZUVudHJ5W10gfCBEZWxldGVkTm9kZUVudGl0eVtdO1xuXG4gICAgLyoqIElmIHRydWUgdGhlbiB0aGUgbm9kZXMgYXJlIGRlbGV0ZWQgaW1tZWRpYXRlbHkgcmF0aGVyIHRoYW4gYmVpbmcgcHV0IGluIHRoZSB0cmFzaCAqL1xuICAgIEBJbnB1dCgpXG4gICAgcGVybWFuZW50OiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIHRoZSBub2RlcyBoYXZlIGJlZW4gZGVsZXRlZC4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBkZWxldGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICAgIG9uQ2xpY2soKSB7XG4gICAgICAgIHRoaXMucHJvY2Vzcyh0aGlzLnNlbGVjdGlvbik7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoKSB7XG4gICAgICAgIGlmICghdGhpcy5zZWxlY3Rpb24gfHwgKHRoaXMuc2VsZWN0aW9uICYmIHRoaXMuc2VsZWN0aW9uLmxlbmd0aCA9PT0gMCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzYWJsZUF0dHJpYnV0ZSh0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuaGFzQXR0cmlidXRlKCdhZGYtY2hlY2stYWxsb3dhYmxlLW9wZXJhdGlvbicpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXREaXNhYmxlQXR0cmlidXRlKGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc2V0RGlzYWJsZUF0dHJpYnV0ZShkaXNhYmxlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmRpc2FibGVkID0gZGlzYWJsZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3Moc2VsZWN0aW9uOiBOb2RlRW50cnlbXSB8IERlbGV0ZWROb2RlRW50aXR5W10pIHtcbiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBzZWxlY3Rpb24ubGVuZ3RoKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IGJhdGNoID0gdGhpcy5nZXREZWxldGVOb2Rlc0JhdGNoKHNlbGVjdGlvbik7XG5cbiAgICAgICAgICAgIGZvcmtKb2luKC4uLmJhdGNoKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKGRhdGE6IFByb2Nlc3NlZE5vZGVEYXRhW10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc2VkSXRlbXM6IFByb2Nlc3NTdGF0dXMgPSB0aGlzLnByb2Nlc3NTdGF0dXMoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLmdldE1lc3NhZ2UocHJvY2Vzc2VkSXRlbXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZS5lbWl0KG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERlbGV0ZU5vZGVzQmF0Y2goc2VsZWN0aW9uOiBhbnkpOiBPYnNlcnZhYmxlPFByb2Nlc3NlZE5vZGVEYXRhPltdIHtcbiAgICAgICAgcmV0dXJuIHNlbGVjdGlvbi5tYXAoKG5vZGUpID0+IHRoaXMuZGVsZXRlTm9kZShub2RlKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWxldGVOb2RlKG5vZGU6IE5vZGVFbnRyeSB8IERlbGV0ZWROb2RlRW50aXR5KTogT2JzZXJ2YWJsZTxQcm9jZXNzZWROb2RlRGF0YT4ge1xuICAgICAgICBjb25zdCBpZCA9ICg8YW55PiBub2RlLmVudHJ5KS5ub2RlSWQgfHwgbm9kZS5lbnRyeS5pZDtcblxuICAgICAgICBsZXQgcHJvbWlzZTogUHJvbWlzZTxhbnk+O1xuXG4gICAgICAgIGlmIChub2RlLmVudHJ5Lmhhc093blByb3BlcnR5KCdhcmNoaXZlZEF0JykgJiYgbm9kZS5lbnRyeVsnYXJjaGl2ZWRBdCddKSB7XG4gICAgICAgICAgICBwcm9taXNlID0gdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2Uubm9kZXNBcGkucHVyZ2VEZWxldGVkTm9kZShpZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwcm9taXNlID0gdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2Uubm9kZXNBcGkuZGVsZXRlTm9kZShpZCwgeyBwZXJtYW5lbnQ6IHRoaXMucGVybWFuZW50IH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZyb20ocHJvbWlzZSkucGlwZShcbiAgICAgICAgICAgIHJldHJ5KDMpLFxuICAgICAgICAgICAgbWFwKCgpID0+ICh7XG4gICAgICAgICAgICAgICAgZW50cnk6IG5vZGUuZW50cnksXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAxXG4gICAgICAgICAgICB9KSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKHtcbiAgICAgICAgICAgICAgICBlbnRyeTogbm9kZS5lbnRyeSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDBcbiAgICAgICAgICAgIH0pKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc1N0YXR1cyhkYXRhKTogUHJvY2Vzc1N0YXR1cyB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZVN0YXR1cyA9IHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IFtdLFxuICAgICAgICAgICAgZmFpbGVkOiBbXSxcbiAgICAgICAgICAgIGdldCBzb21lRmFpbGVkKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAhISh0aGlzLmZhaWxlZC5sZW5ndGgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGdldCBzb21lU3VjY2VlZGVkKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAhISh0aGlzLnN1Y2Nlc3MubGVuZ3RoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXQgb25lRmFpbGVkKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZhaWxlZC5sZW5ndGggPT09IDE7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0IG9uZVN1Y2NlZWRlZCgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdWNjZXNzLmxlbmd0aCA9PT0gMTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXQgYWxsU3VjY2VlZGVkKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNvbWVTdWNjZWVkZWQgJiYgIXRoaXMuc29tZUZhaWxlZDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXQgYWxsRmFpbGVkKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNvbWVGYWlsZWQgJiYgIXRoaXMuc29tZVN1Y2NlZWRlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gZGF0YS5yZWR1Y2UoXG4gICAgICAgICAgICAoYWNjLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5leHQuc3RhdHVzID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjYy5zdWNjZXNzLnB1c2gobmV4dCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWNjLmZhaWxlZC5wdXNoKG5leHQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGVsZXRlU3RhdHVzXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNZXNzYWdlKHN0YXR1czogUHJvY2Vzc1N0YXR1cyk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICBpZiAoc3RhdHVzLmFsbEZhaWxlZCAmJiAhc3RhdHVzLm9uZUZhaWxlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChcbiAgICAgICAgICAgICAgICAnQ09SRS5ERUxFVEVfTk9ERS5FUlJPUl9QTFVSQUwnLFxuICAgICAgICAgICAgICAgIHsgbnVtYmVyOiBzdGF0dXMuZmFpbGVkLmxlbmd0aCB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHN0YXR1cy5hbGxTdWNjZWVkZWQgJiYgIXN0YXR1cy5vbmVTdWNjZWVkZWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0aW9uLmluc3RhbnQoXG4gICAgICAgICAgICAgICAgJ0NPUkUuREVMRVRFX05PREUuUExVUkFMJyxcbiAgICAgICAgICAgICAgICB7IG51bWJlcjogc3RhdHVzLnN1Y2Nlc3MubGVuZ3RoIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc3RhdHVzLnNvbWVGYWlsZWQgJiYgc3RhdHVzLnNvbWVTdWNjZWVkZWQgJiYgIXN0YXR1cy5vbmVTdWNjZWVkZWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0aW9uLmluc3RhbnQoXG4gICAgICAgICAgICAgICAgJ0NPUkUuREVMRVRFX05PREUuUEFSVElBTF9QTFVSQUwnLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzczogc3RhdHVzLnN1Y2Nlc3MubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHN0YXR1cy5mYWlsZWQubGVuZ3RoXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdGF0dXMuc29tZUZhaWxlZCAmJiBzdGF0dXMub25lU3VjY2VlZGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvbi5pbnN0YW50KFxuICAgICAgICAgICAgICAgICdDT1JFLkRFTEVURV9OT0RFLlBBUlRJQUxfU0lOR1VMQVInLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzczogc3RhdHVzLnN1Y2Nlc3MubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHN0YXR1cy5mYWlsZWQubGVuZ3RoXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdGF0dXMub25lRmFpbGVkICYmICFzdGF0dXMuc29tZVN1Y2NlZWRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChcbiAgICAgICAgICAgICAgICAnQ09SRS5ERUxFVEVfTk9ERS5FUlJPUl9TSU5HVUxBUicsXG4gICAgICAgICAgICAgICAgeyBuYW1lOiBzdGF0dXMuZmFpbGVkWzBdLmVudHJ5Lm5hbWUgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdGF0dXMub25lU3VjY2VlZGVkICYmICFzdGF0dXMuc29tZUZhaWxlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb24uaW5zdGFudChcbiAgICAgICAgICAgICAgICAnQ09SRS5ERUxFVEVfTk9ERS5TSU5HVUxBUicsXG4gICAgICAgICAgICAgICAgeyBuYW1lOiBzdGF0dXMuc3VjY2Vzc1swXS5lbnRyeS5uYW1lIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { SiteEntry } from '@alfresco/js-api';
import { BehaviorSubject, from } from 'rxjs';
import { AlfrescoApiService } from '../services/alfresco-api.service';
import { SitesService } from '../services/sites.service';
import { VersionCompatibilityService } from '../services/version-compatibility.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../services/alfresco-api.service';
import * as ɵngcc2 from '../services/sites.service';
import * as ɵngcc3 from '../services/version-compatibility.service';
export class LibraryMembershipDirective {
    constructor(alfrescoApiService, sitesService, versionCompatibilityService) {
        this.alfrescoApiService = alfrescoApiService;
        this.sitesService = sitesService;
        this.versionCompatibilityService = versionCompatibilityService;
        this.targetSite = null;
        this.isJoinRequested = new BehaviorSubject(false);
        this.selection = null;
        this.isAdmin = false;
        this.toggle = new EventEmitter();
        this.error = new EventEmitter();
    }
    onClick() {
        this.toggleMembershipRequest();
    }
    ngOnChanges(changes) {
        if (!changes.selection.currentValue || !changes.selection.currentValue.entry) {
            this.targetSite = null;
            return;
        }
        this.targetSite = changes.selection.currentValue.entry;
        this.markMembershipRequest();
    }
    toggleMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        if (this.targetSite.joinRequested) {
            this.cancelJoinRequest().subscribe(() => {
                this.targetSite.joinRequested = false;
                this.isJoinRequested.next(false);
                const info = {
                    updatedEntry: this.targetSite,
                    shouldReload: false,
                    i18nKey: 'APP.MESSAGES.INFO.JOIN_CANCELED'
                };
                this.toggle.emit(info);
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_CANCEL_FAILED'
                };
                this.error.emit(errWithMessage);
            });
        }
        if (!this.targetSite.joinRequested && !this.isAdmin) {
            this.joinLibraryRequest().subscribe((createdMembership) => {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
                if (createdMembership.entry && createdMembership.entry.site && createdMembership.entry.site.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
                else {
                    const info = {
                        updatedEntry: this.targetSite,
                        shouldReload: false,
                        i18nKey: 'APP.MESSAGES.INFO.JOIN_REQUESTED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
        if (this.isAdmin) {
            this.joinLibrary().subscribe((createdMembership) => {
                if (createdMembership.entry && createdMembership.entry.role) {
                    const info = {
                        shouldReload: true,
                        i18nKey: 'APP.MESSAGES.INFO.JOINED'
                    };
                    this.toggle.emit(info);
                }
            }, (error) => {
                const errWithMessage = {
                    error,
                    i18nKey: 'APP.MESSAGES.ERRORS.JOIN_REQUEST_FAILED'
                };
                const senderEmailCheck = 'Failed to resolve sender mail address';
                const receiverEmailCheck = 'All recipients for the mail action were invalid';
                if (error.message) {
                    if (error.message.includes(senderEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_SENDER_EMAIL';
                    }
                    else if (error.message.includes(receiverEmailCheck)) {
                        errWithMessage.i18nKey = 'APP.MESSAGES.ERRORS.INVALID_RECEIVER_EMAIL';
                    }
                }
                this.error.emit(errWithMessage);
            });
        }
    }
    markMembershipRequest() {
        if (!this.targetSite) {
            return;
        }
        this.getMembershipRequest().subscribe((data) => {
            if (data.entry.id === this.targetSite.id) {
                this.targetSite.joinRequested = true;
                this.isJoinRequested.next(true);
            }
        }, () => {
            this.targetSite.joinRequested = false;
            this.isJoinRequested.next(false);
        });
    }
    joinLibraryRequest() {
        const memberBody = {
            id: this.targetSite.id
        };
        if (this.versionCompatibilityService.isVersionSupported('7.0.0')) {
            memberBody.client = 'workspace';
        }
        return from(this.alfrescoApiService.peopleApi.addSiteMembershipRequest('-me-', memberBody));
    }
    joinLibrary() {
        return this.sitesService.createSiteMembership(this.targetSite.id, {
            role: 'SiteConsumer',
            id: '-me-'
        });
    }
    cancelJoinRequest() {
        return from(this.alfrescoApiService.peopleApi.removeSiteMembershipRequest('-me-', this.targetSite.id));
    }
    getMembershipRequest() {
        return from(this.alfrescoApiService.peopleApi.getSiteMembershipRequest('-me-', this.targetSite.id));
    }
}
LibraryMembershipDirective.ɵfac = function LibraryMembershipDirective_Factory(t) { return new (t || LibraryMembershipDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.SitesService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.VersionCompatibilityService)); };
LibraryMembershipDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: LibraryMembershipDirective, selectors: [["", "adf-library-membership", ""]], hostBindings: function LibraryMembershipDirective_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function LibraryMembershipDirective_click_HostBindingHandler() { return ctx.onClick(); });
    } }, inputs: { selection: ["adf-library-membership", "selection"], isAdmin: "isAdmin" }, outputs: { toggle: "toggle", error: "error" }, exportAs: ["libraryMembership"], features: [ɵngcc0.ɵɵNgOnChangesFeature] });
LibraryMembershipDirective.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SitesService },
    { type: VersionCompatibilityService }
];
LibraryMembershipDirective.propDecorators = {
    selection: [{ type: Input, args: ['adf-library-membership',] }],
    isAdmin: [{ type: Input }],
    toggle: [{ type: Output }],
    error: [{ type: Output }],
    onClick: [{ type: HostListener, args: ['click',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(LibraryMembershipDirective, [{
        type: Directive,
        args: [{
                selector: '[adf-library-membership]',
                exportAs: 'libraryMembership'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.SitesService }, { type: ɵngcc3.VersionCompatibilityService }]; }, { selection: [{
            type: Input,
            args: ['adf-library-membership']
        }], isAdmin: [{
            type: Input
        }], toggle: [{
            type: Output
        }], error: [{
            type: Output
        }], onClick: [{
            type: HostListener,
            args: ['click']
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS1tZW1iZXJzaGlwLmRpcmVjdGl2ZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvZGlyZWN0aXZlcy9saWJyYXJ5LW1lbWJlcnNoaXAuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFhLE1BQU0sRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFDL0csT0FBTyxFQUFFLFNBQVMsRUFBMEUsTUFBTSxrQkFBa0IsQ0FBQztBQUNySCxPQUFPLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7Ozs7O0FBaUJ4RixNQUFNLE9BQU8sMEJBQTBCO0FBQUcsSUF5QnRDLFlBQ1ksa0JBQXNDLEVBQ3RDLFlBQTBCLEVBQzFCLDJCQUF3RDtBQUNyRSxRQUhhLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFBQyxRQUN2QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUFDLFFBQzNCLGdDQUEyQixHQUEzQiwyQkFBMkIsQ0FBNkI7QUFDeEUsUUE1QkksZUFBVSxHQUFRLElBQUksQ0FBQztBQUMzQixRQUNJLG9CQUFlLEdBQTZCLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO0FBQ3BGLFFBR0ksY0FBUyxH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O0FBQ3ZCLFFBQVEsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFO0FBQzFFLFlBQVksSUFBSSxFQUFFLGNBQWM7QUFDaEMsWUFBWSxFQUFFLEVBQUUsTUFBTTtBQUN0QixTQUFTLENBQUMsQ0FBQztBQUNYLElBQUksQ0FBQztBQUNMLElBQ1ksaUJBQWlCO0FBQzdCLFFBQVEsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQywyQkFBMkIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQy9HLElBQUksQ0FBQztBQUNMLElBQ1ksb0JBQW9CO0FBQ2hDLFFBQVEsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzVHLElBQUksQ0FBQztBQUNMO3NEQWpNQyxTQUFTLFNBQUMsa0JBQ1AsUUFBUSxFQUFFLDBCQUEwQixrQkFDcEMsUUFBUSxFQUFFLG1CQUFtQixjQUNoQzs7O3dOQUNJO0FBQUM7QUFBb0QsWUFuQmpELGtCQUFrQjtBQUFJLFlBQ3RCLFlBQVk7QUFBSSxZQUNoQiwyQkFBMkI7QUFBRztBQUFHO0FBQThDLHdCQXVCbkYsS0FBSyxTQUFDLHdCQUF3QjtBQUM5QixzQkFHQSxLQUFLO0FBQ1IscUJBRUcsTUFBTTtBQUNULG9CQUdHLE1BQU07QUFDVCxzQkFFRyxZQUFZLFNBQUMsT0FBTztBQUNyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE9uQ2hhbmdlcywgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTaXRlRW50cnksIFNpdGVNZW1iZXJzaGlwUmVxdWVzdEJvZHksIFNpdGVNZW1iZXJFbnRyeSwgU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0RW50cnkgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2l0ZXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc2l0ZXMuc2VydmljZSc7XG5pbXBvcnQgeyBWZXJzaW9uQ29tcGF0aWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy92ZXJzaW9uLWNvbXBhdGliaWxpdHkuc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlicmFyeU1lbWJlcnNoaXBUb2dnbGVFdmVudCB7XG4gICAgdXBkYXRlZEVudHJ5PzogYW55O1xuICAgIHNob3VsZFJlbG9hZDogYm9vbGVhbjtcbiAgICBpMThuS2V5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGlicmFyeU1lbWJlcnNoaXBFcnJvckV2ZW50IHtcbiAgICBlcnJvcjogYW55O1xuICAgIGkxOG5LZXk6IHN0cmluZztcbn1cblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbYWRmLWxpYnJhcnktbWVtYmVyc2hpcF0nLFxuICAgIGV4cG9ydEFzOiAnbGlicmFyeU1lbWJlcnNoaXAnXG59KVxuZXhwb3J0IGNsYXNzIExpYnJhcnlNZW1iZXJzaGlwRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgICB0YXJnZXRTaXRlOiBhbnkgPSBudWxsO1xuXG4gICAgaXNKb2luUmVxdWVzdGVkOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcblxuICAgIC8qKiBTaXRlIGZvciB3aGljaCB0byB0b2dnbGUgdGhlIG1lbWJlcnNoaXAgcmVxdWVzdC4gKi9cbiAgICBASW5wdXQoJ2FkZi1saWJyYXJ5LW1lbWJlcnNoaXAnKVxuICAgIHNlbGVjdGlvbjogU2l0ZUVudHJ5ID0gbnVsbDtcblxuICAgIC8qKiBTaXRlIGZvciB3aGljaCB0byB0b2dnbGUgdGhlIG1lbWJlcnNoaXAgcmVxdWVzdC4gKi9cbiAgICBASW5wdXQoKVxuICAgIGlzQWRtaW4gPSBmYWxzZTtcblxuICAgIEBPdXRwdXQoKVxuICAgIHRvZ2dsZSA9IG5ldyBFdmVudEVtaXR0ZXI8TGlicmFyeU1lbWJlcnNoaXBUb2dnbGVFdmVudD4oKTtcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tb3V0cHV0LW5hdGl2ZVxuICAgIEBPdXRwdXQoKVxuICAgIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxMaWJyYXJ5TWVtYmVyc2hpcEVycm9yRXZlbnQ+KCk7XG5cbiAgICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gICAgb25DbGljaygpIHtcbiAgICAgICAgdGhpcy50b2dnbGVNZW1iZXJzaGlwUmVxdWVzdCgpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHNpdGVzU2VydmljZTogU2l0ZXNTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZTogVmVyc2lvbkNvbXBhdGliaWxpdHlTZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAoIWNoYW5nZXMuc2VsZWN0aW9uLmN1cnJlbnRWYWx1ZSB8fCAhY2hhbmdlcy5zZWxlY3Rpb24uY3VycmVudFZhbHVlLmVudHJ5KSB7XG4gICAgICAgICAgICB0aGlzLnRhcmdldFNpdGUgPSBudWxsO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50YXJnZXRTaXRlID0gY2hhbmdlcy5zZWxlY3Rpb24uY3VycmVudFZhbHVlLmVudHJ5O1xuICAgICAgICB0aGlzLm1hcmtNZW1iZXJzaGlwUmVxdWVzdCgpO1xuICAgIH1cblxuICAgIHRvZ2dsZU1lbWJlcnNoaXBSZXF1ZXN0KCkge1xuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0U2l0ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkKSB7XG4gICAgICAgICAgICB0aGlzLmNhbmNlbEpvaW5SZXF1ZXN0KCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRTaXRlLmpvaW5SZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0pvaW5SZXF1ZXN0ZWQubmV4dChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkRW50cnk6IHRoaXMudGFyZ2V0U2l0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFJlbG9hZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLklORk8uSk9JTl9DQU5DRUxFRCdcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdChpbmZvKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJXaXRoTWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSk9JTl9DQU5DRUxfRkFJTEVEJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoZXJyV2l0aE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0U2l0ZS5qb2luUmVxdWVzdGVkICYmICF0aGlzLmlzQWRtaW4pIHtcbiAgICAgICAgICAgIHRoaXMuam9pbkxpYnJhcnlSZXF1ZXN0KCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgIChjcmVhdGVkTWVtYmVyc2hpcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNKb2luUmVxdWVzdGVkLm5leHQodHJ1ZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0ZWRNZW1iZXJzaGlwLmVudHJ5ICYmIGNyZWF0ZWRNZW1iZXJzaGlwLmVudHJ5LnNpdGUgJiYgY3JlYXRlZE1lbWJlcnNoaXAuZW50cnkuc2l0ZS5yb2xlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFJlbG9hZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLklORk8uSk9JTkVEJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoaW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRFbnRyeTogdGhpcy50YXJnZXRTaXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFJlbG9hZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5JTkZPLkpPSU5fUkVRVUVTVEVEJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlLmVtaXQoaW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJXaXRoTWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgaTE4bktleTogJ0FQUC5NRVNTQUdFUy5FUlJPUlMuSk9JTl9SRVFVRVNUX0ZBSUxFRCdcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZW5kZXJFbWFpbENoZWNrID0gJ0ZhaWxlZCB0byByZXNvbHZlIHNlbmRlciBtYWlsIGFkZHJlc3MnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWNlaXZlckVtYWlsQ2hlY2sgPSAnQWxsIHJlY2lwaWVudHMgZm9yIHRoZSBtYWlsIGFjdGlvbiB3ZXJlIGludmFsaWQnO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhzZW5kZXJFbWFpbENoZWNrKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycldpdGhNZXNzYWdlLmkxOG5LZXkgPSAnQVBQLk1FU1NBR0VTLkVSUk9SUy5JTlZBTElEX1NFTkRFUl9FTUFJTCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMocmVjZWl2ZXJFbWFpbENoZWNrKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycldpdGhNZXNzYWdlLmkxOG5LZXkgPSAnQVBQLk1FU1NBR0VTLkVSUk9SUy5JTlZBTElEX1JFQ0VJVkVSX0VNQUlMJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChlcnJXaXRoTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmlzQWRtaW4pIHtcbiAgICAgICAgICAgIHRoaXMuam9pbkxpYnJhcnkoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKGNyZWF0ZWRNZW1iZXJzaGlwOiBTaXRlTWVtYmVyRW50cnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0ZWRNZW1iZXJzaGlwLmVudHJ5ICYmIGNyZWF0ZWRNZW1iZXJzaGlwLmVudHJ5LnJvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkUmVsb2FkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkxOG5LZXk6ICdBUFAuTUVTU0FHRVMuSU5GTy5KT0lORUQnXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGUuZW1pdChpbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycldpdGhNZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBpMThuS2V5OiAnQVBQLk1FU1NBR0VTLkVSUk9SUy5KT0lOX1JFUVVFU1RfRkFJTEVEJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbmRlckVtYWlsQ2hlY2sgPSAnRmFpbGVkIHRvIHJlc29sdmUgc2VuZGVyIG1haWwgYWRkcmVzcyc7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVyRW1haWxDaGVjayA9ICdBbGwgcmVjaXBpZW50cyBmb3IgdGhlIG1haWwgYWN0aW9uIHdlcmUgaW52YWxpZCc7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKHNlbmRlckVtYWlsQ2hlY2spKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyV2l0aE1lc3NhZ2UuaTE4bktleSA9ICdBUFAuTUVTU0FHRVMuRVJST1JTLklOVkFMSURfU0VOREVSX0VNQUlMJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhyZWNlaXZlckVtYWlsQ2hlY2spKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyV2l0aE1lc3NhZ2UuaTE4bktleSA9ICdBUFAuTUVTU0FHRVMuRVJST1JTLklOVkFMSURfUkVDRUlWRVJfRU1BSUwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGVycldpdGhNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbWFya01lbWJlcnNoaXBSZXF1ZXN0KCkge1xuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0U2l0ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXRNZW1iZXJzaGlwUmVxdWVzdCgpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZW50cnkuaWQgPT09IHRoaXMudGFyZ2V0U2l0ZS5pZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNKb2luUmVxdWVzdGVkLm5leHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldFNpdGUuam9pblJlcXVlc3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNKb2luUmVxdWVzdGVkLm5leHQoZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgam9pbkxpYnJhcnlSZXF1ZXN0KCk6IE9ic2VydmFibGU8U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0RW50cnk+IHtcbiAgICAgICAgY29uc3QgbWVtYmVyQm9keSA9IHtcbiAgICAgICAgICAgIGlkOiB0aGlzLnRhcmdldFNpdGUuaWRcbiAgICAgICAgfSBhcyBTaXRlTWVtYmVyc2hpcFJlcXVlc3RCb2R5O1xuXG4gICAgICAgIGlmICh0aGlzLnZlcnNpb25Db21wYXRpYmlsaXR5U2VydmljZS5pc1ZlcnNpb25TdXBwb3J0ZWQoJzcuMC4wJykpIHtcbiAgICAgICAgICAgIG1lbWJlckJvZHkuY2xpZW50ID0gJ3dvcmtzcGFjZSc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UucGVvcGxlQXBpLmFkZFNpdGVNZW1iZXJzaGlwUmVxdWVzdCgnLW1lLScsIG1lbWJlckJvZHkpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGpvaW5MaWJyYXJ5KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zaXRlc1NlcnZpY2UuY3JlYXRlU2l0ZU1lbWJlcnNoaXAodGhpcy50YXJnZXRTaXRlLmlkLCB7XG4gICAgICAgICAgICByb2xlOiAnU2l0ZUNvbnN1bWVyJyxcbiAgICAgICAgICAgIGlkOiAnLW1lLSdcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYW5jZWxKb2luUmVxdWVzdCgpIHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2UucGVvcGxlQXBpLnJlbW92ZVNpdGVNZW1iZXJzaGlwUmVxdWVzdCgnLW1lLScsIHRoaXMudGFyZ2V0U2l0ZS5pZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TWVtYmVyc2hpcFJlcXVlc3QoKSB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLnBlb3BsZUFwaS5nZXRTaXRlTWVtYmVyc2hpcFJlcXVlc3QoJy1tZS0nLCB0aGlzLnRhcmdldFNpdGUuaWQpKTtcbiAgICB9XG59XG4iXX0=
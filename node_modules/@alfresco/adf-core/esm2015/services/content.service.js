import { Injectable } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { Subject, from, throwError } from 'rxjs';
import { AlfrescoApiService } from './alfresco-api.service';
import { AuthenticationService } from './authentication.service';
import { LogService } from './log.service';
import { catchError } from 'rxjs/operators';
import { PermissionsEnum } from '../models/permissions.enum';
import { AllowableOperationsEnum } from '../models/allowable-operations.enum';
import { DownloadService } from './download.service';
import { ThumbnailService } from './thumbnail.service';
import * as i0 from "@angular/core";
import * as i1 from "./authentication.service";
import * as i2 from "./alfresco-api.service";
import * as i3 from "./log.service";
import * as i4 from "@angular/platform-browser";
import * as i5 from "./download.service";
import * as i6 from "./thumbnail.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './authentication.service';
import * as ɵngcc2 from './alfresco-api.service';
import * as ɵngcc3 from './log.service';
import * as ɵngcc4 from '@angular/platform-browser';
import * as ɵngcc5 from './download.service';
import * as ɵngcc6 from './thumbnail.service';
export class ContentService {
    constructor(authService, apiService, logService, sanitizer, downloadService, thumbnailService) {
        this.authService = authService;
        this.apiService = apiService;
        this.logService = logService;
        this.sanitizer = sanitizer;
        this.downloadService = downloadService;
        this.thumbnailService = thumbnailService;
        this.folderCreated = new Subject();
        this.folderCreate = new Subject();
        this.folderEdit = new Subject();
    }
    downloadBlob(blob, fileName) {
        this.downloadService.downloadBlob(blob, fileName);
    }
    downloadData(data, fileName) {
        this.downloadService.downloadData(data, fileName);
    }
    downloadJSON(json, fileName) {
        this.downloadService.downloadJSON(json, fileName);
    }
    createTrustedUrl(blob) {
        const url = window.URL.createObjectURL(blob);
        return this.sanitizer.bypassSecurityTrustUrl(url);
    }
    get contentApi() {
        return this.apiService.getInstance().content;
    }
    getDocumentThumbnailUrl(node, attachment, ticket) {
        return this.thumbnailService.getDocumentThumbnailUrl(node, attachment, ticket);
    }
    getContentUrl(node, attachment, ticket) {
        if (node) {
            let nodeId;
            if (typeof node === 'string') {
                nodeId = node;
            }
            else if (node.entry) {
                nodeId = node.entry.id;
            }
            return this.contentApi.getContentUrl(nodeId, attachment, ticket);
        }
        return null;
    }
    getNodeContent(nodeId) {
        return from(this.apiService.getInstance().core.nodesApi.getFileContent(nodeId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getNode(nodeId, opts) {
        return from(this.apiService.getInstance().nodes.getNode(nodeId, opts));
    }
    hasPermissions(node, permission, userId) {
        var _a, _b;
        let hasPermissions = false;
        userId = userId !== null && userId !== void 0 ? userId : this.authService.getEcmUsername();
        const permissions = [...(((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) || []), ...(((_b = node.permissions) === null || _b === void 0 ? void 0 : _b.inherited) || [])]
            .filter((currentPermission) => currentPermission.authorityId === userId);
        if (permissions.length) {
            if (permission && permission.startsWith('!')) {
                hasPermissions = permissions.find((currentPermission) => currentPermission.name === permission.replace('!', '')) ? false : true;
            }
            else {
                hasPermissions = permissions.find((currentPermission) => currentPermission.name === permission) ? true : false;
            }
        }
        else {
            if (permission === PermissionsEnum.CONSUMER) {
                hasPermissions = true;
            }
            else if (permission === PermissionsEnum.NOT_CONSUMER) {
                hasPermissions = false;
            }
            else if (permission && permission.startsWith('!')) {
                hasPermissions = true;
            }
        }
        return hasPermissions;
    }
    hasAllowableOperations(node, allowableOperation) {
        let hasAllowableOperations = false;
        if (node && node.allowableOperations) {
            if (allowableOperation && allowableOperation.startsWith('!')) {
                hasAllowableOperations = node.allowableOperations.find((currentOperation) => currentOperation === allowableOperation.replace('!', '')) ? false : true;
            }
            else {
                hasAllowableOperations = node.allowableOperations.find((currentOperation) => currentOperation === allowableOperation) ? true : false;
            }
        }
        else {
            if (allowableOperation && allowableOperation.startsWith('!')) {
                hasAllowableOperations = true;
            }
        }
        if (allowableOperation === AllowableOperationsEnum.COPY) {
            hasAllowableOperations = true;
        }
        if (allowableOperation === AllowableOperationsEnum.LOCK) {
            hasAllowableOperations = node.isFile;
            if (node.isLocked && node.allowableOperations) {
                hasAllowableOperations = !!~node.allowableOperations.indexOf('updatePermissions');
            }
        }
        return hasAllowableOperations;
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
ContentService.ɵfac = function ContentService_Factory(t) { return new (t || ContentService)(ɵngcc0.ɵɵinject(ɵngcc1.AuthenticationService), ɵngcc0.ɵɵinject(ɵngcc2.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc3.LogService), ɵngcc0.ɵɵinject(ɵngcc4.DomSanitizer), ɵngcc0.ɵɵinject(ɵngcc5.DownloadService), ɵngcc0.ɵɵinject(ɵngcc6.ThumbnailService)); };
ContentService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ContentService_Factory() { return new ContentService(i0.ɵɵinject(i1.AuthenticationService), i0.ɵɵinject(i2.AlfrescoApiService), i0.ɵɵinject(i3.LogService), i0.ɵɵinject(i4.DomSanitizer), i0.ɵɵinject(i5.DownloadService), i0.ɵɵinject(i6.ThumbnailService)); }, token: ContentService, providedIn: "root" });
ContentService.ctorParameters = () => [
    { type: AuthenticationService },
    { type: AlfrescoApiService },
    { type: LogService },
    { type: DomSanitizer },
    { type: DownloadService },
    { type: ThumbnailService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ContentService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AuthenticationService }, { type: ɵngcc2.AlfrescoApiService }, { type: ɵngcc3.LogService }, { type: ɵngcc4.DomSanitizer }, { type: ɵngcc5.DownloadService }, { type: ɵngcc6.ThumbnailService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29yZS9zZXJ2aWNlcy9jb250ZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBYyxPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUU3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDOUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZEO0FBRXNCO0FBSVQ7QUFBOEM7QUFDL0M7QUFBaUQ7QUFDM0I7Ozs7Ozs7O0FBSmxDLE1BQU0sT0FBTyxjQUFjO0FBQzNCLElBS0ksWUFBbUIsV0FBa0MsRUFDbEMsVUFBOEIsRUFDN0IsVUFBc0IsRUFDdEIsU0FBdUIsRUFDdkIsZUFBZ0MsRUFDaEMsZ0JBQWtDO0FBQzFELFFBTnVCLGdCQUFXLEdBQVgsV0FBVyxDQUF1QjtBQUFDLFFBQ25DLGVBQVUsR0FBVixVQUFVLENBQW9CO0FBQUMsUUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLFFBQ3ZCLGNBQVMsR0FBVCxTQUFTLENBQWM7QUFBQyxRQUN4QixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7QUFBQyxRQUNqQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFUdkQsa0JBQWEsR0FBZ0MsSUFBSSxPQUFPLEVBQXNCLENBQUM7QUFDbkYsUUFBSSxpQkFBWSxHQUF5QixJQUFJLE9BQU8sRUFBZSxDQUFDO0FBQ3BFLFFBQUksZUFBVSxHQUF5QixJQUFJLE9BQU8sRUFBZSxDQUFDO0FBQ2xFLElBT0ksQ0FBQztBQUNMLElBT0ksWUFBWSxDQUFDLElBQVUsRUFBRSxRQUFnQjtBQUFJLFFBQ3pDLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztBQUMxRCxJQUFJLENBQUM7QUFDTCxJQU9JLFlBQVksQ0FBQyxJQUFTLEVBQUUsUUFBZ0I7QUFBSSxRQUN4QyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDMUQsSUFBSSxDQUFDO0FBQ0wsSUFPSSxZQUFZLENBQUMsSUFBUyxFQUFFLFFBQWdCO0FBQUksUUFDeEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzFELElBQUksQ0FBQztBQUNMLElBT0ksZ0JBQWdCLENBQUMsSUFBVTtBQUFJLFFBQzNCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3JELFFBQVEsT0FBZ0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNuRSxJQUFJLENBQUM7QUFDTCxJQUNJLElBQVksVUFBVTtBQUFLLFFBQ3ZCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUM7QUFDckQsSUFBSSxDQUFDO0FBQ0wsSUFTSSx1QkFBdUIsQ0FBQyxJQUF3QixFQUFFLFVBQW9CLEVBQUUsTUFBZTtBQUFJLFFBQ3ZGLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdkYsSUFBSSxDQUFDO0FBQ0wsSUFRSSxhQUFhLENBQUMsSUFBd0IsRUFBRSxVQUFvQixFQUFFLE1BQWU7QUFBSSxRQUM3RSxJQUFJLElBQUksRUFBRTtBQUNsQixZQUFZLElBQUksTUFBYyxDQUFDO0FBQy9CLFlBQ1ksSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7QUFDMUMsZ0JBQWdCLE1BQU0sR0FBRyxJQUFJLENBQUM7QUFDOUIsYUFBYTtBQUFDLGlCQUFLLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtBQUNuQyxnQkFBZ0IsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO0FBQ3ZDLGFBQWE7QUFDYixZQUNZLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUM3RSxTQUFTO0FBQ1QsUUFDUSxPQUFPLElBQUksQ0FBQztBQUNwQixJQUFJLENBQUM7QUFDTCxJQU1JLGNBQWMsQ0FBQyxNQUFjO0FBQUksUUFDN0IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN2RixhQUFhLElBQUksQ0FDRCxVQUFVLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDbEQsQ0FBQztBQUNkLElBQUksQ0FBQztBQUNMLElBT0ksT0FBTyxDQUFDLE1BQWMsRUFBRSxJQUFVO0FBQUksUUFDbEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQy9FLElBQUksQ0FBQztBQUNMLElBUUksY0FBYyxDQUFDLElBQVUsRUFBRSxVQUFvQyxFQUFFLE1BQWU7QUFBSTtBQUM3RSxRQUFILElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQztBQUNuQyxRQUFRLE1BQU0sR0FBRyxNQUFNLGFBQU4sTUFBTSxjQUFOLE1BQU0sR0FBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQzdELFFBQ1EsTUFBTSxXQUFXLEdBQUcsQ0FBRSxHQUFHLENBQUMsT0FBQSxJQUFJLENBQUMsV0FBVywwQ0FBRSxVQUFVLEtBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLE9BQUEsSUFBSSxDQUFDLFdBQVcsMENBQUUsU0FBUyxLQUFJLEVBQUUsQ0FBQyxDQUFFO0FBQy9HLGFBQWMsTUFBTSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsS0FBSyxNQUFNLENBQUMsQ0FBQztBQUN0RixRQUFRLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtBQUNoQyxZQUFZLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDMUQsZ0JBQWdCLGNBQWMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUNoSixhQUFhO0FBQUMsaUJBQUs7QUFDbkIsZ0JBQWdCLGNBQWMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDL0gsYUFBYTtBQUNiLFNBQ1M7QUFBQyxhQUFLO0FBQ2YsWUFDWSxJQUFJLFVBQVUsS0FBSyxlQUFlLENBQUMsUUFBUSxFQUFFO0FBQ3pELGdCQUFnQixjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3RDLGFBQWE7QUFBQyxpQkFBSyxJQUFJLFVBQVUsS0FBSyxlQUFlLENBQUMsWUFBWSxFQUFFO0FBQ3BFLGdCQUFnQixjQUFjLEdBQUcsS0FBSyxDQUFDO0FBQ3ZDLGFBQWE7QUFBQyxpQkFBSyxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ2pFLGdCQUFnQixjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3RDLGFBQWE7QUFDYixTQUFTO0FBQ1QsUUFDUSxPQUFPLGNBQWMsQ0FBQztBQUM5QixJQUFJLENBQUM7QUFDTCxJQU9JLHNCQUFzQixDQUFDLElBQVUsRUFBRSxrQkFBb0Q7QUFBSSxRQUN2RixJQUFJLHNCQUFzQixHQUFHLEtBQUssQ0FBQztBQUMzQyxRQUNRLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtBQUM5QyxZQUFZLElBQUksa0JBQWtCLElBQUksa0JBQWtCLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQzFFLGdCQUFnQixzQkFBc0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixLQUFLLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDdEssYUFBYTtBQUFDLGlCQUFLO0FBQ25CLGdCQUFnQixzQkFBc0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLGdCQUFnQixLQUFLLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3JKLGFBQWE7QUFDYixTQUNTO0FBQUMsYUFBSztBQUNmLFlBQVksSUFBSSxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDMUUsZ0JBQWdCLHNCQUFzQixHQUFHLElBQUksQ0FBQztBQUM5QyxhQUFhO0FBQ2IsU0FBUztBQUNULFFBQ1EsSUFBSSxrQkFBa0IsS0FBSyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUU7QUFDakUsWUFBWSxzQkFBc0IsR0FBRyxJQUFJLENBQUM7QUFDMUMsU0FBUztBQUNULFFBQ1EsSUFBSSxrQkFBa0IsS0FBSyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUU7QUFDakUsWUFBWSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0FBQ2pELFlBQ1ksSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtBQUMzRCxnQkFBZ0Isc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ2xHLGFBQWE7QUFDYixTQUFTO0FBQ1QsUUFDUSxPQUFPLHNCQUFzQixDQUFDO0FBQ3RDLElBQUksQ0FBQztBQUNMLElBQ1ksV0FBVyxDQUFDLEtBQVU7QUFDbEMsUUFBUSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNyQyxRQUFRLE9BQU8sVUFBVSxDQUFDLEtBQUssSUFBSSxjQUFjLENBQUMsQ0FBQztBQUNuRCxJQUFJLENBQUM7QUFDTDt1VkFBQztBQUNELCtXQWhNSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtHLFlBYk4scUJBQXFCO0VBUzFCLFVBQVUsRUFBRSxNQUFNLHBCQVRZLFlBRHpCLGtCQUFrQjtBQVcxQixBQVg4QixZQUV0QixVQUFVO0FBQUksWUFOZCxZQUFZO0FBQUksWUFVaEIsZUFBZTtBQUFJLFlBQ25CLGdCQUFnQjtBQUFHOzs7Ozs7NFBBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgQ29udGVudEFwaSwgTWluaW1hbE5vZGUsIE5vZGUsIE5vZGVFbnRyeSB9IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZnJvbSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRm9sZGVyQ3JlYXRlZEV2ZW50IH0gZnJvbSAnLi4vZXZlbnRzL2ZvbGRlci1jcmVhdGVkLmV2ZW50JztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJy4vYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXV0aGVudGljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9hdXRoZW50aWNhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuL2xvZy5zZXJ2aWNlJztcbmltcG9ydCB7IGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uc0VudW0gfSBmcm9tICcuLi9tb2RlbHMvcGVybWlzc2lvbnMuZW51bSc7XG5pbXBvcnQgeyBBbGxvd2FibGVPcGVyYXRpb25zRW51bSB9IGZyb20gJy4uL21vZGVscy9hbGxvd2FibGUtb3BlcmF0aW9ucy5lbnVtJztcbmltcG9ydCB7IERvd25sb2FkU2VydmljZSB9IGZyb20gJy4vZG93bmxvYWQuc2VydmljZSc7XG5pbXBvcnQgeyBUaHVtYm5haWxTZXJ2aWNlIH0gZnJvbSAnLi90aHVtYm5haWwuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ29udGVudFNlcnZpY2Uge1xuXG4gICAgZm9sZGVyQ3JlYXRlZDogU3ViamVjdDxGb2xkZXJDcmVhdGVkRXZlbnQ+ID0gbmV3IFN1YmplY3Q8Rm9sZGVyQ3JlYXRlZEV2ZW50PigpO1xuICAgIGZvbGRlckNyZWF0ZTogU3ViamVjdDxNaW5pbWFsTm9kZT4gPSBuZXcgU3ViamVjdDxNaW5pbWFsTm9kZT4oKTtcbiAgICBmb2xkZXJFZGl0OiBTdWJqZWN0PE1pbmltYWxOb2RlPiA9IG5ldyBTdWJqZWN0PE1pbmltYWxOb2RlPigpO1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIGF1dGhTZXJ2aWNlOiBBdXRoZW50aWNhdGlvblNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHVibGljIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzYW5pdGl6ZXI6IERvbVNhbml0aXplcixcbiAgICAgICAgICAgICAgICBwcml2YXRlIGRvd25sb2FkU2VydmljZTogRG93bmxvYWRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGh1bWJuYWlsU2VydmljZTogVGh1bWJuYWlsU2VydmljZSkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIGluIDMuMi4wLCB1c2UgRG93bmxvYWRTZXJ2aWNlIGluc3RlYWQuXG4gICAgICogSW52b2tlcyBjb250ZW50IGRvd25sb2FkIGZvciBhIEJsb2Igd2l0aCBhIGZpbGUgbmFtZS5cbiAgICAgKiBAcGFyYW0gYmxvYiBDb250ZW50IHRvIGRvd25sb2FkLlxuICAgICAqIEBwYXJhbSBmaWxlTmFtZSBOYW1lIG9mIHRoZSByZXN1bHRpbmcgZmlsZS5cbiAgICAgKi9cbiAgICBkb3dubG9hZEJsb2IoYmxvYjogQmxvYiwgZmlsZU5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLmRvd25sb2FkU2VydmljZS5kb3dubG9hZEJsb2IoYmxvYiwgZmlsZU5hbWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIGluIDMuMi4wLCB1c2UgRG93bmxvYWRTZXJ2aWNlIGluc3RlYWQuXG4gICAgICogSW52b2tlcyBjb250ZW50IGRvd25sb2FkIGZvciBhIGRhdGEgYXJyYXkgd2l0aCBhIGZpbGUgbmFtZS5cbiAgICAgKiBAcGFyYW0gZGF0YSBEYXRhIHRvIGRvd25sb2FkLlxuICAgICAqIEBwYXJhbSBmaWxlTmFtZSBOYW1lIG9mIHRoZSByZXN1bHRpbmcgZmlsZS5cbiAgICAgKi9cbiAgICBkb3dubG9hZERhdGEoZGF0YTogYW55LCBmaWxlTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZG93bmxvYWRTZXJ2aWNlLmRvd25sb2FkRGF0YShkYXRhLCBmaWxlTmFtZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgaW4gMy4yLjAsIHVzZSBEb3dubG9hZFNlcnZpY2UgaW5zdGVhZC5cbiAgICAgKiBJbnZva2VzIGNvbnRlbnQgZG93bmxvYWQgZm9yIGEgSlNPTiBvYmplY3Qgd2l0aCBhIGZpbGUgbmFtZS5cbiAgICAgKiBAcGFyYW0ganNvbiBKU09OIG9iamVjdCB0byBkb3dubG9hZC5cbiAgICAgKiBAcGFyYW0gZmlsZU5hbWUgTmFtZSBvZiB0aGUgcmVzdWx0aW5nIGZpbGUuXG4gICAgICovXG4gICAgZG93bmxvYWRKU09OKGpzb246IGFueSwgZmlsZU5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLmRvd25sb2FkU2VydmljZS5kb3dubG9hZEpTT04oanNvbiwgZmlsZU5hbWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSB0cnVzdGVkIG9iamVjdCBVUkwgZnJvbSB0aGUgQmxvYi5cbiAgICAgKiBXQVJOSU5HOiBjYWxsaW5nIHRoaXMgbWV0aG9kIHdpdGggdW50cnVzdGVkIHVzZXIgZGF0YSBleHBvc2VzIHlvdXIgYXBwbGljYXRpb24gdG8gWFNTIHNlY3VyaXR5IHJpc2tzIVxuICAgICAqIEBwYXJhbSAgYmxvYiBEYXRhIHRvIHdyYXAgaW50byBvYmplY3QgVVJMXG4gICAgICogQHJldHVybnMgVVJMIHN0cmluZ1xuICAgICAqL1xuICAgIGNyZWF0ZVRydXN0ZWRVcmwoYmxvYjogQmxvYik6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICAgICAgICByZXR1cm4gPHN0cmluZz4gdGhpcy5zYW5pdGl6ZXIuYnlwYXNzU2VjdXJpdHlUcnVzdFVybCh1cmwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGNvbnRlbnRBcGkoKTogQ29udGVudEFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5jb250ZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXByZWNhdGVkIGluIDMuMi4wLCB1c2UgVGh1bWJuYWlsU2VydmljZSBpbnN0ZWFkLlxuICAgICAqIEdldHMgYSB0aHVtYm5haWwgVVJMIGZvciB0aGUgZ2l2ZW4gZG9jdW1lbnQgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBOb2RlIG9yIE5vZGUgSUQgdG8gZ2V0IFVSTCBmb3IuXG4gICAgICogQHBhcmFtIGF0dGFjaG1lbnQgVG9nZ2xlcyB3aGV0aGVyIHRvIHJldHJpZXZlIGNvbnRlbnQgYXMgYW4gYXR0YWNobWVudCBmb3IgZG93bmxvYWRcbiAgICAgKiBAcGFyYW0gdGlja2V0IEN1c3RvbSB0aWNrZXQgdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvblxuICAgICAqIEByZXR1cm5zIFVSTCBzdHJpbmdcbiAgICAgKi9cbiAgICBnZXREb2N1bWVudFRodW1ibmFpbFVybChub2RlOiBOb2RlRW50cnkgfCBzdHJpbmcsIGF0dGFjaG1lbnQ/OiBib29sZWFuLCB0aWNrZXQ/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy50aHVtYm5haWxTZXJ2aWNlLmdldERvY3VtZW50VGh1bWJuYWlsVXJsKG5vZGUsIGF0dGFjaG1lbnQsIHRpY2tldCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGNvbnRlbnQgVVJMIGZvciB0aGUgZ2l2ZW4gbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBOb2RlIG9yIE5vZGUgSUQgdG8gZ2V0IFVSTCBmb3IuXG4gICAgICogQHBhcmFtIGF0dGFjaG1lbnQgVG9nZ2xlcyB3aGV0aGVyIHRvIHJldHJpZXZlIGNvbnRlbnQgYXMgYW4gYXR0YWNobWVudCBmb3IgZG93bmxvYWRcbiAgICAgKiBAcGFyYW0gdGlja2V0IEN1c3RvbSB0aWNrZXQgdG8gdXNlIGZvciBhdXRoZW50aWNhdGlvblxuICAgICAqIEByZXR1cm5zIFVSTCBzdHJpbmcgb3IgYG51bGxgXG4gICAgICovXG4gICAgZ2V0Q29udGVudFVybChub2RlOiBOb2RlRW50cnkgfCBzdHJpbmcsIGF0dGFjaG1lbnQ/OiBib29sZWFuLCB0aWNrZXQ/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgbGV0IG5vZGVJZDogc3RyaW5nO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIG5vZGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgbm9kZUlkID0gbm9kZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5lbnRyeSkge1xuICAgICAgICAgICAgICAgIG5vZGVJZCA9IG5vZGUuZW50cnkuaWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRBcGkuZ2V0Q29udGVudFVybChub2RlSWQsIGF0dGFjaG1lbnQsIHRpY2tldCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGNvbnRlbnQgZm9yIHRoZSBnaXZlbiBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHJldHVybnMgQ29udGVudCBkYXRhXG4gICAgICovXG4gICAgZ2V0Tm9kZUNvbnRlbnQobm9kZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5jb3JlLm5vZGVzQXBpLmdldEZpbGVDb250ZW50KG5vZGVJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgTm9kZSB2aWEgaXRzIG5vZGUgSUQuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcGFyYW0gb3B0cyBPcHRpb25zIHN1cHBvcnRlZCBieSBKUy1BUElcbiAgICAgKiBAcmV0dXJucyBEZXRhaWxzIG9mIHRoZSBmb2xkZXJcbiAgICAgKi9cbiAgICBnZXROb2RlKG5vZGVJZDogc3RyaW5nLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxOb2RlRW50cnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCkubm9kZXMuZ2V0Tm9kZShub2RlSWQsIG9wdHMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIHVzZXIgaGFzIHBlcm1pc3Npb24gb24gdGhhdCBub2RlXG4gICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBjaGVjayBwZXJtaXNzaW9uc1xuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uIFJlcXVpcmVkIHBlcm1pc3Npb24gdHlwZVxuICAgICAqIEBwYXJhbSB1c2VySWQgT3B0aW9uYWwgY3VycmVudCB1c2VyIGlkIHdpbGwgYmUgdGFrZW4gYnkgZGVmYXVsdFxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIHVzZXIgaGFzIHRoZSByZXF1aXJlZCBwZXJtaXNzaW9ucywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaGFzUGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbjogUGVybWlzc2lvbnNFbnVtIHwgc3RyaW5nLCB1c2VySWQ/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc1Blcm1pc3Npb25zID0gZmFsc2U7XG4gICAgICAgIHVzZXJJZCA9IHVzZXJJZCA/PyB0aGlzLmF1dGhTZXJ2aWNlLmdldEVjbVVzZXJuYW1lKCk7XG5cbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSBbIC4uLihub2RlLnBlcm1pc3Npb25zPy5sb2NhbGx5U2V0IHx8IFtdKSwgLi4uKG5vZGUucGVybWlzc2lvbnM/LmluaGVyaXRlZCB8fCBbXSkgXVxuICAgICAgICAgICAgIC5maWx0ZXIoKGN1cnJlbnRQZXJtaXNzaW9uKSA9PiBjdXJyZW50UGVybWlzc2lvbi5hdXRob3JpdHlJZCA9PT0gdXNlcklkKTtcbiAgICAgICAgaWYgKHBlcm1pc3Npb25zLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKHBlcm1pc3Npb24gJiYgcGVybWlzc2lvbi5zdGFydHNXaXRoKCchJykpIHtcbiAgICAgICAgICAgICAgICBoYXNQZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zLmZpbmQoKGN1cnJlbnRQZXJtaXNzaW9uKSA9PiBjdXJyZW50UGVybWlzc2lvbi5uYW1lID09PSBwZXJtaXNzaW9uLnJlcGxhY2UoJyEnLCAnJykpID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoYXNQZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zLmZpbmQoKGN1cnJlbnRQZXJtaXNzaW9uKSA9PiBjdXJyZW50UGVybWlzc2lvbi5uYW1lID09PSBwZXJtaXNzaW9uKSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gUGVybWlzc2lvbnNFbnVtLkNPTlNVTUVSKSB7XG4gICAgICAgICAgICAgICAgaGFzUGVybWlzc2lvbnMgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uID09PSBQZXJtaXNzaW9uc0VudW0uTk9UX0NPTlNVTUVSKSB7XG4gICAgICAgICAgICAgICAgaGFzUGVybWlzc2lvbnMgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiAmJiBwZXJtaXNzaW9uLnN0YXJ0c1dpdGgoJyEnKSkge1xuICAgICAgICAgICAgICAgIGhhc1Blcm1pc3Npb25zID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgdGhlIHVzZXIgaGFzIHBlcm1pc3Npb25zIG9uIHRoYXQgbm9kZVxuICAgICAqIEBwYXJhbSBub2RlIE5vZGUgdG8gY2hlY2sgYWxsb3dhYmxlT3BlcmF0aW9uc1xuICAgICAqIEBwYXJhbSBhbGxvd2FibGVPcGVyYXRpb24gQ3JlYXRlLCBkZWxldGUsIHVwZGF0ZSwgdXBkYXRlUGVybWlzc2lvbnMsICFjcmVhdGUsICFkZWxldGUsICF1cGRhdGUsICF1cGRhdGVQZXJtaXNzaW9uc1xuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIHVzZXIgaGFzIHRoZSByZXF1aXJlZCBwZXJtaXNzaW9ucywgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyhub2RlOiBOb2RlLCBhbGxvd2FibGVPcGVyYXRpb246IEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtIHwgc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBoYXNBbGxvd2FibGVPcGVyYXRpb25zID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZS5hbGxvd2FibGVPcGVyYXRpb25zKSB7XG4gICAgICAgICAgICBpZiAoYWxsb3dhYmxlT3BlcmF0aW9uICYmIGFsbG93YWJsZU9wZXJhdGlvbi5zdGFydHNXaXRoKCchJykpIHtcbiAgICAgICAgICAgICAgICBoYXNBbGxvd2FibGVPcGVyYXRpb25zID0gbm9kZS5hbGxvd2FibGVPcGVyYXRpb25zLmZpbmQoKGN1cnJlbnRPcGVyYXRpb24pID0+IGN1cnJlbnRPcGVyYXRpb24gPT09IGFsbG93YWJsZU9wZXJhdGlvbi5yZXBsYWNlKCchJywgJycpKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyA9IG5vZGUuYWxsb3dhYmxlT3BlcmF0aW9ucy5maW5kKChjdXJyZW50T3BlcmF0aW9uKSA9PiBjdXJyZW50T3BlcmF0aW9uID09PSBhbGxvd2FibGVPcGVyYXRpb24pID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoYWxsb3dhYmxlT3BlcmF0aW9uICYmIGFsbG93YWJsZU9wZXJhdGlvbi5zdGFydHNXaXRoKCchJykpIHtcbiAgICAgICAgICAgICAgICBoYXNBbGxvd2FibGVPcGVyYXRpb25zID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhbGxvd2FibGVPcGVyYXRpb24gPT09IEFsbG93YWJsZU9wZXJhdGlvbnNFbnVtLkNPUFkpIHtcbiAgICAgICAgICAgIGhhc0FsbG93YWJsZU9wZXJhdGlvbnMgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFsbG93YWJsZU9wZXJhdGlvbiA9PT0gQWxsb3dhYmxlT3BlcmF0aW9uc0VudW0uTE9DSykge1xuICAgICAgICAgICAgaGFzQWxsb3dhYmxlT3BlcmF0aW9ucyA9IG5vZGUuaXNGaWxlO1xuXG4gICAgICAgICAgICBpZiAobm9kZS5pc0xvY2tlZCAmJiBub2RlLmFsbG93YWJsZU9wZXJhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBoYXNBbGxvd2FibGVPcGVyYXRpb25zID0gISF+bm9kZS5hbGxvd2FibGVPcGVyYXRpb25zLmluZGV4T2YoJ3VwZGF0ZVBlcm1pc3Npb25zJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaGFzQWxsb3dhYmxlT3BlcmF0aW9ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==
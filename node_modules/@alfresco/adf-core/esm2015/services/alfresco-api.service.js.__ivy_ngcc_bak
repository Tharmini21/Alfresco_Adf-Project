import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { GroupsApi, AlfrescoApiCompatibility, AlfrescoApiConfig, AspectsApi, TypesApi } from '@alfresco/js-api';
import { AppConfigService, AppConfigValues } from '../app-config/app-config.service';
import { Subject, ReplaySubject } from 'rxjs';
import { StorageService } from './storage.service';
import * as i0 from "@angular/core";
import * as i1 from "../app-config/app-config.service";
import * as i2 from "./storage.service";
export class AlfrescoApiService {
    constructor(appConfig, storageService) {
        this.appConfig = appConfig;
        this.storageService = storageService;
        this.nodeUpdated = new Subject();
        this.alfrescoApiInitialized = new ReplaySubject(1);
        this.excludedErrorUrl = ['api/enterprise/system/properties'];
    }
    getInstance() {
        return this.alfrescoApi;
    }
    get taskApi() {
        return this.getInstance().activiti.taskApi;
    }
    get contentApi() {
        return this.getInstance().content;
    }
    get nodesApi() {
        return this.getInstance().nodes;
    }
    get renditionsApi() {
        return this.getInstance().core.renditionsApi;
    }
    get sharedLinksApi() {
        return this.getInstance().core.sharedlinksApi;
    }
    get sitesApi() {
        return this.getInstance().core.sitesApi;
    }
    get favoritesApi() {
        return this.getInstance().core.favoritesApi;
    }
    get peopleApi() {
        return this.getInstance().core.peopleApi;
    }
    get searchApi() {
        return this.getInstance().search.searchApi;
    }
    get versionsApi() {
        return this.getInstance().core.versionsApi;
    }
    get classesApi() {
        return this.getInstance().core.classesApi;
    }
    get groupsApi() {
        return new GroupsApi(this.getInstance());
    }
    get aspectsApi() {
        return new AspectsApi(this.getInstance());
    }
    get typesApi() {
        return new TypesApi(this.getInstance());
    }
    load() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.appConfig.load().then(() => {
                this.storageService.prefix = this.appConfig.get(AppConfigValues.STORAGE_PREFIX, '');
                this.initAlfrescoApi();
                this.alfrescoApiInitialized.next(true);
            });
        });
    }
    reset() {
        this.initAlfrescoApi();
    }
    initAlfrescoApi() {
        const oauth = Object.assign({}, this.appConfig.get(AppConfigValues.OAUTHCONFIG, null));
        if (oauth) {
            oauth.redirectUri = window.location.origin + (oauth.redirectUri || '/');
            oauth.redirectUriLogout = window.location.origin + (oauth.redirectUriLogout || '/');
        }
        const config = new AlfrescoApiConfig({
            provider: this.appConfig.get(AppConfigValues.PROVIDERS),
            hostEcm: this.appConfig.get(AppConfigValues.ECMHOST),
            hostBpm: this.appConfig.get(AppConfigValues.BPMHOST),
            authType: this.appConfig.get(AppConfigValues.AUTHTYPE, 'BASIC'),
            contextRootBpm: this.appConfig.get(AppConfigValues.CONTEXTROOTBPM),
            contextRoot: this.appConfig.get(AppConfigValues.CONTEXTROOTECM),
            disableCsrf: this.appConfig.get(AppConfigValues.DISABLECSRF),
            withCredentials: this.appConfig.get(AppConfigValues.AUTH_WITH_CREDENTIALS, false),
            domainPrefix: this.appConfig.get(AppConfigValues.STORAGE_PREFIX),
            oauth2: oauth
        });
        if (this.alfrescoApi && this.isDifferentConfig(this.lastConfig, config)) {
            this.lastConfig = config;
            this.alfrescoApi.configureJsApi(config);
        }
        else {
            this.lastConfig = config;
            this.alfrescoApi = new AlfrescoApiCompatibility(config);
        }
    }
    isDifferentConfig(lastConfig, newConfig) {
        return JSON.stringify(lastConfig) !== JSON.stringify(newConfig);
    }
    isExcludedErrorListener(currentFullPath) {
        const formattedPath = currentFullPath.replace(this.lastConfig.hostBpm + '/' + this.lastConfig.contextRootBpm, '');
        return this.excludedErrorUrl.includes(formattedPath);
    }
}
AlfrescoApiService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AlfrescoApiService_Factory() { return new AlfrescoApiService(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i2.StorageService)); }, token: AlfrescoApiService, providedIn: "root" });
AlfrescoApiService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
AlfrescoApiService.ctorParameters = () => [
    { type: AppConfigService },
    { type: StorageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxmcmVzY28tYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb3JlLyIsInNvdXJjZXMiOlsic2VydmljZXMvYWxmcmVzY28tYXBpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWlCQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFNSCxTQUFTLEVBQ1Qsd0JBQXdCLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFDcEUsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDckYsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFOUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7O0FBT25ELE1BQU0sT0FBTyxrQkFBa0I7SUEwRTNCLFlBQ2MsU0FBMkIsRUFDM0IsY0FBOEI7UUFEOUIsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBeEU1QyxnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFFbEMsMkJBQXNCLEdBQTJCLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBTTlELHFCQUFnQixHQUFhLENBQUMsa0NBQWtDLENBQUMsQ0FBQztJQWlFMUUsQ0FBQztJQS9ERCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLE9BQU87UUFDUCxPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO0lBQy9DLENBQUM7SUFFRCxJQUFJLFVBQVU7UUFDVixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUs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LEVBQUUsU0FBNEI7UUFDekUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUVELHVCQUF1QixDQUFDLGVBQXVCO1FBQzNDLE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xILE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN6RCxDQUFDOzs7O1lBbklKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBVFEsZ0JBQWdCO1lBR2hCLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIENvbnRlbnRBcGksXG4gICAgQ29yZSxcbiAgICBBY3Rpdml0aSxcbiAgICBTZWFyY2hBcGksXG4gICAgTm9kZSxcbiAgICBHcm91cHNBcGksXG4gICAgQWxmcmVzY29BcGlDb21wYXRpYmlsaXR5LCBBbGZyZXNjb0FwaUNvbmZpZywgQXNwZWN0c0FwaSwgVHlwZXNBcGlcbn0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBBcHBDb25maWdTZXJ2aWNlLCBBcHBDb25maWdWYWx1ZXMgfSBmcm9tICcuLi9hcHAtY29uZmlnL2FwcC1jb25maWcuc2VydmljZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBPYXV0aENvbmZpZ01vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL29hdXRoLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vc3RvcmFnZS5zZXJ2aWNlJztcblxuLyogdHNsaW50OmRpc2FibGU6YWRmLWZpbGUtbmFtZSAqL1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEFsZnJlc2NvQXBpU2VydmljZSB7XG4gICAgLyoqXG4gICAgICogUHVibGlzaC9zdWJzY3JpYmUgdG8gZXZlbnRzIHJlbGF0ZWQgdG8gbm9kZSB1cGRhdGVzLlxuICAgICAqL1xuICAgIG5vZGVVcGRhdGVkID0gbmV3IFN1YmplY3Q8Tm9kZT4oKTtcblxuICAgIGFsZnJlc2NvQXBpSW5pdGlhbGl6ZWQ6IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgUmVwbGF5U3ViamVjdCgxKTtcblxuICAgIHByb3RlY3RlZCBhbGZyZXNjb0FwaTogQWxmcmVzY29BcGlDb21wYXRpYmlsaXR5O1xuXG4gICAgbGFzdENvbmZpZzogQWxmcmVzY29BcGlDb25maWc7XG5cbiAgICBwcml2YXRlIGV4Y2x1ZGVkRXJyb3JVcmw6IHN0cmluZ1tdID0gWydhcGkvZW50ZXJwcmlzZS9zeXN0ZW0vcHJvcGVydGllcyddO1xuXG4gICAgZ2V0SW5zdGFuY2UoKTogQWxmcmVzY29BcGlDb21wYXRpYmlsaXR5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGk7XG4gICAgfVxuXG4gICAgZ2V0IHRhc2tBcGkoKTogQWN0aXZpdGkuVGFza0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuYWN0aXZpdGkudGFza0FwaTtcbiAgICB9XG5cbiAgICBnZXQgY29udGVudEFwaSgpOiBDb250ZW50QXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5jb250ZW50O1xuICAgIH1cblxuICAgIGdldCBub2Rlc0FwaSgpOiBDb3JlLk5vZGVzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5ub2RlcztcbiAgICB9XG5cbiAgICBnZXQgcmVuZGl0aW9uc0FwaSgpOiBDb3JlLlJlbmRpdGlvbnNBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmNvcmUucmVuZGl0aW9uc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgc2hhcmVkTGlua3NBcGkoKTogQ29yZS5TaGFyZWRsaW5rc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29yZS5zaGFyZWRsaW5rc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgc2l0ZXNBcGkoKTogQ29yZS5TaXRlc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29yZS5zaXRlc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgZmF2b3JpdGVzQXBpKCk6IENvcmUuRmF2b3JpdGVzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5jb3JlLmZhdm9yaXRlc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgcGVvcGxlQXBpKCk6IENvcmUuUGVvcGxlQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5jb3JlLnBlb3BsZUFwaTtcbiAgICB9XG5cbiAgICBnZXQgc2VhcmNoQXBpKCk6IFNlYXJjaEFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuc2VhcmNoLnNlYXJjaEFwaTtcbiAgICB9XG5cbiAgICBnZXQgdmVyc2lvbnNBcGkoKTogQ29yZS5WZXJzaW9uc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29yZS52ZXJzaW9uc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgY2xhc3Nlc0FwaSgpOiBDb3JlLkNsYXNzZXNBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmNvcmUuY2xhc3Nlc0FwaTtcbiAgICB9XG5cbiAgICBnZXQgZ3JvdXBzQXBpKCk6IEdyb3Vwc0FwaSB7XG4gICAgICAgIHJldHVybiBuZXcgR3JvdXBzQXBpKHRoaXMuZ2V0SW5zdGFuY2UoKSk7XG4gICAgfVxuXG4gICAgZ2V0IGFzcGVjdHNBcGkoKTogQXNwZWN0c0FwaSB7XG4gICAgICAgIHJldHVybiBuZXcgQXNwZWN0c0FwaSh0aGlzLmdldEluc3RhbmNlKCkpO1xuICAgIH1cblxuICAgIGdldCB0eXBlc0FwaSgpOiBUeXBlc0FwaSB7XG4gICAgICAgIHJldHVybiBuZXcgVHlwZXNBcGkodGhpcy5nZXRJbnN0YW5jZSgpKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIGFwcENvbmZpZzogQXBwQ29uZmlnU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHN0b3JhZ2VTZXJ2aWNlOiBTdG9yYWdlU2VydmljZSkge1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWQoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwQ29uZmlnLmxvYWQoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc3RvcmFnZVNlcnZpY2UucHJlZml4ID0gdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLlNUT1JBR0VfUFJFRklYLCAnJyk7XG4gICAgICAgICAgICB0aGlzLmluaXRBbGZyZXNjb0FwaSgpO1xuICAgICAgICAgICAgdGhpcy5hbGZyZXNjb0FwaUluaXRpYWxpemVkLm5leHQodHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlc2V0KCkge1xuICAgICAgICB0aGlzLmluaXRBbGZyZXNjb0FwaSgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpbml0QWxmcmVzY29BcGkoKSB7XG4gICAgICAgIGNvbnN0IG9hdXRoOiBPYXV0aENvbmZpZ01vZGVsID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5hcHBDb25maWcuZ2V0PE9hdXRoQ29uZmlnTW9kZWw+KEFwcENvbmZpZ1ZhbHVlcy5PQVVUSENPTkZJRywgbnVsbCkpO1xuICAgICAgICBpZiAob2F1dGgpIHtcbiAgICAgICAgICAgIG9hdXRoLnJlZGlyZWN0VXJpID0gd2luZG93LmxvY2F0aW9uLm9yaWdpbiArIChvYXV0aC5yZWRpcmVjdFVyaSB8fCAnLycpO1xuICAgICAgICAgICAgb2F1dGgucmVkaXJlY3RVcmlMb2dvdXQgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgKG9hdXRoLnJlZGlyZWN0VXJpTG9nb3V0IHx8ICcvJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb25maWcgPSBuZXcgQWxmcmVzY29BcGlDb25maWcoe1xuICAgICAgICAgICAgcHJvdmlkZXI6IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5QUk9WSURFUlMpLFxuICAgICAgICAgICAgaG9zdEVjbTogdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLkVDTUhPU1QpLFxuICAgICAgICAgICAgaG9zdEJwbTogdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLkJQTUhPU1QpLFxuICAgICAgICAgICAgYXV0aFR5cGU6IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5BVVRIVFlQRSwgJ0JBU0lDJyksXG4gICAgICAgICAgICBjb250ZXh0Um9vdEJwbTogdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLkNPTlRFWFRST09UQlBNKSxcbiAgICAgICAgICAgIGNvbnRleHRSb290OiB0aGlzLmFwcENvbmZpZy5nZXQ8c3RyaW5nPihBcHBDb25maWdWYWx1ZXMuQ09OVEVYVFJPT1RFQ00pLFxuICAgICAgICAgICAgZGlzYWJsZUNzcmY6IHRoaXMuYXBwQ29uZmlnLmdldDxib29sZWFuPihBcHBDb25maWdWYWx1ZXMuRElTQUJMRUNTUkYpLFxuICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0aGlzLmFwcENvbmZpZy5nZXQ8Ym9vbGVhbj4oQXBwQ29uZmlnVmFsdWVzLkFVVEhfV0lUSF9DUkVERU5USUFMUywgZmFsc2UpLFxuICAgICAgICAgICAgZG9tYWluUHJlZml4IDogdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLlNUT1JBR0VfUFJFRklYKSxcbiAgICAgICAgICAgIG9hdXRoMjogb2F1dGhcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMuYWxmcmVzY29BcGkgJiYgdGhpcy5pc0RpZmZlcmVudENvbmZpZyh0aGlzLmxhc3RDb25maWcsIGNvbmZpZykpIHtcbiAgICAgICAgICAgIHRoaXMubGFzdENvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGkuY29uZmlndXJlSnNBcGkoY29uZmlnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubGFzdENvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGkgPSBuZXcgQWxmcmVzY29BcGlDb21wYXRpYmlsaXR5KGNvbmZpZyk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGlzRGlmZmVyZW50Q29uZmlnKGxhc3RDb25maWc6IEFsZnJlc2NvQXBpQ29uZmlnLCBuZXdDb25maWc6IEFsZnJlc2NvQXBpQ29uZmlnKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShsYXN0Q29uZmlnKSAhPT0gSlNPTi5zdHJpbmdpZnkobmV3Q29uZmlnKTtcbiAgICB9XG5cbiAgICBpc0V4Y2x1ZGVkRXJyb3JMaXN0ZW5lcihjdXJyZW50RnVsbFBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWRQYXRoID0gY3VycmVudEZ1bGxQYXRoLnJlcGxhY2UodGhpcy5sYXN0Q29uZmlnLmhvc3RCcG0gKyAnLycgKyB0aGlzLmxhc3RDb25maWcuY29udGV4dFJvb3RCcG0sICcnKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhjbHVkZWRFcnJvclVybC5pbmNsdWRlcyhmb3JtYXR0ZWRQYXRoKTtcbiAgICB9XG59XG4iXX0=
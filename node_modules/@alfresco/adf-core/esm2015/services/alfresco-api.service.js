import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { GroupsApi, AlfrescoApiCompatibility, AlfrescoApiConfig, AspectsApi, TypesApi } from '@alfresco/js-api';
import { AppConfigService, AppConfigValues } from '../app-config/app-config.service';
import { Subject, ReplaySubject } from 'rxjs';
import { StorageService } from './storage.service';
import * as i0 from "@angular/core";
import * as i1 from "../app-config/app-config.service";
import * as i2 from "./storage.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../app-config/app-config.service';
import * as ɵngcc2 from './storage.service';
export class AlfrescoApiService {
    constructor(appConfig, storageService) {
        this.appConfig = appConfig;
        this.storageService = storageService;
        this.nodeUpdated = new Subject();
        this.alfrescoApiInitialized = new ReplaySubject(1);
        this.excludedErrorUrl = ['api/enterprise/system/properties'];
    }
    getInstance() {
        return this.alfrescoApi;
    }
    get taskApi() {
        return this.getInstance().activiti.taskApi;
    }
    get contentApi() {
        return this.getInstance().content;
    }
    get nodesApi() {
        return this.getInstance().nodes;
    }
    get renditionsApi() {
        return this.getInstance().core.renditionsApi;
    }
    get sharedLinksApi() {
        return this.getInstance().core.sharedlinksApi;
    }
    get sitesApi() {
        return this.getInstance().core.sitesApi;
    }
    get favoritesApi() {
        return this.getInstance().core.favoritesApi;
    }
    get peopleApi() {
        return this.getInstance().core.peopleApi;
    }
    get searchApi() {
        return this.getInstance().search.searchApi;
    }
    get versionsApi() {
        return this.getInstance().core.versionsApi;
    }
    get classesApi() {
        return this.getInstance().core.classesApi;
    }
    get groupsApi() {
        return new GroupsApi(this.getInstance());
    }
    get aspectsApi() {
        return new AspectsApi(this.getInstance());
    }
    get typesApi() {
        return new TypesApi(this.getInstance());
    }
    load() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.appConfig.load().then(() => {
                this.storageService.prefix = this.appConfig.get(AppConfigValues.STORAGE_PREFIX, '');
                this.initAlfrescoApi();
                this.alfrescoApiInitialized.next(true);
            });
        });
    }
    reset() {
        this.initAlfrescoApi();
    }
    initAlfrescoApi() {
        const oauth = Object.assign({}, this.appConfig.get(AppConfigValues.OAUTHCONFIG, null));
        if (oauth) {
            oauth.redirectUri = window.location.origin + (oauth.redirectUri || '/');
            oauth.redirectUriLogout = window.location.origin + (oauth.redirectUriLogout || '/');
        }
        const config = new AlfrescoApiConfig({
            provider: this.appConfig.get(AppConfigValues.PROVIDERS),
            hostEcm: this.appConfig.get(AppConfigValues.ECMHOST),
            hostBpm: this.appConfig.get(AppConfigValues.BPMHOST),
            authType: this.appConfig.get(AppConfigValues.AUTHTYPE, 'BASIC'),
            contextRootBpm: this.appConfig.get(AppConfigValues.CONTEXTROOTBPM),
            contextRoot: this.appConfig.get(AppConfigValues.CONTEXTROOTECM),
            disableCsrf: this.appConfig.get(AppConfigValues.DISABLECSRF),
            withCredentials: this.appConfig.get(AppConfigValues.AUTH_WITH_CREDENTIALS, false),
            domainPrefix: this.appConfig.get(AppConfigValues.STORAGE_PREFIX),
            oauth2: oauth
        });
        if (this.alfrescoApi && this.isDifferentConfig(this.lastConfig, config)) {
            this.lastConfig = config;
            this.alfrescoApi.configureJsApi(config);
        }
        else {
            this.lastConfig = config;
            this.alfrescoApi = new AlfrescoApiCompatibility(config);
        }
    }
    isDifferentConfig(lastConfig, newConfig) {
        return JSON.stringify(lastConfig) !== JSON.stringify(newConfig);
    }
    isExcludedErrorListener(currentFullPath) {
        const formattedPath = currentFullPath.replace(this.lastConfig.hostBpm + '/' + this.lastConfig.contextRootBpm, '');
        return this.excludedErrorUrl.includes(formattedPath);
    }
}
AlfrescoApiService.ɵfac = function AlfrescoApiService_Factory(t) { return new (t || AlfrescoApiService)(ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc2.StorageService)); };
AlfrescoApiService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AlfrescoApiService_Factory() { return new AlfrescoApiService(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i2.StorageService)); }, token: AlfrescoApiService, providedIn: "root" });
AlfrescoApiService.ctorParameters = () => [
    { type: AppConfigService },
    { type: StorageService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AlfrescoApiService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AppConfigService }, { type: ɵngcc2.StorageService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxmcmVzY28tYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb3JlL3NlcnZpY2VzL2FsZnJlc2NvLWFwaS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBTUgsU0FBUyxFQUNULHdCQUF3QixFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQ3BFLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTlDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRDtBQUdBO0FBR2dCOzs7O0FBQWhCLE1BQU0sT0FBTyxrQkFBa0I7QUFDL0IsSUF5RUksWUFDYyxTQUEyQixFQUMzQixjQUE4QjtBQUNoRCxRQUZrQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtBQUFDLFFBQzVCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtBQUFDLFFBeEU3QyxnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7QUFDdEMsUUFDSSwyQkFBc0IsR0FBMkIsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUUsUUFLWSxxQkFBZ0IsR0FBYSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7QUFDOUUsSUFnRUksQ0FBQztBQUNMLElBaEVJLFdBQVc7QUFBSyxRQUNaLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztBQUNoQyxJQUFJLENBQUM7QUFDTCxJQUNJLElBQUksT0FBTztBQUFLLFFBQ1osT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztBQUNuRCxJQUFJLENBQUM7QUFDTCxJQUNJLElBQUksVUFBVTtBQUFLLFFBQ2YsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDO0FBQzFDLElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxRQUFRO0FBQUssUUFDYixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUM7QUFDeEMsSUFBSSxDQUFDO0FBQ0wsSUFDSSxJQUFJLGFBQWE7QUFBSyxRQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO0FBQ3JELElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxjQUFjO0FBQUssUUFDbkIsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztBQUN0RCxJQUFJLENBQUM7QUFDTCxJQUNJLElBQUksUUFBUTtBQUFLLFFBQ2IsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztBQUNoRCxJQUFJLENBQUM7QUFDTCxJQUNJLElBQUksWUFBWTtBQUFLLFFBQ2pCLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDcEQsSUFBSSxDQUFDO0FBQ0wsSUFDSSxJQUFJLFNBQVM7QUFBSyxRQUNkLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7QUFDakQsSUFBSSxDQUFDO0FBQ0wsSUFDSSxJQUFJLFNBQVM7QUFBSyxRQUNkLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7QUFDbkQsSUFBSSxDQUFDO0FBQ0wsSUFDSSxJQUFJLFdBQVc7QUFBSyxRQUNoQixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0FBQ25ELElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxVQUFVO0FBQUssUUFDZixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO0FBQ2xELElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxTQUFTO0FBQUssUUFDZCxPQUFPLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2pELElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxVQUFVO0FBQUssUUFDZixPQUFPLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2xELElBQUksQ0FBQztBQUNMLElBQ0ksSUFBSSxRQUFRO0FBQUssUUFDYixPQUFPLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2hELElBQUksQ0FBQztBQUNMLElBTVUsSUFBSTtBQUNkO0FBQ2EsWUFETCxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtBQUM5QyxnQkFBWSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ3hHLGdCQUFZLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztBQUNuQyxnQkFBWSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ25ELFlBQVEsQ0FBQyxDQUFDLENBQUM7QUFDWCxRQUFJLENBQUM7QUFFSixLQUZJO0FBQ0wsSUFDSSxLQUFLO0FBQ1QsUUFBUSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7QUFDL0IsSUFBSSxDQUFDO0FBQ0wsSUFDYyxlQUFlO0FBQzdCLFFBQVEsTUFBTSxLQUFLLEdBQXFCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFtQixlQUFlLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDbkksUUFBUSxJQUFJLEtBQUssRUFBRTtBQUNuQixZQUFZLEtBQUssQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBQ3BGLFlBQVksS0FBSyxDQUFDLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLGlCQUFpQixJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBQ2hHLFNBQVM7QUFDVCxRQUNRLE1BQU0sTUFBTSxHQUFHLElBQUksaUJBQWlCLENBQUM7QUFDN0MsWUFBWSxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQVMsZUFBZSxDQUFDLFNBQVMsQ0FBQztBQUMzRSxZQUFZLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUMsT0FBTyxDQUFDO0FBQ3hFLFlBQVksT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFTLGVBQWUsQ0FBQyxPQUFPLENBQUM7QUFDeEUsWUFBWSxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQVMsZUFBZSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUM7QUFDbkYsWUFBWSxjQUFjLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQVMsZUFBZSxDQUFDLGNBQWMsQ0FBQztBQUN0RixZQUFZLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUMsY0FBYyxDQUFDO0FBQ25GLFlBQVksV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFVLGVBQWUsQ0FBQyxXQUFXLENBQUM7QUFDakYsWUFBWSxlQUFlLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQVUsZUFBZSxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQztBQUN0RyxZQUFZLFlBQVksRUFBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBUyxlQUFlLENBQUMsY0FBYyxDQUFDO0FBQ3JGLFlBQVksTUFBTSxFQUFFLEtBQUs7QUFDekIsU0FBUyxDQUFDLENBQUM7QUFDWCxRQUNRLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsRUFBRTtBQUNqRixZQUFZLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO0FBQ3JDLFlBQVksSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEQsU0FBUztBQUFDLGFBQUs7QUFDZixZQUFZLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO0FBQ3JDLFlBQVksSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BFLFNBQVM7QUFDVCxJQUNJLENBQUM7QUFDTCxJQUNJLGlCQUFpQixDQUFDLFVBQTZCLEVBQUUsU0FBNEI7QUFDakYsUUFBUSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN4RSxJQUFJLENBQUM7QUFDTCxJQUNJLHVCQUF1QixDQUFDLGVBQXVCO0FBQUksUUFDL0MsTUFBTSxhQUFhLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUgsUUFBUSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDN0QsSUFBSSxDQUFDO0FBQ0w7NkxBQUM7QUFDRCx5UEFsSUs7QUFBQztFQUhMLFVBQVUsU0FBQyxyQkFLSixZQVpDLGdCQUFnQjtPQVFyQixVQUFVLEVBQUUsTUFBTSx6QkFSTyxZQUdwQixjQUFjO0FBQUc7T0FNekI7Ozs7O2tIQU4yQjtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBDb250ZW50QXBpLFxuICAgIENvcmUsXG4gICAgQWN0aXZpdGksXG4gICAgU2VhcmNoQXBpLFxuICAgIE5vZGUsXG4gICAgR3JvdXBzQXBpLFxuICAgIEFsZnJlc2NvQXBpQ29tcGF0aWJpbGl0eSwgQWxmcmVzY29BcGlDb25maWcsIEFzcGVjdHNBcGksIFR5cGVzQXBpXG59IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgQXBwQ29uZmlnU2VydmljZSwgQXBwQ29uZmlnVmFsdWVzIH0gZnJvbSAnLi4vYXBwLWNvbmZpZy9hcHAtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3ViamVjdCwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgT2F1dGhDb25maWdNb2RlbCB9IGZyb20gJy4uL21vZGVscy9vYXV0aC1jb25maWcubW9kZWwnO1xuaW1wb3J0IHsgU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL3N0b3JhZ2Uuc2VydmljZSc7XG5cbi8qIHRzbGludDpkaXNhYmxlOmFkZi1maWxlLW5hbWUgKi9cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBbGZyZXNjb0FwaVNlcnZpY2Uge1xuICAgIC8qKlxuICAgICAqIFB1Ymxpc2gvc3Vic2NyaWJlIHRvIGV2ZW50cyByZWxhdGVkIHRvIG5vZGUgdXBkYXRlcy5cbiAgICAgKi9cbiAgICBub2RlVXBkYXRlZCA9IG5ldyBTdWJqZWN0PE5vZGU+KCk7XG5cbiAgICBhbGZyZXNjb0FwaUluaXRpYWxpemVkOiBSZXBsYXlTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFJlcGxheVN1YmplY3QoMSk7XG5cbiAgICBwcm90ZWN0ZWQgYWxmcmVzY29BcGk6IEFsZnJlc2NvQXBpQ29tcGF0aWJpbGl0eTtcblxuICAgIGxhc3RDb25maWc6IEFsZnJlc2NvQXBpQ29uZmlnO1xuXG4gICAgcHJpdmF0ZSBleGNsdWRlZEVycm9yVXJsOiBzdHJpbmdbXSA9IFsnYXBpL2VudGVycHJpc2Uvc3lzdGVtL3Byb3BlcnRpZXMnXTtcblxuICAgIGdldEluc3RhbmNlKCk6IEFsZnJlc2NvQXBpQ29tcGF0aWJpbGl0eSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFsZnJlc2NvQXBpO1xuICAgIH1cblxuICAgIGdldCB0YXNrQXBpKCk6IEFjdGl2aXRpLlRhc2tBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmFjdGl2aXRpLnRhc2tBcGk7XG4gICAgfVxuXG4gICAgZ2V0IGNvbnRlbnRBcGkoKTogQ29udGVudEFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29udGVudDtcbiAgICB9XG5cbiAgICBnZXQgbm9kZXNBcGkoKTogQ29yZS5Ob2Rlc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkubm9kZXM7XG4gICAgfVxuXG4gICAgZ2V0IHJlbmRpdGlvbnNBcGkoKTogQ29yZS5SZW5kaXRpb25zQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5jb3JlLnJlbmRpdGlvbnNBcGk7XG4gICAgfVxuXG4gICAgZ2V0IHNoYXJlZExpbmtzQXBpKCk6IENvcmUuU2hhcmVkbGlua3NBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmNvcmUuc2hhcmVkbGlua3NBcGk7XG4gICAgfVxuXG4gICAgZ2V0IHNpdGVzQXBpKCk6IENvcmUuU2l0ZXNBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmNvcmUuc2l0ZXNBcGk7XG4gICAgfVxuXG4gICAgZ2V0IGZhdm9yaXRlc0FwaSgpOiBDb3JlLkZhdm9yaXRlc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29yZS5mYXZvcml0ZXNBcGk7XG4gICAgfVxuXG4gICAgZ2V0IHBlb3BsZUFwaSgpOiBDb3JlLlBlb3BsZUFwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEluc3RhbmNlKCkuY29yZS5wZW9wbGVBcGk7XG4gICAgfVxuXG4gICAgZ2V0IHNlYXJjaEFwaSgpOiBTZWFyY2hBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLnNlYXJjaC5zZWFyY2hBcGk7XG4gICAgfVxuXG4gICAgZ2V0IHZlcnNpb25zQXBpKCk6IENvcmUuVmVyc2lvbnNBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnN0YW5jZSgpLmNvcmUudmVyc2lvbnNBcGk7XG4gICAgfVxuXG4gICAgZ2V0IGNsYXNzZXNBcGkoKTogQ29yZS5DbGFzc2VzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5zdGFuY2UoKS5jb3JlLmNsYXNzZXNBcGk7XG4gICAgfVxuXG4gICAgZ2V0IGdyb3Vwc0FwaSgpOiBHcm91cHNBcGkge1xuICAgICAgICByZXR1cm4gbmV3IEdyb3Vwc0FwaSh0aGlzLmdldEluc3RhbmNlKCkpO1xuICAgIH1cblxuICAgIGdldCBhc3BlY3RzQXBpKCk6IEFzcGVjdHNBcGkge1xuICAgICAgICByZXR1cm4gbmV3IEFzcGVjdHNBcGkodGhpcy5nZXRJbnN0YW5jZSgpKTtcbiAgICB9XG5cbiAgICBnZXQgdHlwZXNBcGkoKTogVHlwZXNBcGkge1xuICAgICAgICByZXR1cm4gbmV3IFR5cGVzQXBpKHRoaXMuZ2V0SW5zdGFuY2UoKSk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBhcHBDb25maWc6IEFwcENvbmZpZ1NlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBzdG9yYWdlU2VydmljZTogU3RvcmFnZVNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICBhc3luYyBsb2FkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLmFwcENvbmZpZy5sb2FkKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLnByZWZpeCA9IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5TVE9SQUdFX1BSRUZJWCwgJycpO1xuICAgICAgICAgICAgdGhpcy5pbml0QWxmcmVzY29BcGkoKTtcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGlJbml0aWFsaXplZC5uZXh0KHRydWUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgdGhpcy5pbml0QWxmcmVzY29BcGkoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaW5pdEFsZnJlc2NvQXBpKCkge1xuICAgICAgICBjb25zdCBvYXV0aDogT2F1dGhDb25maWdNb2RlbCA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuYXBwQ29uZmlnLmdldDxPYXV0aENvbmZpZ01vZGVsPihBcHBDb25maWdWYWx1ZXMuT0FVVEhDT05GSUcsIG51bGwpKTtcbiAgICAgICAgaWYgKG9hdXRoKSB7XG4gICAgICAgICAgICBvYXV0aC5yZWRpcmVjdFVyaSA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyAob2F1dGgucmVkaXJlY3RVcmkgfHwgJy8nKTtcbiAgICAgICAgICAgIG9hdXRoLnJlZGlyZWN0VXJpTG9nb3V0ID0gd2luZG93LmxvY2F0aW9uLm9yaWdpbiArIChvYXV0aC5yZWRpcmVjdFVyaUxvZ291dCB8fCAnLycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29uZmlnID0gbmV3IEFsZnJlc2NvQXBpQ29uZmlnKHtcbiAgICAgICAgICAgIHByb3ZpZGVyOiB0aGlzLmFwcENvbmZpZy5nZXQ8c3RyaW5nPihBcHBDb25maWdWYWx1ZXMuUFJPVklERVJTKSxcbiAgICAgICAgICAgIGhvc3RFY206IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5FQ01IT1NUKSxcbiAgICAgICAgICAgIGhvc3RCcG06IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5CUE1IT1NUKSxcbiAgICAgICAgICAgIGF1dGhUeXBlOiB0aGlzLmFwcENvbmZpZy5nZXQ8c3RyaW5nPihBcHBDb25maWdWYWx1ZXMuQVVUSFRZUEUsICdCQVNJQycpLFxuICAgICAgICAgICAgY29udGV4dFJvb3RCcG06IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5DT05URVhUUk9PVEJQTSksXG4gICAgICAgICAgICBjb250ZXh0Um9vdDogdGhpcy5hcHBDb25maWcuZ2V0PHN0cmluZz4oQXBwQ29uZmlnVmFsdWVzLkNPTlRFWFRST09URUNNKSxcbiAgICAgICAgICAgIGRpc2FibGVDc3JmOiB0aGlzLmFwcENvbmZpZy5nZXQ8Ym9vbGVhbj4oQXBwQ29uZmlnVmFsdWVzLkRJU0FCTEVDU1JGKSxcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdGhpcy5hcHBDb25maWcuZ2V0PGJvb2xlYW4+KEFwcENvbmZpZ1ZhbHVlcy5BVVRIX1dJVEhfQ1JFREVOVElBTFMsIGZhbHNlKSxcbiAgICAgICAgICAgIGRvbWFpblByZWZpeCA6IHRoaXMuYXBwQ29uZmlnLmdldDxzdHJpbmc+KEFwcENvbmZpZ1ZhbHVlcy5TVE9SQUdFX1BSRUZJWCksXG4gICAgICAgICAgICBvYXV0aDI6IG9hdXRoXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLmFsZnJlc2NvQXBpICYmIHRoaXMuaXNEaWZmZXJlbnRDb25maWcodGhpcy5sYXN0Q29uZmlnLCBjb25maWcpKSB7XG4gICAgICAgICAgICB0aGlzLmxhc3RDb25maWcgPSBjb25maWc7XG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpLmNvbmZpZ3VyZUpzQXBpKGNvbmZpZyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxhc3RDb25maWcgPSBjb25maWc7XG4gICAgICAgICAgICB0aGlzLmFsZnJlc2NvQXBpID0gbmV3IEFsZnJlc2NvQXBpQ29tcGF0aWJpbGl0eShjb25maWcpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBpc0RpZmZlcmVudENvbmZpZyhsYXN0Q29uZmlnOiBBbGZyZXNjb0FwaUNvbmZpZywgbmV3Q29uZmlnOiBBbGZyZXNjb0FwaUNvbmZpZykge1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobGFzdENvbmZpZykgIT09IEpTT04uc3RyaW5naWZ5KG5ld0NvbmZpZyk7XG4gICAgfVxuXG4gICAgaXNFeGNsdWRlZEVycm9yTGlzdGVuZXIoY3VycmVudEZ1bGxQYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkUGF0aCA9IGN1cnJlbnRGdWxsUGF0aC5yZXBsYWNlKHRoaXMubGFzdENvbmZpZy5ob3N0QnBtICsgJy8nICsgdGhpcy5sYXN0Q29uZmlnLmNvbnRleHRSb290QnBtLCAnJyk7XG4gICAgICAgIHJldHVybiB0aGlzLmV4Y2x1ZGVkRXJyb3JVcmwuaW5jbHVkZXMoZm9ybWF0dGVkUGF0aCk7XG4gICAgfVxufVxuIl19
import { Injectable } from '@angular/core';
import { from, throwError } from 'rxjs';
import { AlfrescoApiService } from './alfresco-api.service';
import { SitesApi } from '@alfresco/js-api';
import { catchError } from 'rxjs/operators';
import { LogService } from './log.service';
import * as i0 from "@angular/core";
import * as i1 from "./alfresco-api.service";
import * as i2 from "./log.service";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './alfresco-api.service';
import * as ɵngcc2 from './log.service';
export class SitesService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
        this.sitesApi = new SitesApi(apiService.getInstance());
    }
    createSite(siteBody) {
        return from(this.sitesApi.createSite(siteBody))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSites(opts = {}) {
        const defaultOptions = {
            skipCount: 0,
            include: ['properties']
        };
        const queryOptions = Object.assign({}, defaultOptions, opts);
        return from(this.sitesApi.listSites(queryOptions))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSite(siteId, opts) {
        return from(this.sitesApi.getSite(siteId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSite(siteId, permanentFlag = true) {
        const options = {};
        options.permanent = permanentFlag;
        return from(this.sitesApi.deleteSite(siteId, options))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSiteContent(siteId) {
        return this.getSite(siteId, { relations: ['containers'] });
    }
    getSiteMembers(siteId) {
        return this.getSite(siteId, { relations: ['members'] });
    }
    listSiteMemberships(siteId, opts) {
        return from(this.sitesApi.listSiteMemberships(siteId, opts));
    }
    getEcmCurrentLoggedUserName() {
        return this.apiService.getInstance().getEcmUsername();
    }
    getSiteNameFromNodePath(node) {
        let siteName = '';
        if (node.path && node.path.elements) {
            const foundNode = node.path
                .elements.find((pathNode) => pathNode.nodeType === 'st:site' &&
                pathNode.name !== 'Sites');
            siteName = foundNode ? foundNode.name : '';
        }
        return siteName.toLocaleLowerCase();
    }
    getSiteMembershipRequests(opts) {
        return from(this.sitesApi.getSiteMembershipRequests(opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createSiteMembership(siteId, siteMembershipBodyCreate, opts) {
        return from(this.sitesApi.createSiteMembership(siteId, siteMembershipBodyCreate, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateSiteMembership(siteId, personId, siteMembershipBodyUpdate, opts) {
        return from(this.sitesApi.updateSiteMembership(siteId, personId, siteMembershipBodyUpdate, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSiteMembership(siteId, personId) {
        return from(this.sitesApi.deleteSiteMembership(siteId, personId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    approveSiteMembershipRequest(siteId, inviteeId, opts) {
        return from(this.sitesApi.approveSiteMembershipRequest(siteId, inviteeId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    rejectSiteMembershipRequest(siteId, inviteeId, opts) {
        return from(this.sitesApi.rejectSiteMembershipRequest(siteId, inviteeId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    listSiteGroups(siteId, opts) {
        return from(this.sitesApi.listSiteGroups(siteId, opts))
            .pipe(catchError((err) => this.handleError(err)));
    }
    createSiteGroupMembership(siteId, siteMembershipBodyCreate) {
        return from(this.sitesApi.createSiteGroupMembership(siteId, siteMembershipBodyCreate))
            .pipe(catchError((err) => this.handleError(err)));
    }
    getSiteGroupMembership(siteId, groupId) {
        return from(this.sitesApi.getSiteGroupMembership(siteId, groupId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    updateSiteGroupMembership(siteId, groupId, siteMembershipBodyUpdate) {
        return from(this.sitesApi.updateSiteGroupMembership(siteId, groupId, siteMembershipBodyUpdate))
            .pipe(catchError((err) => this.handleError(err)));
    }
    deleteSiteGroupMembership(siteId, groupId) {
        return from(this.sitesApi.deleteSiteGroupMembership(siteId, groupId))
            .pipe(catchError((err) => this.handleError(err)));
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
SitesService.ɵfac = function SitesService_Factory(t) { return new (t || SitesService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc2.LogService)); };
SitesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SitesService_Factory() { return new SitesService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i2.LogService)); }, token: SitesService, providedIn: "root" });
SitesService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SitesService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc2.LogService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZXMuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaG9tZS90cmF2aXMvYnVpbGQvQWxmcmVzY28vYWxmcmVzY28tbmcyLWNvbXBvbmVudHMvbGliL2NvcmUvc2VydmljZXMvc2l0ZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsSUFBSSxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBWUgsUUFBUSxFQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0M7QUFFc0I7QUFJVDs7OztBQUZiLE1BQU0sT0FBTyxZQUFZO0FBQ3pCLElBR0ksWUFBb0IsVUFBOEIsRUFBVSxVQUFzQjtBQUN0RixRQUR3QixlQUFVLEdBQVYsVUFBVSxDQUFvQjtBQUFDLFFBQVMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLFFBQy9FLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDL0QsSUFBSSxDQUFDO0FBQ0wsSUFNSSxVQUFVLENBQUMsUUFBd0I7QUFBSSxRQUNuQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2RCxhQUFhLElBQUksQ0FDRCxVQUFVLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDbEQsQ0FBQztBQUNkLElBQUksQ0FBQztBQUNM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TyxDQUFDLENBQUM7QUFDN0UsYUFBYSxJQUFJLENBQ0QsVUFBVSxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ2xELENBQUM7QUFDZCxJQUFJLENBQUM7QUFDTCxJQUNZLFdBQVcsQ0FBQyxLQUFVO0FBQUksUUFDOUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDckMsUUFBUSxPQUFPLFVBQVUsQ0FBQyxLQUFLLElBQUksY0FBYyxDQUFDLENBQUM7QUFDbkQsSUFBSSxDQUFDO0FBQ0w7eUtBQUM7QUFDRCwrTkFoUks7QUFBQztFQUhMLFVBQVUsU0FBQyxyQkFLRyxZQXZCTixrQkFBa0I7S0FtQnZCLFVBQVUsRUFBRSxNQUFNLHZCQW5CUyxZQWdCdEIsVUFBVTtBQUFHO1NBSXJCOzs7OztnSEFKdUI7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb20sIE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJy4vYWxmcmVzY28tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgICBNaW5pbWFsTm9kZSxcbiAgICBTaXRlQm9keUNyZWF0ZSxcbiAgICBTaXRlRW50cnksXG4gICAgU2l0ZUdyb3VwRW50cnksXG4gICAgU2l0ZUdyb3VwUGFnaW5nLFxuICAgIFNpdGVNZW1iZXJFbnRyeSxcbiAgICBTaXRlTWVtYmVyUGFnaW5nLFxuICAgIFNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSxcbiAgICBTaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGUsXG4gICAgU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0V2l0aFBlcnNvblBhZ2luZyxcbiAgICBTaXRlUGFnaW5nLFxuICAgIFNpdGVzQXBpXG59IGZyb20gJ0BhbGZyZXNjby9qcy1hcGknO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuL2xvZy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBTaXRlc1NlcnZpY2Uge1xuXG4gICAgc2l0ZXNBcGk6IFNpdGVzQXBpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSkge1xuICAgICAgICB0aGlzLnNpdGVzQXBpID0gbmV3IFNpdGVzQXBpKGFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgc2l0ZVxuICAgICAqIEBwYXJhbSBzaXRlQm9keSBTaXRlQm9keUNyZWF0ZSB0byBjcmVhdGUgc2l0ZVxuICAgICAqIEByZXR1cm5zIHNpdGUgU2l0ZUVudHJ5XG4gICAgICovXG4gICAgY3JlYXRlU2l0ZShzaXRlQm9keTogU2l0ZUJvZHlDcmVhdGUpOiBPYnNlcnZhYmxlPFNpdGVFbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmNyZWF0ZVNpdGUoc2l0ZUJvZHkpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGxpc3Qgb2YgYWxsIHNpdGVzIGluIHRoZSByZXBvc2l0b3J5LlxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2Ygc2l0ZXNcbiAgICAgKi9cbiAgICBnZXRTaXRlcyhvcHRzOiBhbnkgPSB7fSk6IE9ic2VydmFibGU8U2l0ZVBhZ2luZz4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHNraXBDb3VudDogMCxcbiAgICAgICAgICAgIGluY2x1ZGU6IFsncHJvcGVydGllcyddXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHF1ZXJ5T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRpb25zLCBvcHRzKTtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5saXN0U2l0ZXMocXVlcnlPcHRpb25zKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGRldGFpbHMgZm9yIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIElEIG9mIHRoZSB0YXJnZXQgc2l0ZVxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9uIGFib3V0IHRoZSBzaXRlXG4gICAgICovXG4gICAgZ2V0U2l0ZShzaXRlSWQ6IHN0cmluZywgb3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZUVudHJ5IHwge30+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5nZXRTaXRlKHNpdGVJZCwgb3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWxldGVzIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFNpdGUgdG8gZGVsZXRlXG4gICAgICogQHBhcmFtIHBlcm1hbmVudEZsYWcgVHJ1ZTogZGVsZXRpb24gaXMgcGVybWFuZW50OyBGYWxzZTogc2l0ZSBpcyBtb3ZlZCB0byB0aGUgdHJhc2hcbiAgICAgKiBAcmV0dXJucyBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBkZWxldGVTaXRlKHNpdGVJZDogc3RyaW5nLCBwZXJtYW5lbnRGbGFnOiBib29sZWFuID0gdHJ1ZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IGFueSA9IHt9O1xuICAgICAgICBvcHRpb25zLnBlcm1hbmVudCA9IHBlcm1hbmVudEZsYWc7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuZGVsZXRlU2l0ZShzaXRlSWQsIG9wdGlvbnMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIHNpdGUncyBjb250ZW50LlxuICAgICAqIEBwYXJhbSBzaXRlSWQgSUQgb2YgdGhlIHRhcmdldCBzaXRlXG4gICAgICogQHJldHVybnMgU2l0ZSBjb250ZW50XG4gICAgICovXG4gICAgZ2V0U2l0ZUNvbnRlbnQoc2l0ZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNpdGVFbnRyeSB8IHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFNpdGUoc2l0ZUlkLCB7IHJlbGF0aW9uczogWydjb250YWluZXJzJ10gfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGxpc3Qgb2YgYWxsIGEgc2l0ZSdzIG1lbWJlcnMuXG4gICAgICogQHBhcmFtIHNpdGVJZCBJRCBvZiB0aGUgdGFyZ2V0IHNpdGVcbiAgICAgKiBAcmV0dXJucyBTaXRlIG1lbWJlcnNcbiAgICAgKi9cbiAgICBnZXRTaXRlTWVtYmVycyhzaXRlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8U2l0ZUVudHJ5IHwge30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2l0ZShzaXRlSWQsIHsgcmVsYXRpb25zOiBbJ21lbWJlcnMnXSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiBhbGwgYSBzaXRlJ3MgbWVtYmVycy5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIElEIG9mIHRoZSB0YXJnZXQgc2l0ZVxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbmFsIHBhcmFtZXRlcnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGU8U2l0ZU1lbWJlclBhZ2luZz5cbiAgICAgKi9cbiAgICBsaXN0U2l0ZU1lbWJlcnNoaXBzKHNpdGVJZDogc3RyaW5nLCBvcHRzOiBhbnkpOiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJQYWdpbmc+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5saXN0U2l0ZU1lbWJlcnNoaXBzKHNpdGVJZCwgb3B0cykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHVzZXJuYW1lIG9mIHRoZSB1c2VyIGN1cnJlbnRseSBsb2dnZWQgaW50byBBQ1MuXG4gICAgICogQHJldHVybnMgVXNlcm5hbWUgc3RyaW5nXG4gICAgICovXG4gICAgZ2V0RWNtQ3VycmVudExvZ2dlZFVzZXJOYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5nZXRFY21Vc2VybmFtZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvb2tzIGZvciBhIHNpdGUgaW5zaWRlIHRoZSBwYXRoIG9mIGEgTm9kZSBhbmQgcmV0dXJucyBpdHMgZ3VpZCBpZiBpdCBmaW5kcyBvbmUuXG4gICAgICogKHJldHVybiBhbiBlbXB0eSBzdHJpbmcgaWYgbm8gc2l0ZSBpcyBmb3VuZClcbiAgICAgKiBAcGFyYW0gbm9kZSBOb2RlIHRvIGxvb2sgZm9yIHBhcmVudCBzaXRlXG4gICAgICogQHJldHVybnMgU2l0ZSBndWlkXG4gICAgICovXG4gICAgZ2V0U2l0ZU5hbWVGcm9tTm9kZVBhdGgobm9kZTogTWluaW1hbE5vZGUpOiBzdHJpbmcge1xuICAgICAgICBsZXQgc2l0ZU5hbWUgPSAnJztcbiAgICAgICAgaWYgKG5vZGUucGF0aCAmJiBub2RlLnBhdGguZWxlbWVudHMpIHtcbiAgICAgICAgICAgIGNvbnN0IGZvdW5kTm9kZSA9IG5vZGUucGF0aFxuICAgICAgICAgICAgICAgIC5lbGVtZW50cy5maW5kKChwYXRoTm9kZTogTWluaW1hbE5vZGUpID0+XG4gICAgICAgICAgICAgICAgICAgIHBhdGhOb2RlLm5vZGVUeXBlID09PSAnc3Q6c2l0ZScgJiZcbiAgICAgICAgICAgICAgICAgICAgcGF0aE5vZGUubmFtZSAhPT0gJ1NpdGVzJyk7XG4gICAgICAgICAgICBzaXRlTmFtZSA9IGZvdW5kTm9kZSA/IGZvdW5kTm9kZS5uYW1lIDogJyc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNpdGVOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhIGxpc3Qgb2Ygc2l0ZSBtZW1iZXJzaGlwIHJlcXVlc3RzLlxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zIFNpdGUgbWVtYmVyc2hpcCByZXF1ZXN0c1xuICAgICAqL1xuICAgIGdldFNpdGVNZW1iZXJzaGlwUmVxdWVzdHMob3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0V2l0aFBlcnNvblBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmdldFNpdGVNZW1iZXJzaGlwUmVxdWVzdHMob3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgc2l0ZSBtZW1iZXJzaGlwIGZvciBwZXJzb24gKipwZXJzb25JZCoqIG9uIHNpdGUgKipzaXRlSWQqKi5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZVxuICAgICAqIEBwYXJhbSBzaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGUgVGhlIHBlcnNvbiB0byBhZGQgYW5kIHRoZWlyIHJvbGVcbiAgICAgKiBAcGFyYW0gb3B0cyBPcHRpb25hbCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJFbnRyeT5cbiAgICAgKi9cbiAgICBjcmVhdGVTaXRlTWVtYmVyc2hpcChzaXRlSWQ6IHN0cmluZywgc2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlOiBTaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGUsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJFbnRyeT4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmNyZWF0ZVNpdGVNZW1iZXJzaGlwKHNpdGVJZCwgc2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlLCBvcHRzKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhIHNpdGUgbWVtYmVyc2hpcFxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBwZXJzb25JZCBUaGUgaWRlbnRpZmllciBvZiBhIHBlcnNvbi5cbiAgICAgKiBAcGFyYW0gc2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlIFRoZSBwZXJzb25zIG5ldyByb2xlXG4gICAgICogQHBhcmFtIG9wdHMgT3B0aW9uYWwgcGFyYW1ldGVyc1xuICAgICAqIEByZXR1cm4gT2JzZXJ2YWJsZTxTaXRlTWVtYmVyRW50cnk+XG4gICAgICovXG4gICAgdXBkYXRlU2l0ZU1lbWJlcnNoaXAoc2l0ZUlkOiBzdHJpbmcsIHBlcnNvbklkOiBzdHJpbmcsIHNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZTogU2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxTaXRlTWVtYmVyRW50cnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS51cGRhdGVTaXRlTWVtYmVyc2hpcChzaXRlSWQsIHBlcnNvbklkLCBzaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGUsIG9wdHMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVsZXRlIGEgc2l0ZSBtZW1iZXJzaGlwXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIHBlcnNvbklkIFRoZSBpZGVudGlmaWVyIG9mIGEgcGVyc29uLlxuICAgICAqIEByZXR1cm4gIE51bGwgcmVzcG9uc2Ugbm90aWZ5aW5nIHdoZW4gdGhlIG9wZXJhdGlvbiBpcyBjb21wbGV0ZVxuICAgICAqL1xuICAgIGRlbGV0ZVNpdGVNZW1iZXJzaGlwKHNpdGVJZDogc3RyaW5nLCBwZXJzb25JZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuZGVsZXRlU2l0ZU1lbWJlcnNoaXAoc2l0ZUlkLCBwZXJzb25JZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBY2NlcHQgc2l0ZSBtZW1iZXJzaGlwIHJlcXVlc3RzLlxuICAgICAqIEBwYXJhbSBzaXRlSWQgVGhlIGlkZW50aWZpZXIgb2YgYSBzaXRlLlxuICAgICAqIEBwYXJhbSBpbnZpdGVlSWQgVGhlIGludml0ZWUgdXNlciBuYW1lLlxuICAgICAqIEBwYXJhbSBvcHRzIE9wdGlvbnMgc3VwcG9ydGVkIGJ5IEpTLUFQSVxuICAgICAqIEByZXR1cm5zICBOdWxsIHJlc3BvbnNlIG5vdGlmeWluZyB3aGVuIHRoZSBvcGVyYXRpb24gaXMgY29tcGxldGVcbiAgICAgKi9cbiAgICBhcHByb3ZlU2l0ZU1lbWJlcnNoaXBSZXF1ZXN0KHNpdGVJZDogc3RyaW5nLCBpbnZpdGVlSWQ6IHN0cmluZywgb3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0V2l0aFBlcnNvblBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmFwcHJvdmVTaXRlTWVtYmVyc2hpcFJlcXVlc3Qoc2l0ZUlkLCBpbnZpdGVlSWQsIG9wdHMpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyOiBhbnkpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVqZWN0IHNpdGUgbWVtYmVyc2hpcCByZXF1ZXN0cy5cbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gaW52aXRlZUlkIFRoZSBpbnZpdGVlIHVzZXIgbmFtZS5cbiAgICAgKiBAcGFyYW0gb3B0cyBPcHRpb25zIHN1cHBvcnRlZCBieSBKUy1BUElcbiAgICAgKiBAcmV0dXJucyAgTnVsbCByZXNwb25zZSBub3RpZnlpbmcgd2hlbiB0aGUgb3BlcmF0aW9uIGlzIGNvbXBsZXRlXG4gICAgICovXG4gICAgcmVqZWN0U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0KHNpdGVJZDogc3RyaW5nLCBpbnZpdGVlSWQ6IHN0cmluZywgb3B0cz86IGFueSk6IE9ic2VydmFibGU8U2l0ZU1lbWJlcnNoaXBSZXF1ZXN0V2l0aFBlcnNvblBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLnJlamVjdFNpdGVNZW1iZXJzaGlwUmVxdWVzdChzaXRlSWQsIGludml0ZWVJZCwgb3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0IGdyb3VwIG1lbWJlcnNoaXAgZm9yIHNpdGVcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gb3B0cyBPcHRpb25zIHN1cHBvcnRlZCBieSBKUy1BUElcbiAgICAgKiBAcmV0dXJucyAgT2JzZXJ2YWJsZTxTaXRlR3JvdXBQYWdpbmc+XG4gICAgICovXG4gICAgbGlzdFNpdGVHcm91cHMoc2l0ZUlkOiBzdHJpbmcsIG9wdHM/OiBhbnkpOiBPYnNlcnZhYmxlPFNpdGVHcm91cFBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLnNpdGVzQXBpLmxpc3RTaXRlR3JvdXBzKHNpdGVJZCwgb3B0cykpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBzaXRlIG1lbWJlcnNoaXAgZm9yIGdyb3VwXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIHNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSBUaGUgR3JvdXAgdG8gYWRkIGFuZCBpdHMgcm9sZVxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+XG4gICAgICovXG4gICAgY3JlYXRlU2l0ZUdyb3VwTWVtYmVyc2hpcChzaXRlSWQ6IHN0cmluZywgc2l0ZU1lbWJlcnNoaXBCb2R5Q3JlYXRlOiBTaXRlTWVtYmVyc2hpcEJvZHlDcmVhdGUpOiBPYnNlcnZhYmxlPFNpdGVHcm91cEVudHJ5PiB7XG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2l0ZXNBcGkuY3JlYXRlU2l0ZUdyb3VwTWVtYmVyc2hpcChzaXRlSWQsIHNpdGVNZW1iZXJzaGlwQm9keUNyZWF0ZSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgaW5mb3JtYXRpb24gYWJvdXQgc2l0ZSBtZW1iZXJzaGlwIG9mIGdyb3VwXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgVGhlIGF1dGhvcml0eUlkIG9mIGEgZ3JvdXAuXG4gICAgICogQHJldHVybiBPYnNlcnZhYmxlPFNpdGVHcm91cEVudHJ5PlxuICAgICAqL1xuICAgIGdldFNpdGVHcm91cE1lbWJlcnNoaXAoc2l0ZUlkOiBzdHJpbmcsIGdyb3VwSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5nZXRTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZCwgZ3JvdXBJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgc2l0ZSBtZW1iZXJzaGlwIG9mIGdyb3VwXG4gICAgICogQHBhcmFtIHNpdGVJZCBUaGUgaWRlbnRpZmllciBvZiBhIHNpdGUuXG4gICAgICogQHBhcmFtIGdyb3VwSWQgVGhlIGF1dGhvcml0eUlkIG9mIGEgZ3JvdXAuXG4gICAgICogQHBhcmFtIHNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZSBUaGUgZ3JvdXAgbmV3IHJvbGVcbiAgICAgKiBAcmV0dXJuIE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+XG4gICAgICovXG4gICAgdXBkYXRlU2l0ZUdyb3VwTWVtYmVyc2hpcChzaXRlSWQ6IHN0cmluZywgZ3JvdXBJZDogc3RyaW5nLCBzaXRlTWVtYmVyc2hpcEJvZHlVcGRhdGU6IFNpdGVNZW1iZXJzaGlwQm9keVVwZGF0ZSk6IE9ic2VydmFibGU8U2l0ZUdyb3VwRW50cnk+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS51cGRhdGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZCwgZ3JvdXBJZCwgc2l0ZU1lbWJlcnNoaXBCb2R5VXBkYXRlKSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlbGV0ZSBhIGdyb3VwIG1lbWJlcnNoaXAgZm9yIHNpdGVcbiAgICAgKiBAcGFyYW0gc2l0ZUlkIFRoZSBpZGVudGlmaWVyIG9mIGEgc2l0ZS5cbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBUaGUgYXV0aG9yaXR5SWQgb2YgYSBncm91cC5cbiAgICAgKiBAcmV0dXJuIE9ic2VydmFibGU8dm9pZD5cbiAgICAgKi9cbiAgICBkZWxldGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZDogc3RyaW5nLCBncm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGZyb20odGhpcy5zaXRlc0FwaS5kZWxldGVTaXRlR3JvdXBNZW1iZXJzaGlwKHNpdGVJZCwgZ3JvdXBJZCkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnI6IGFueSkgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpOiBPYnNlcnZhYmxlPG5ldmVyPiB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihlcnJvcik7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yIHx8ICdTZXJ2ZXIgZXJyb3InKTtcbiAgICB9XG59XG4iXX0=
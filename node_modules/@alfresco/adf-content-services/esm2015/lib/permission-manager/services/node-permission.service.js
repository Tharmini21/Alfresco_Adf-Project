import { AlfrescoApiService, NodesApiService, SearchService, TranslationService, EcmUserModel } from '@alfresco/adf-core';
import { Group } from '@alfresco/js-api';
import { Injectable } from '@angular/core';
import { forkJoin, from, of, throwError } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { PermissionDisplayModel } from '../models/permission.model';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class NodePermissionService {
    constructor(apiService, searchApiService, nodeService, translation) {
        this.apiService = apiService;
        this.searchApiService = searchApiService;
        this.nodeService = nodeService;
        this.translation = translation;
    }
    getNodeRoles(node) {
        const retrieveSiteQueryBody = this.buildRetrieveSiteQueryBody(node.path.elements);
        return this.searchApiService.searchByQueryBody(retrieveSiteQueryBody)
            .pipe(switchMap((siteNodeList) => {
            var _a;
            if (siteNodeList.list.entries.length > 0) {
                const siteName = siteNodeList.list.entries[0].entry.name;
                return this.getGroupMembersBySiteName(siteName);
            }
            else {
                return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable);
            }
        }));
    }
    getNodePermissions(node) {
        var _a, _b;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.map((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        if ((_b = node === null || node === void 0 ? void 0 : node.permissions) === null || _b === void 0 ? void 0 : _b.inherited) {
            node.permissions.inherited.map((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    updatePermissionRole(node, updatedPermissionRole) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(updatedPermissionRole.authorityId);
        permissionBody.permissions.locallySet = permissionBody.permissions.locallySet.concat(node.permissions.locallySet);
        if (index !== -1) {
            permissionBody.permissions.locallySet[index] = updatedPermissionRole;
        }
        else {
            permissionBody.permissions.locallySet.push(updatedPermissionRole);
        }
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updateNodePermissions(nodeId, permissionList) {
        return this.nodeService.getNode(nodeId).pipe(switchMap((node) => this.updateLocallySetPermissions(node, permissionList)));
    }
    updateLocallySetPermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        const permissionList = permissions;
        const duplicatedPermissions = this.getDuplicatedPermissions(node.permissions.locallySet, permissionList);
        if (duplicatedPermissions.length > 0) {
            const list = duplicatedPermissions.map((permission) => 'authority -> ' + permission.authorityId + ' / role -> ' + permission.name).join(', ');
            const duplicatePermissionMessage = this.translation.instant('PERMISSION_MANAGER.ERROR.DUPLICATE-PERMISSION', { list });
            return throwError(duplicatePermissionMessage);
        }
        permissionBody.permissions.locallySet = node.permissions.locallySet ? node.permissions.locallySet.concat(permissionList) : permissionList;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getDuplicatedPermissions(nodeLocallySet, permissionListAdded) {
        const duplicatePermissions = [];
        if (nodeLocallySet) {
            permissionListAdded.forEach((permission) => {
                const duplicate = nodeLocallySet.find((localPermission) => this.isEqualPermission(localPermission, permission));
                if (duplicate) {
                    duplicatePermissions.push(duplicate);
                }
            });
        }
        return duplicatePermissions;
    }
    isEqualPermission(oldPermission, newPermission) {
        return oldPermission.accessStatus === newPermission.accessStatus &&
            oldPermission.authorityId === newPermission.authorityId &&
            oldPermission.name === newPermission.name;
    }
    removePermission(node, permissionToRemove) {
        const permissionBody = { permissions: { locallySet: [] } };
        const index = node.permissions.locallySet.map((permission) => permission.authorityId).indexOf(permissionToRemove.authorityId);
        if (index !== -1) {
            node.permissions.locallySet.splice(index, 1);
            permissionBody.permissions.locallySet = node.permissions.locallySet;
            return this.nodeService.updateNode(node.id, permissionBody);
        }
        else {
            return of(node);
        }
    }
    getGroupMembersBySiteName(siteName) {
        const groupName = 'GROUP_site_' + siteName;
        return this.getGroupMemberByGroupName(groupName)
            .pipe(map((groupMemberPaging) => {
            const displayResult = [];
            groupMemberPaging.list.entries.forEach((member) => {
                displayResult.push(this.formattedRoleName(member.entry.displayName, 'site_' + siteName));
            });
            return displayResult;
        }));
    }
    getGroupMemberByGroupName(groupName, opts) {
        return from(this.apiService.groupsApi.listGroupMemberships(groupName, opts));
    }
    formattedRoleName(displayName, siteName) {
        return displayName.replace(siteName + '_', '');
    }
    buildRetrieveSiteQueryBody(nodePath) {
        const pathNames = nodePath.map((node) => 'name: "' + node.name + '"');
        const builtPathNames = pathNames.join(' OR ');
        return {
            'query': {
                'query': builtPathNames
            },
            'paging': {
                'maxItems': 100,
                'skipCount': 0
            },
            'include': ['aspectNames', 'properties'],
            'filterQueries': [
                {
                    'query': "TYPE:'st:site'"
                }
            ]
        };
    }
    getLocalPermissions(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.locallySet) {
            node.permissions.locallySet.forEach((permissionElement) => {
                result.push(new PermissionDisplayModel(permissionElement));
            });
        }
        return result;
    }
    getInheritedPermission(node) {
        var _a;
        const result = [];
        if ((_a = node === null || node === void 0 ? void 0 : node.permissions) === null || _a === void 0 ? void 0 : _a.inherited) {
            node.permissions.inherited.forEach((permissionElement) => {
                const permissionInherited = new PermissionDisplayModel(permissionElement);
                permissionInherited.isInherited = true;
                result.push(permissionInherited);
            });
        }
        return result;
    }
    removePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissions.forEach((permission) => {
            const index = node.permissions.locallySet.findIndex((locallySet) => locallySet.authorityId === permission.authorityId);
            if (index !== -1) {
                node.permissions.locallySet.splice(index, 1);
            }
        });
        permissionBody.permissions.locallySet = node.permissions.locallySet;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    updatePermissions(node, permissions) {
        const permissionBody = { permissions: { locallySet: [] } };
        permissionBody.permissions.locallySet = permissions;
        return this.nodeService.updateNode(node.id, permissionBody);
    }
    getNodeWithRoles(nodeId) {
        return this.nodeService.getNode(nodeId).pipe(switchMap(node => {
            return forkJoin({
                node: of(node),
                roles: this.getNodeRoles(node)
                    .pipe(catchError(() => { var _a; return of((_a = node.permissions) === null || _a === void 0 ? void 0 : _a.settable); }), map(_roles => _roles.map(role => ({ role, label: role }))))
            });
        }));
    }
    transformNodeToUserPerson(node) {
        let person = null, group = null;
        if (node.nodeType === 'cm:person') {
            const firstName = node.properties['cm:firstName'];
            const lastName = node.properties['cm:lastName'];
            const email = node.properties['cm:email'];
            const id = node.properties['cm:userName'];
            person = new EcmUserModel({ id, firstName, lastName, email });
        }
        if (node.nodeType === 'cm:authorityContainer') {
            const displayName = node.properties['cm:authorityDisplayName'] || node.properties['cm:authorityName'];
            const id = node.properties['cm:authorityName'];
            group = new Group({ displayName, id });
        }
        return { person, group };
    }
}
NodePermissionService.ɵfac = function NodePermissionService_Factory(t) { return new (t || NodePermissionService)(ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService), ɵngcc0.ɵɵinject(ɵngcc1.SearchService), ɵngcc0.ɵɵinject(ɵngcc1.NodesApiService), ɵngcc0.ɵɵinject(ɵngcc1.TranslationService)); };
NodePermissionService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NodePermissionService_Factory() { return new NodePermissionService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.SearchService), i0.ɵɵinject(i1.NodesApiService), i0.ɵɵinject(i1.TranslationService)); }, token: NodePermissionService, providedIn: "root" });
NodePermissionService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: SearchService },
    { type: NodesApiService },
    { type: TranslationService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NodePermissionService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AlfrescoApiService }, { type: ɵngcc1.SearchService }, { type: ɵngcc1.NodesApiService }, { type: ɵngcc1.TranslationService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wZXJtaXNzaW9uLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvcGVybWlzc2lvbi1tYW5hZ2VyL3NlcnZpY2VzL25vZGUtcGVybWlzc2lvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlCQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxrQkFBa0IsRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxSCxPQUFPLEVBQUUsS0FBSyxFQUF3RixNQUFNLGtCQUFrQixDQUFDO0FBQy9ILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRTtBQUFxQzs7O0FBS3JDLE1BQU0sT0FBTyxxQkFBcUI7QUFDbEMsSUFDSSxZQUFvQixVQUE4QixFQUM5QixnQkFBK0IsRUFDL0IsV0FBNEIsRUFDNUIsV0FBK0I7QUFDdkQsUUFKd0IsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7QUFBQyxRQUMvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWU7QUFBQyxRQUNoQyxnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7QUFBQyxRQUM3QixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7QUFBQyxJQUNwRCxDQUFDO0FBQ0wsSUFNSSxZQUFZLENBQUMsSUFBVTtBQUFJLFFBQ3ZCLE1BQU0scUJBQXFC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O0FBQzlELFlBQWEsTUFBTSxLQUFLLEdBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUN4RCxZQUFhLE1BQU0sRUFBRSxHQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDeEQsWUFBYSxNQUFNLEdBQUcsSUFBSSxZQUFZLENBQUMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0FBQzFFLFNBQVU7QUFDVixRQUNTLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyx1QkFBdUIsRUFBRTtBQUN4RCxZQUFhLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDbkgsWUFBYSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDNUQsWUFBYSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNwRCxTQUFVO0FBQ1YsUUFBUyxPQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ25DLElBQUssQ0FBQztBQUNOOzRSQUFDO0FBQ0QsMlVBdlJLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBS0csWUFiTixrQkFBa0I7S0FTdkIsVUFBVSxFQUFFLE1BQU0sdkJBVFMsWUFBZSxhQUFhO1FBVTFELFJBVjhELFlBQWxDLGVBQWU7QUFBSSxZQUFhLGtCQUFrQjtBQUFHOzs7Ozs7MExBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSwgTm9kZXNBcGlTZXJ2aWNlLCBTZWFyY2hTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UsIEVjbVVzZXJNb2RlbCB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBHcm91cCwgR3JvdXBNZW1iZXJFbnRyeSwgR3JvdXBNZW1iZXJQYWdpbmcsIE5vZGUsIFBhdGhFbGVtZW50LCBQZXJtaXNzaW9uRWxlbWVudCwgUXVlcnlCb2R5IH0gZnJvbSAnQGFsZnJlc2NvL2pzLWFwaSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgZnJvbSwgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUGVybWlzc2lvbkRpc3BsYXlNb2RlbCB9IGZyb20gJy4uL21vZGVscy9wZXJtaXNzaW9uLm1vZGVsJztcbmltcG9ydCB7IFJvbGVNb2RlbCB9IGZyb20gJy4uL21vZGVscy9yb2xlLm1vZGVsJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBOb2RlUGVybWlzc2lvblNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcGlTZXJ2aWNlOiBBbGZyZXNjb0FwaVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzZWFyY2hBcGlTZXJ2aWNlOiBTZWFyY2hTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbm9kZVNlcnZpY2U6IE5vZGVzQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgbGlzdCBvZiByb2xlcyBmb3IgdGhlIGN1cnJlbnQgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSBUaGUgdGFyZ2V0IG5vZGVcbiAgICAgKiBAcmV0dXJucyBBcnJheSBvZiBzdHJpbmdzIHJlcHJlc2VudGluZyB0aGUgcm9sZXNcbiAgICAgKi9cbiAgICBnZXROb2RlUm9sZXMobm9kZTogTm9kZSk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICAgICAgY29uc3QgcmV0cmlldmVTaXRlUXVlcnlCb2R5OiBRdWVyeUJvZHkgPSB0aGlzLmJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGUucGF0aC5lbGVtZW50cyk7XG4gICAgICAgIHJldHVybiB0aGlzLnNlYXJjaEFwaVNlcnZpY2Uuc2VhcmNoQnlRdWVyeUJvZHkocmV0cmlldmVTaXRlUXVlcnlCb2R5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChzaXRlTm9kZUxpc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHNpdGVOb2RlTGlzdC5saXN0LmVudHJpZXMubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpdGVOYW1lID0gc2l0ZU5vZGVMaXN0Lmxpc3QuZW50cmllc1swXS5lbnRyeS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R3JvdXBNZW1iZXJzQnlTaXRlTmFtZShzaXRlTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2Yobm9kZS5wZXJtaXNzaW9ucz8uc2V0dGFibGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0Tm9kZVBlcm1pc3Npb25zKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8ubG9jYWxseVNldCkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0Lm1hcCgocGVybWlzc2lvbkVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChuZXcgUGVybWlzc2lvbkRpc3BsYXlNb2RlbChwZXJtaXNzaW9uRWxlbWVudCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobm9kZT8ucGVybWlzc2lvbnM/LmluaGVyaXRlZCkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5pbmhlcml0ZWQubWFwKChwZXJtaXNzaW9uRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25Jbmhlcml0ZWQgPSBuZXcgUGVybWlzc2lvbkRpc3BsYXlNb2RlbChwZXJtaXNzaW9uRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgcGVybWlzc2lvbkluaGVyaXRlZC5pc0luaGVyaXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGVybWlzc2lvbkluaGVyaXRlZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIHBlcm1pc3Npb24gcm9sZSBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIFRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHVwZGF0ZWRQZXJtaXNzaW9uUm9sZSBQZXJtaXNzaW9uIHJvbGUgdG8gdXBkYXRlIG9yIGFkZFxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCB1cGRhdGVkIHBlcm1pc3Npb25cbiAgICAgKi9cbiAgICB1cGRhdGVQZXJtaXNzaW9uUm9sZShub2RlOiBOb2RlLCB1cGRhdGVkUGVybWlzc2lvblJvbGU6IFBlcm1pc3Npb25FbGVtZW50KTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXX0gfTtcbiAgICAgICAgY29uc3QgaW5kZXggPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQubWFwKChwZXJtaXNzaW9uKSA9PiBwZXJtaXNzaW9uLmF1dGhvcml0eUlkKS5pbmRleE9mKHVwZGF0ZWRQZXJtaXNzaW9uUm9sZS5hdXRob3JpdHlJZCk7XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmNvbmNhdChub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQpO1xuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0W2luZGV4XSA9IHVwZGF0ZWRQZXJtaXNzaW9uUm9sZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQucHVzaCh1cGRhdGVkUGVybWlzc2lvblJvbGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVTZXJ2aWNlLnVwZGF0ZU5vZGUobm9kZS5pZCwgcGVybWlzc2lvbkJvZHkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSUQgb2YgdGhlIHRhcmdldCBub2RlXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25MaXN0IE5ldyBwZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVOb2RlUGVybWlzc2lvbnMobm9kZUlkOiBzdHJpbmcsIHBlcm1pc3Npb25MaXN0OiBQZXJtaXNzaW9uRWxlbWVudFtdKTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UuZ2V0Tm9kZShub2RlSWQpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKG5vZGUpID0+IHRoaXMudXBkYXRlTG9jYWxseVNldFBlcm1pc3Npb25zKG5vZGUsIHBlcm1pc3Npb25MaXN0KSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBsb2NhbGx5IHNldCBwZXJtaXNzaW9ucyBmb3IgYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9ucyBQZXJtaXNzaW9uIHNldHRpbmdzXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIHVwZGF0ZWQgcGVybWlzc2lvbnNcbiAgICAgKi9cbiAgICB1cGRhdGVMb2NhbGx5U2V0UGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdfSB9O1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uTGlzdCA9IHBlcm1pc3Npb25zO1xuICAgICAgICBjb25zdCBkdXBsaWNhdGVkUGVybWlzc2lvbnMgPSB0aGlzLmdldER1cGxpY2F0ZWRQZXJtaXNzaW9ucyhub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQsIHBlcm1pc3Npb25MaXN0KTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZWRQZXJtaXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gZHVwbGljYXRlZFBlcm1pc3Npb25zLm1hcCgocGVybWlzc2lvbikgPT4gJ2F1dGhvcml0eSAtPiAnICsgcGVybWlzc2lvbi5hdXRob3JpdHlJZCArICcgLyByb2xlIC0+ICcgKyBwZXJtaXNzaW9uLm5hbWUpLmpvaW4oJywgJyk7XG4gICAgICAgICAgICBjb25zdCBkdXBsaWNhdGVQZXJtaXNzaW9uTWVzc2FnZTogc3RyaW5nID0gdGhpcy50cmFuc2xhdGlvbi5pbnN0YW50KCdQRVJNSVNTSU9OX01BTkFHRVIuRVJST1IuRFVQTElDQVRFLVBFUk1JU1NJT04nLCAge2xpc3R9KTtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGR1cGxpY2F0ZVBlcm1pc3Npb25NZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID8gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmNvbmNhdChwZXJtaXNzaW9uTGlzdCkgOiBwZXJtaXNzaW9uTGlzdDtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXREdXBsaWNhdGVkUGVybWlzc2lvbnMobm9kZUxvY2FsbHlTZXQ6IFBlcm1pc3Npb25FbGVtZW50W10sIHBlcm1pc3Npb25MaXN0QWRkZWQ6IFBlcm1pc3Npb25FbGVtZW50W10pOiBQZXJtaXNzaW9uRWxlbWVudFtdIHtcbiAgICAgICAgY29uc3QgZHVwbGljYXRlUGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10gPSBbXTtcbiAgICAgICAgaWYgKG5vZGVMb2NhbGx5U2V0KSB7XG4gICAgICAgICAgICBwZXJtaXNzaW9uTGlzdEFkZGVkLmZvckVhY2goKHBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlID0gbm9kZUxvY2FsbHlTZXQuZmluZCgobG9jYWxQZXJtaXNzaW9uKSA9PiB0aGlzLmlzRXF1YWxQZXJtaXNzaW9uKGxvY2FsUGVybWlzc2lvbiwgcGVybWlzc2lvbikpO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZHVwbGljYXRlUGVybWlzc2lvbnMucHVzaChkdXBsaWNhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkdXBsaWNhdGVQZXJtaXNzaW9ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRXF1YWxQZXJtaXNzaW9uKG9sZFBlcm1pc3Npb246IFBlcm1pc3Npb25FbGVtZW50LCBuZXdQZXJtaXNzaW9uOiBQZXJtaXNzaW9uRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gb2xkUGVybWlzc2lvbi5hY2Nlc3NTdGF0dXMgPT09IG5ld1Blcm1pc3Npb24uYWNjZXNzU3RhdHVzICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLmF1dGhvcml0eUlkID09PSBuZXdQZXJtaXNzaW9uLmF1dGhvcml0eUlkICYmXG4gICAgICAgICAgICAgICBvbGRQZXJtaXNzaW9uLm5hbWUgPT09IG5ld1Blcm1pc3Npb24ubmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGEgcGVybWlzc2lvbiBzZXR0aW5nIGZyb20gYSBub2RlLlxuICAgICAqIEBwYXJhbSBub2RlIElEIG9mIHRoZSB0YXJnZXQgbm9kZVxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uVG9SZW1vdmUgUGVybWlzc2lvbiBzZXR0aW5nIHRvIHJlbW92ZVxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCBtb2RpZmllZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHJlbW92ZVBlcm1pc3Npb24obm9kZTogTm9kZSwgcGVybWlzc2lvblRvUmVtb3ZlOiBQZXJtaXNzaW9uRWxlbWVudCk6IE9ic2VydmFibGU8Tm9kZT4ge1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9uQm9keSA9IHsgcGVybWlzc2lvbnM6IHsgbG9jYWxseVNldDogW10gfSB9O1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUucGVybWlzc2lvbnMubG9jYWxseVNldC5tYXAoKHBlcm1pc3Npb24pID0+IHBlcm1pc3Npb24uYXV0aG9yaXR5SWQpLmluZGV4T2YocGVybWlzc2lvblRvUmVtb3ZlLmF1dGhvcml0eUlkKTtcblxuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQ7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBvZihub2RlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0R3JvdXBNZW1iZXJzQnlTaXRlTmFtZShzaXRlTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCBncm91cE5hbWUgPSAnR1JPVVBfc2l0ZV8nICsgc2l0ZU5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEdyb3VwTWVtYmVyQnlHcm91cE5hbWUoZ3JvdXBOYW1lKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChncm91cE1lbWJlclBhZ2luZzogR3JvdXBNZW1iZXJQYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzcGxheVJlc3VsdDogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBNZW1iZXJQYWdpbmcubGlzdC5lbnRyaWVzLmZvckVhY2goKG1lbWJlcjogR3JvdXBNZW1iZXJFbnRyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheVJlc3VsdC5wdXNoKHRoaXMuZm9ybWF0dGVkUm9sZU5hbWUobWVtYmVyLmVudHJ5LmRpc3BsYXlOYW1lLCAnc2l0ZV8nICsgc2l0ZU5hbWUpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXNwbGF5UmVzdWx0O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIG1lbWJlcnMgcmVsYXRlZCB0byBhIGdyb3VwIG5hbWUuXG4gICAgICogQHBhcmFtIGdyb3VwTmFtZSBOYW1lIG9mIGdyb3VwIHRvIGxvb2sgZm9yIG1lbWJlcnNcbiAgICAgKiBAcGFyYW0gb3B0cyBFeHRyYSBvcHRpb25zIHN1cHBvcnRlZCBieSBKUy1BUElcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIG1lbWJlcnNcbiAgICAgKi9cbiAgICBnZXRHcm91cE1lbWJlckJ5R3JvdXBOYW1lKGdyb3VwTmFtZTogc3RyaW5nLCBvcHRzPzogYW55KTogT2JzZXJ2YWJsZTxHcm91cE1lbWJlclBhZ2luZz4ge1xuICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmFwaVNlcnZpY2UuZ3JvdXBzQXBpLmxpc3RHcm91cE1lbWJlcnNoaXBzKGdyb3VwTmFtZSwgb3B0cykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0dGVkUm9sZU5hbWUoZGlzcGxheU5hbWUsIHNpdGVOYW1lKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lLnJlcGxhY2Uoc2l0ZU5hbWUgKyAnXycsICcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkUmV0cmlldmVTaXRlUXVlcnlCb2R5KG5vZGVQYXRoOiBQYXRoRWxlbWVudFtdKTogUXVlcnlCb2R5IHtcbiAgICAgICAgY29uc3QgcGF0aE5hbWVzID0gbm9kZVBhdGgubWFwKChub2RlOiBQYXRoRWxlbWVudCkgPT4gJ25hbWU6IFwiJyArIG5vZGUubmFtZSArICdcIicpO1xuICAgICAgICBjb25zdCBidWlsdFBhdGhOYW1lcyA9IHBhdGhOYW1lcy5qb2luKCcgT1IgJyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdxdWVyeSc6IHtcbiAgICAgICAgICAgICAgICAncXVlcnknOiBidWlsdFBhdGhOYW1lc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdwYWdpbmcnOiB7XG4gICAgICAgICAgICAgICAgJ21heEl0ZW1zJzogMTAwLFxuICAgICAgICAgICAgICAgICdza2lwQ291bnQnOiAwXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2luY2x1ZGUnOiBbJ2FzcGVjdE5hbWVzJywgJ3Byb3BlcnRpZXMnXSxcbiAgICAgICAgICAgICdmaWx0ZXJRdWVyaWVzJzogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVFlQRTonc3Q6c2l0ZSdcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRMb2NhbFBlcm1pc3Npb25zKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8ubG9jYWxseVNldCkge1xuICAgICAgICAgICAgbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0LmZvckVhY2goKHBlcm1pc3Npb25FbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFBlcm1pc3Npb25EaXNwbGF5TW9kZWwocGVybWlzc2lvbkVsZW1lbnQpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRJbmhlcml0ZWRQZXJtaXNzaW9uKG5vZGU6IE5vZGUpOiBQZXJtaXNzaW9uRGlzcGxheU1vZGVsW10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFBlcm1pc3Npb25EaXNwbGF5TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGlmIChub2RlPy5wZXJtaXNzaW9ucz8uaW5oZXJpdGVkKSB7XG4gICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmluaGVyaXRlZC5mb3JFYWNoKChwZXJtaXNzaW9uRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25Jbmhlcml0ZWQgPSBuZXcgUGVybWlzc2lvbkRpc3BsYXlNb2RlbChwZXJtaXNzaW9uRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgcGVybWlzc2lvbkluaGVyaXRlZC5pc0luaGVyaXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGVybWlzc2lvbkluaGVyaXRlZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgcGVybWlzc2lvbnMgc2V0dGluZyBmcm9tIGEgbm9kZS5cbiAgICAgKiBAcGFyYW0gbm9kZSB0YXJnZXQgbm9kZSB3aXRoIHBlcm1pc3Npb25cbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbnMgUGVybWlzc2lvbnMgdG8gcmVtb3ZlXG4gICAgICogQHJldHVybnMgTm9kZSB3aXRoIG1vZGlmaWVkIHBlcm1pc3Npb25zXG4gICAgICovXG4gICAgcmVtb3ZlUGVybWlzc2lvbnMobm9kZTogTm9kZSwgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25FbGVtZW50W10pOiBPYnNlcnZhYmxlPE5vZGU+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbkJvZHkgPSB7IHBlcm1pc3Npb25zOiB7IGxvY2FsbHlTZXQ6IFtdIH0gfTtcblxuICAgICAgICBwZXJtaXNzaW9ucy5mb3JFYWNoKChwZXJtaXNzaW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuZmluZEluZGV4KChsb2NhbGx5U2V0KSA9PiAgbG9jYWxseVNldC5hdXRob3JpdHlJZCA9PT0gcGVybWlzc2lvbi5hdXRob3JpdHlJZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBub2RlLnBlcm1pc3Npb25zLmxvY2FsbHlTZXQuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBwZXJtaXNzaW9uQm9keS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0ID0gbm9kZS5wZXJtaXNzaW9ucy5sb2NhbGx5U2V0O1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS51cGRhdGVOb2RlKG5vZGUuaWQsIHBlcm1pc3Npb25Cb2R5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiB1cGRhdGVzIHBlcm1pc3Npb25zIHNldHRpbmcgZnJvbSBhIG5vZGUuXG4gICAgICogQHBhcmFtIG5vZGUgdGFyZ2V0IG5vZGUgd2l0aCBwZXJtaXNzaW9uXG4gICAgICogQHBhcmFtIHBlcm1pc3Npb25zIFBlcm1pc3Npb25zIHRvIHVwZGF0ZVxuICAgICAqIEByZXR1cm5zIE5vZGUgd2l0aCBtb2RpZmllZCBwZXJtaXNzaW9uc1xuICAgICAqL1xuICAgIHVwZGF0ZVBlcm1pc3Npb25zKG5vZGU6IE5vZGUsIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uRWxlbWVudFtdKTogT2JzZXJ2YWJsZTxOb2RlPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25Cb2R5ID0geyBwZXJtaXNzaW9uczogeyBsb2NhbGx5U2V0OiBbXSB9IH07XG4gICAgICAgIHBlcm1pc3Npb25Cb2R5LnBlcm1pc3Npb25zLmxvY2FsbHlTZXQgPSBwZXJtaXNzaW9ucztcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZVNlcnZpY2UudXBkYXRlTm9kZShub2RlLmlkLCBwZXJtaXNzaW9uQm9keSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgbm9kZSBkZXRhaWwgZm9yIG5vZGVJZCBhbG9uZyB3aXRoIHNldHRhYmxlIHBlcm1pc3Npb25zLlxuICAgICAqIEBwYXJhbSBub2RlSWQgSWQgb2YgdGhlIG5vZGVcbiAgICAgKiBAcmV0dXJucyBub2RlIGFuZCBpdCdzIGFzc29jaWF0ZWQgcm9sZXMgeyBub2RlOiBOb2RlOyByb2xlczogUm9sZU1vZGVsW10gfVxuICAgICAqL1xuICAgICBnZXROb2RlV2l0aFJvbGVzKG5vZGVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTx7IG5vZGU6IE5vZGU7IHJvbGVzOiBSb2xlTW9kZWxbXSB9PiB7XG4gICAgICAgICByZXR1cm4gdGhpcy5ub2RlU2VydmljZS5nZXROb2RlKG5vZGVJZCkucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcChub2RlID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZm9ya0pvaW4oe1xuICAgICAgICAgICAgICAgICAgICAgbm9kZTogb2Yobm9kZSksXG4gICAgICAgICAgICAgICAgICAgICByb2xlczogdGhpcy5nZXROb2RlUm9sZXMobm9kZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKG5vZGUucGVybWlzc2lvbnM/LnNldHRhYmxlKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoX3JvbGVzID0+IF9yb2xlcy5tYXAocm9sZSA9PiAoeyByb2xlLCBsYWJlbDogcm9sZSB9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICB9XG5cbiAgICAgdHJhbnNmb3JtTm9kZVRvVXNlclBlcnNvbihub2RlOiBOb2RlKTogeyBwZXJzb246IEVjbVVzZXJNb2RlbCwgZ3JvdXA6IEdyb3VwIH0ge1xuICAgICAgICAgbGV0IHBlcnNvbiA9IG51bGwsIGdyb3VwID0gbnVsbDtcbiAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAnY206cGVyc29uJykge1xuICAgICAgICAgICAgIGNvbnN0IGZpcnN0TmFtZSA9IG5vZGUucHJvcGVydGllc1snY206Zmlyc3ROYW1lJ107XG4gICAgICAgICAgICAgY29uc3QgbGFzdE5hbWUgPSAgbm9kZS5wcm9wZXJ0aWVzWydjbTpsYXN0TmFtZSddO1xuICAgICAgICAgICAgIGNvbnN0IGVtYWlsID0gIG5vZGUucHJvcGVydGllc1snY206ZW1haWwnXTtcbiAgICAgICAgICAgICBjb25zdCBpZCA9ICBub2RlLnByb3BlcnRpZXNbJ2NtOnVzZXJOYW1lJ107XG4gICAgICAgICAgICAgcGVyc29uID0gbmV3IEVjbVVzZXJNb2RlbCh7IGlkLCBmaXJzdE5hbWUsIGxhc3ROYW1lLCBlbWFpbH0pO1xuICAgICAgICAgfVxuXG4gICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gJ2NtOmF1dGhvcml0eUNvbnRhaW5lcicpIHtcbiAgICAgICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IG5vZGUucHJvcGVydGllc1snY206YXV0aG9yaXR5RGlzcGxheU5hbWUnXSB8fCBub2RlLnByb3BlcnRpZXNbJ2NtOmF1dGhvcml0eU5hbWUnXTtcbiAgICAgICAgICAgICBjb25zdCBpZCA9IG5vZGUucHJvcGVydGllc1snY206YXV0aG9yaXR5TmFtZSddO1xuICAgICAgICAgICAgIGdyb3VwID0gbmV3IEdyb3VwKHsgZGlzcGxheU5hbWUsIGlkIH0pO1xuICAgICAgICAgfVxuICAgICAgICAgcmV0dXJuICB7IHBlcnNvbiwgZ3JvdXAgfTtcbiAgICAgfVxufVxuIl19
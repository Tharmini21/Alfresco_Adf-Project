import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { Subject, from, ReplaySubject } from 'rxjs';
import { AlfrescoApiService, AppConfigService } from '@alfresco/adf-core';
import { RequestSortDefinitionInner } from '@alfresco/js-api';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alfresco/adf-core';
export class BaseQueryBuilderService {
    constructor(appConfig, alfrescoApiService) {
        this.appConfig = appConfig;
        this.alfrescoApiService = alfrescoApiService;
        this.configUpdated = new Subject();
        this.updated = new Subject();
        this.executed = new Subject();
        this.error = new Subject();
        this.searchForms = new ReplaySubject(1);
        this.categories = [];
        this.queryFragments = {};
        this.filterQueries = [];
        this.paging = null;
        this.sorting = [];
        this.sortingOptions = [];
        this._userQuery = '';
        this.userFacetBuckets = {};
        this.config = {
            categories: []
        };
        this.ranges = {};
        this.resetToDefaults();
    }
    get userQuery() {
        return this._userQuery;
    }
    set userQuery(value) {
        value = (value || '').trim();
        this._userQuery = value ? `(${value})` : '';
    }
    resetToDefaults() {
        const currentConfig = this.getDefaultConfiguration();
        this.resetSearchOptions();
        this.configUpdated.next(currentConfig);
        this.searchForms.next(this.getSearchFormDetails());
        this.setUpSearchConfiguration(currentConfig);
    }
    getDefaultConfiguration() {
        const configurations = this.loadConfiguration();
        if (this.selectedConfiguration !== undefined) {
            return configurations[this.selectedConfiguration];
        }
        if (Array.isArray(configurations)) {
            return configurations.find((configuration) => configuration.default);
        }
        return configurations;
    }
    updateSelectedConfiguration(index) {
        const currentConfig = this.loadConfiguration();
        if (Array.isArray(currentConfig) && currentConfig[index] !== undefined) {
            this.selectedConfiguration = index;
            this.configUpdated.next(currentConfig[index]);
            this.searchForms.next(this.getSearchFormDetails());
            this.resetSearchOptions();
            this.setUpSearchConfiguration(currentConfig[index]);
            this.update();
        }
    }
    resetSearchOptions() {
        this.categories = [];
        this.queryFragments = {};
        this.filterQueries = [];
        this.sorting = [];
        this.sortingOptions = [];
        this.userFacetBuckets = {};
        this.scope = null;
    }
    getSearchFormDetails() {
        const configurations = this.loadConfiguration();
        if (Array.isArray(configurations)) {
            return configurations.map((configuration, index) => ({
                index,
                name: configuration.name || 'SEARCH.UNKNOWN_CONFIGURATION',
                default: configuration.default || false,
                selected: this.selectedConfiguration !== undefined ? index === this.selectedConfiguration : configuration.default
            }));
        }
        else if (!!configurations) {
            return [{ index: 0, name: configurations.name || 'SEARCH.UNKNOWN_CONFIGURATION', default: true, selected: true }];
        }
        return [];
    }
    setUpSearchConfiguration(currentConfiguration) {
        if (currentConfiguration) {
            this.config = JSON.parse(JSON.stringify(currentConfiguration));
            this.categories = (this.config.categories || []).filter(category => category.enabled);
            this.filterQueries = this.config.filterQueries || [];
            this.userFacetBuckets = {};
            if (this.config.sorting) {
                this.sorting = this.config.sorting.defaults || [];
                this.sortingOptions = this.config.sorting.options || [];
            }
        }
    }
    addUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            const buckets = this.userFacetBuckets[field.field] || [];
            const existing = buckets.find((facetBucket) => facetBucket.label === bucket.label);
            if (!existing) {
                buckets.push(bucket);
            }
            this.userFacetBuckets[field.field] = buckets;
        }
    }
    getUserFacetBuckets(field) {
        return this.userFacetBuckets[field] || [];
    }
    removeUserFacetBucket(field, bucket) {
        if (field && field.field && bucket) {
            const buckets = this.userFacetBuckets[field.field] || [];
            this.userFacetBuckets[field.field] = buckets
                .filter((facetBucket) => facetBucket.label !== bucket.label);
        }
    }
    addFilterQuery(query) {
        if (query) {
            const existing = this.filterQueries.find((filterQuery) => filterQuery.query === query);
            if (!existing) {
                this.filterQueries.push({ query: query });
            }
        }
    }
    removeFilterQuery(query) {
        if (query) {
            this.filterQueries = this.filterQueries
                .filter((filterQuery) => filterQuery.query !== query);
        }
    }
    getFacetQuery(label) {
        if (label && this.hasFacetQueries) {
            const result = this.config.facetQueries.queries.find((query) => query.label === label);
            if (result) {
                return Object.assign({}, result);
            }
        }
        return null;
    }
    getFacetField(label) {
        if (label) {
            const fields = this.config.facetFields.fields || [];
            const result = fields.find((field) => field.label === label);
            if (result) {
                result.label = this.getSupportedLabel(result.label);
                return Object.assign({}, result);
            }
        }
        return null;
    }
    setScope(scope) {
        this.scope = scope;
    }
    getScope() {
        return this.scope;
    }
    update(queryBody) {
        const query = queryBody ? queryBody : this.buildQuery();
        this.updated.next(query);
    }
    execute(queryBody) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const query = queryBody ? queryBody : this.buildQuery();
                if (query) {
                    const resultSetPaging = yield this.alfrescoApiService.getInstance().search.searchApi.search(query);
                    this.executed.next(resultSetPaging);
                }
            }
            catch (error) {
                this.error.next(error);
                this.executed.next({
                    list: {
                        pagination: {
                            totalItems: 0
                        },
                        entries: []
                    }
                });
            }
        });
    }
    search(queryBody) {
        const promise = this.alfrescoApiService.searchApi.search(queryBody);
        promise.then((resultSetPaging) => {
            this.executed.next(resultSetPaging);
        });
        return from(promise);
    }
    buildQuery() {
        const query = this.getFinalQuery();
        const include = this.config.include || [];
        if (include.length === 0) {
            include.push('path', 'allowableOperations');
        }
        if (query) {
            const result = {
                query: {
                    query: query,
                    language: 'afts'
                },
                include: include,
                paging: this.paging,
                fields: this.config.fields,
                filterQueries: this.filterQueries,
                facetQueries: this.facetQueries,
                facetIntervals: this.facetIntervals,
                facetFields: this.facetFields,
                sort: this.sort,
                highlight: this.highlight
            };
            if (this.scope) {
                result['scope'] = this.scope;
            }
            result['facetFormat'] = 'V2';
            return result;
        }
        return null;
    }
    getPrimarySorting() {
        if (this.sorting && this.sorting.length > 0) {
            return this.sorting[0];
        }
        return null;
    }
    getSortingOptions() {
        if (this.config && this.config.sorting) {
            return this.config.sorting.options || [];
        }
        return [];
    }
    getQueryGroup(query) {
        return query.group || this.config.facetQueries.label || 'Facet Queries';
    }
    get hasFacetQueries() {
        if (this.config
            && this.config.facetQueries
            && this.config.facetQueries.queries
            && this.config.facetQueries.queries.length > 0) {
            return true;
        }
        return false;
    }
    get hasFacetIntervals() {
        return this.config
            && this.config.facetIntervals
            && this.config.facetIntervals.intervals
            && this.config.facetIntervals.intervals.length > 0;
    }
    get hasFacetHighlight() {
        return this.config && this.config.highlight ? true : false;
    }
    get sort() {
        return this.sorting.map((def) => {
            return new RequestSortDefinitionInner({
                type: def.type,
                field: def.field,
                ascending: def.ascending
            });
        });
    }
    get facetQueries() {
        if (this.hasFacetQueries) {
            return this.config.facetQueries.queries.map((query) => {
                query.group = this.getQueryGroup(query);
                return Object.assign({}, query);
            });
        }
        return null;
    }
    get facetIntervals() {
        if (this.hasFacetIntervals) {
            const configIntervals = this.config.facetIntervals;
            return {
                intervals: configIntervals.intervals.map((interval) => ({
                    label: this.getSupportedLabel(interval.label),
                    field: interval.field,
                    sets: interval.sets.map((set) => ({
                        label: this.getSupportedLabel(set.label),
                        start: set.start,
                        end: set.end,
                        startInclusive: set.startInclusive,
                        endInclusive: set.endInclusive
                    }))
                }))
            };
        }
        return null;
    }
    get highlight() {
        return this.hasFacetHighlight ? this.config.highlight : null;
    }
    getFinalQuery() {
        let query = '';
        this.categories.forEach((facet) => {
            const customQuery = this.queryFragments[facet.id];
            if (customQuery) {
                if (query.length > 0) {
                    query += ' AND ';
                }
                query += `(${customQuery})`;
            }
        });
        let result = [this.userQuery, query]
            .filter((entry) => entry)
            .join(' AND ');
        if (this.userFacetBuckets) {
            Object.keys(this.userFacetBuckets).forEach((key) => {
                const subQuery = (this.userFacetBuckets[key] || [])
                    .filter((bucket) => bucket.filterQuery)
                    .map((bucket) => bucket.filterQuery)
                    .join(' OR ');
                if (subQuery) {
                    if (result.length > 0) {
                        result += ' AND ';
                    }
                    result += `(${subQuery})`;
                }
            });
        }
        return result;
    }
    get facetFields() {
        const facetFields = this.config.facetFields && this.config.facetFields.fields;
        if (facetFields && facetFields.length > 0) {
            return {
                facets: facetFields.map((facet) => ({
                    field: facet.field,
                    mincount: facet.mincount,
                    label: this.getSupportedLabel(facet.label),
                    limit: facet.limit,
                    offset: facet.offset,
                    prefix: facet.prefix
                }))
            };
        }
        return null;
    }
    getSupportedLabel(configLabel) {
        const spaceInsideLabelIndex = configLabel.search(/\s/g);
        if (spaceInsideLabelIndex > -1) {
            return `"${configLabel}"`;
        }
        return configLabel;
    }
}
BaseQueryBuilderService.ɵfac = function BaseQueryBuilderService_Factory(t) { return new (t || BaseQueryBuilderService)(ɵngcc0.ɵɵinject(ɵngcc1.AppConfigService), ɵngcc0.ɵɵinject(ɵngcc1.AlfrescoApiService)); };
BaseQueryBuilderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function BaseQueryBuilderService_Factory() { return new BaseQueryBuilderService(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i1.AlfrescoApiService)); }, token: BaseQueryBuilderService, providedIn: "root" });
BaseQueryBuilderService.ctorParameters = () => [
    { type: AppConfigService },
    { type: AlfrescoApiService }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(BaseQueryBuilderService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.AppConfigService }, { type: ɵngcc1.AlfrescoApiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1xdWVyeS1idWlsZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2hvbWUvdHJhdmlzL2J1aWxkL0FsZnJlc2NvL2FsZnJlc2NvLW5nMi1jb21wb25lbnRzL2xpYi9jb250ZW50LXNlcnZpY2VzL3NyYy9saWIvc2VhcmNoL3NlcnZpY2VzL2Jhc2UtcXVlcnktYnVpbGRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFjLElBQUksRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUUsT0FBTyxFQUlILDBCQUEwQixFQUk3QixNQUFNLGtCQUFrQixDQUFDO0FBQzFCO0FBQXFDOzs7QUFhckMsTUFBTSxPQUFnQix1QkFBdUI7QUFDN0MsSUE0Q0ksWUFBc0IsU0FBMkIsRUFBWSxrQkFBc0M7QUFDdkcsUUFEMEIsY0FBUyxHQUFULFNBQVMsQ0FBa0I7QUFBQyxRQUFXLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFBQyxRQTFDcEcsa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBdUIsQ0FBQztBQUN2RCxRQUVJLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBYSxDQUFDO0FBQ3ZDLFFBRUksYUFBUSxHQUFHLElBQUksT0FBTyxFQUFtQixDQUFDO0FBQzlDLFFBRUksVUFBSyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7QUFDMUIsUUFFSSxnQkFBVyxHQUFHLElBQUksYUFBYSxDQUFlLENBQUMsQ0FBQyxDQUFDO0FBQ3JELFFBQ0ksZUFBVSxHQUFxQixFQUFFLENBQUM7QUFDdEMsUUFBSSxtQkFBYyxHQUE2QixFQUFFLENBQUM7QUFDbEQsUUFBSSxrQkFBYSxH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LENBQUM7QUFDTDtnTkFBQztBQUNELGlSQXZlSztBQUFDO0VBSEwsVUFBVSxTQUFDLHJCQUtOLFlBekJ1QixnQkFBZ0I7T0FxQnpDLFVBQVUsRUFBRSxNQUFNLHpCQXJCMkIsWUFBeEMsa0JBQWtCO0FBQUc7R0FzQjdCOzs7OztzSEF0QitCO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBmcm9tLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBbGZyZXNjb0FwaVNlcnZpY2UsIEFwcENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHtcbiAgICBRdWVyeUJvZHksXG4gICAgUmVxdWVzdEZhY2V0RmllbGRzLFxuICAgIFJlcXVlc3RGYWNldEZpZWxkLFxuICAgIFJlcXVlc3RTb3J0RGVmaW5pdGlvbklubmVyLFxuICAgIFJlc3VsdFNldFBhZ2luZyxcbiAgICBSZXF1ZXN0SGlnaGxpZ2h0LFxuICAgIFJlcXVlc3RTY29wZVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IFNlYXJjaENhdGVnb3J5IH0gZnJvbSAnLi4vbW9kZWxzL3NlYXJjaC1jYXRlZ29yeS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRmlsdGVyUXVlcnkgfSBmcm9tICcuLi9tb2RlbHMvZmlsdGVyLXF1ZXJ5LmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZWFyY2hSYW5nZSB9IGZyb20gJy4uL21vZGVscy9zZWFyY2gtcmFuZ2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi9tb2RlbHMvc2VhcmNoLWNvbmZpZ3VyYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0UXVlcnkgfSBmcm9tICcuLi9tb2RlbHMvZmFjZXQtcXVlcnkuaW50ZXJmYWNlJztcbmltcG9ydCB7IFNlYXJjaFNvcnRpbmdEZWZpbml0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL3NlYXJjaC1zb3J0aW5nLWRlZmluaXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGQgfSBmcm9tICcuLi9tb2RlbHMvZmFjZXQtZmllbGQuaW50ZXJmYWNlJztcbmltcG9ydCB7IEZhY2V0RmllbGRCdWNrZXQgfSBmcm9tICcuLi9tb2RlbHMvZmFjZXQtZmllbGQtYnVja2V0LmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZWFyY2hGb3JtIH0gZnJvbSAnLi4vbW9kZWxzL3NlYXJjaC1mb3JtLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZVF1ZXJ5QnVpbGRlclNlcnZpY2Uge1xuXG4gICAgLyogIFN0cmVhbSB0aGF0IGVtaXRzIHRoZSBzZWFyY2ggY29uZmlndXJhdGlvbiB3aGVuZXZlciB0aGUgdXNlciBjaGFuZ2UgdGhlIHNlYXJjaCBmb3JtcyAqL1xuICAgIGNvbmZpZ1VwZGF0ZWQgPSBuZXcgU3ViamVjdDxTZWFyY2hDb25maWd1cmF0aW9uPigpO1xuXG4gICAgLyogIFN0cmVhbSB0aGF0IGVtaXRzIHRoZSBxdWVyeSBiZWZvcmUgc2VhcmNoIHdoZW5ldmVyIHVzZXIgc2VhcmNoICAqL1xuICAgIHVwZGF0ZWQgPSBuZXcgU3ViamVjdDxRdWVyeUJvZHk+KCk7XG5cbiAgICAvKiAgU3RyZWFtIHRoYXQgZW1pdHMgdGhlIHJlc3VsdHMgd2hlbmV2ZXIgdXNlciBzZWFyY2ggICovXG4gICAgZXhlY3V0ZWQgPSBuZXcgU3ViamVjdDxSZXN1bHRTZXRQYWdpbmc+KCk7XG5cbiAgICAvKiAgU3RyZWFtIHRoYXQgZW1pdHMgdGhlIGVycm9yIHdoZW5ldmVyIHVzZXIgc2VhcmNoICAqL1xuICAgIGVycm9yID0gbmV3IFN1YmplY3QoKTtcblxuICAgIC8qICBTdHJlYW0gdGhhdCBlbWl0cyBzZWFyY2ggZm9ybXMgICovXG4gICAgc2VhcmNoRm9ybXMgPSBuZXcgUmVwbGF5U3ViamVjdDxTZWFyY2hGb3JtW10+KDEpO1xuXG4gICAgY2F0ZWdvcmllczogU2VhcmNoQ2F0ZWdvcnlbXSA9IFtdO1xuICAgIHF1ZXJ5RnJhZ21lbnRzOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgICBmaWx0ZXJRdWVyaWVzOiBGaWx0ZXJRdWVyeVtdID0gW107XG4gICAgcGFnaW5nOiB7IG1heEl0ZW1zPzogbnVtYmVyOyBza2lwQ291bnQ/OiBudW1iZXIgfSA9IG51bGw7XG4gICAgc29ydGluZzogU2VhcmNoU29ydGluZ0RlZmluaXRpb25bXSA9IFtdO1xuICAgIHNvcnRpbmdPcHRpb25zOiBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbltdID0gW107XG4gICAgcHJpdmF0ZSBzY29wZTogUmVxdWVzdFNjb3BlO1xuICAgIHByaXZhdGUgc2VsZWN0ZWRDb25maWd1cmF0aW9uOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBfdXNlclF1ZXJ5ID0gJyc7XG5cbiAgICBwcm90ZWN0ZWQgdXNlckZhY2V0QnVja2V0czogeyBba2V5OiBzdHJpbmddOiBGYWNldEZpZWxkQnVja2V0W10gfSA9IHt9O1xuXG4gICAgZ2V0IHVzZXJRdWVyeSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdXNlclF1ZXJ5O1xuICAgIH1cblxuICAgIHNldCB1c2VyUXVlcnkodmFsdWU6IHN0cmluZykge1xuICAgICAgICB2YWx1ZSA9ICh2YWx1ZSB8fCAnJykudHJpbSgpO1xuICAgICAgICB0aGlzLl91c2VyUXVlcnkgPSB2YWx1ZSA/IGAoJHt2YWx1ZX0pYCA6ICcnO1xuICAgIH1cblxuICAgIGNvbmZpZzogU2VhcmNoQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgY2F0ZWdvcmllczogW11cbiAgICB9O1xuXG4gICAgLy8gVE9ETzogdG8gYmUgc3VwcG9ydGVkIGluIGZ1dHVyZSBpdGVyYXRpb25zXG4gICAgcmFuZ2VzOiB7IFtpZDogc3RyaW5nXTogU2VhcmNoUmFuZ2UgfSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIGFwcENvbmZpZzogQXBwQ29uZmlnU2VydmljZSwgcHJvdGVjdGVkIGFsZnJlc2NvQXBpU2VydmljZTogQWxmcmVzY29BcGlTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMucmVzZXRUb0RlZmF1bHRzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFic3RyYWN0IGxvYWRDb25maWd1cmF0aW9uKCk6IFNlYXJjaENvbmZpZ3VyYXRpb24gfCBTZWFyY2hDb25maWd1cmF0aW9uW107XG5cbiAgICBwdWJsaWMgYWJzdHJhY3QgaXNGaWx0ZXJTZXJ2aWNlQWN0aXZlKCk6IGJvb2xlYW47XG5cbiAgICBwdWJsaWMgcmVzZXRUb0RlZmF1bHRzKCkge1xuICAgICAgICBjb25zdCBjdXJyZW50Q29uZmlnID0gdGhpcy5nZXREZWZhdWx0Q29uZmlndXJhdGlvbigpO1xuICAgICAgICB0aGlzLnJlc2V0U2VhcmNoT3B0aW9ucygpO1xuICAgICAgICB0aGlzLmNvbmZpZ1VwZGF0ZWQubmV4dChjdXJyZW50Q29uZmlnKTtcbiAgICAgICAgdGhpcy5zZWFyY2hGb3Jtcy5uZXh0KHRoaXMuZ2V0U2VhcmNoRm9ybURldGFpbHMoKSk7XG4gICAgICAgIHRoaXMuc2V0VXBTZWFyY2hDb25maWd1cmF0aW9uKGN1cnJlbnRDb25maWcpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXREZWZhdWx0Q29uZmlndXJhdGlvbigpOiBTZWFyY2hDb25maWd1cmF0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgY29uc3QgY29uZmlndXJhdGlvbnMgPSB0aGlzLmxvYWRDb25maWd1cmF0aW9uKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25maWd1cmF0aW9uc1t0aGlzLnNlbGVjdGVkQ29uZmlndXJhdGlvbl07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWd1cmF0aW9ucykpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25maWd1cmF0aW9ucy5maW5kKChjb25maWd1cmF0aW9uKSA9PiBjb25maWd1cmF0aW9uLmRlZmF1bHQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb25maWd1cmF0aW9ucztcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlU2VsZWN0ZWRDb25maWd1cmF0aW9uKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY3VycmVudENvbmZpZyA9IHRoaXMubG9hZENvbmZpZ3VyYXRpb24oKTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3VycmVudENvbmZpZykgJiYgY3VycmVudENvbmZpZ1tpbmRleF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZENvbmZpZ3VyYXRpb24gPSBpbmRleDtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnVXBkYXRlZC5uZXh0KGN1cnJlbnRDb25maWdbaW5kZXhdKTtcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRm9ybXMubmV4dCh0aGlzLmdldFNlYXJjaEZvcm1EZXRhaWxzKCkpO1xuICAgICAgICAgICAgdGhpcy5yZXNldFNlYXJjaE9wdGlvbnMoKTtcbiAgICAgICAgICAgIHRoaXMuc2V0VXBTZWFyY2hDb25maWd1cmF0aW9uKGN1cnJlbnRDb25maWdbaW5kZXhdKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc2V0U2VhcmNoT3B0aW9ucygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jYXRlZ29yaWVzID0gW107XG4gICAgICAgIHRoaXMucXVlcnlGcmFnbWVudHMgPSB7fTtcbiAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzID0gW107XG4gICAgICAgIHRoaXMuc29ydGluZyA9IFtdO1xuICAgICAgICB0aGlzLnNvcnRpbmdPcHRpb25zID0gW107XG4gICAgICAgIHRoaXMudXNlckZhY2V0QnVja2V0cyA9IHt9O1xuICAgICAgICB0aGlzLnNjb3BlID0gbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0U2VhcmNoRm9ybURldGFpbHMoKTogU2VhcmNoRm9ybVtdIHtcbiAgICAgICAgY29uc3QgY29uZmlndXJhdGlvbnMgPSB0aGlzLmxvYWRDb25maWd1cmF0aW9uKCk7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZ3VyYXRpb25zKSkge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyYXRpb25zLm1hcCgoY29uZmlndXJhdGlvbiwgaW5kZXgpID0+ICh7XG4gICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgbmFtZTogY29uZmlndXJhdGlvbi5uYW1lIHx8ICdTRUFSQ0guVU5LTk9XTl9DT05GSUdVUkFUSU9OJyxcbiAgICAgICAgICAgICAgICBkZWZhdWx0OiBjb25maWd1cmF0aW9uLmRlZmF1bHQgfHwgZmFsc2UsXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uICE9PSB1bmRlZmluZWQgPyBpbmRleCA9PT0gdGhpcy5zZWxlY3RlZENvbmZpZ3VyYXRpb24gOiBjb25maWd1cmF0aW9uLmRlZmF1bHRcbiAgICAgICAgICAgfSkpO1xuICAgICAgICB9IGVsc2UgaWYgKCEhY29uZmlndXJhdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBbeyBpbmRleDogMCwgbmFtZTogY29uZmlndXJhdGlvbnMubmFtZSB8fCAnU0VBUkNILlVOS05PV05fQ09ORklHVVJBVElPTicsIGRlZmF1bHQ6IHRydWUsIHNlbGVjdGVkOiB0cnVlIH1dO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFVwU2VhcmNoQ29uZmlndXJhdGlvbihjdXJyZW50Q29uZmlndXJhdGlvbjogU2VhcmNoQ29uZmlndXJhdGlvbikge1xuICAgICAgICBpZiAoY3VycmVudENvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjdXJyZW50Q29uZmlndXJhdGlvbikpO1xuICAgICAgICAgICAgdGhpcy5jYXRlZ29yaWVzID0gKHRoaXMuY29uZmlnLmNhdGVnb3JpZXMgfHwgW10pLmZpbHRlcihcbiAgICAgICAgICAgICAgICBjYXRlZ29yeSA9PiBjYXRlZ29yeS5lbmFibGVkXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzID0gdGhpcy5jb25maWcuZmlsdGVyUXVlcmllcyB8fCBbXTtcbiAgICAgICAgICAgIHRoaXMudXNlckZhY2V0QnVja2V0cyA9IHt9O1xuICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLnNvcnRpbmcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvcnRpbmcgPSB0aGlzLmNvbmZpZy5zb3J0aW5nLmRlZmF1bHRzIHx8IFtdO1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydGluZ09wdGlvbnMgPSB0aGlzLmNvbmZpZy5zb3J0aW5nLm9wdGlvbnMgfHwgW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgZmFjZXQgYnVja2V0IHRvIGEgZmllbGQuXG4gICAgICogQHBhcmFtIGZpZWxkIFRoZSB0YXJnZXQgZmllbGRcbiAgICAgKiBAcGFyYW0gYnVja2V0IEJ1Y2tldCB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRVc2VyRmFjZXRCdWNrZXQoZmllbGQ6IEZhY2V0RmllbGQsIGJ1Y2tldDogRmFjZXRGaWVsZEJ1Y2tldCkge1xuICAgICAgICBpZiAoZmllbGQgJiYgZmllbGQuZmllbGQgJiYgYnVja2V0KSB7XG4gICAgICAgICAgICBjb25zdCBidWNrZXRzID0gdGhpcy51c2VyRmFjZXRCdWNrZXRzW2ZpZWxkLmZpZWxkXSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYnVja2V0cy5maW5kKChmYWNldEJ1Y2tldCkgPT4gZmFjZXRCdWNrZXQubGFiZWwgPT09IGJ1Y2tldC5sYWJlbCk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgYnVja2V0cy5wdXNoKGJ1Y2tldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0cztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGJ1Y2tldHMgY3VycmVudGx5IGFkZGVkIHRvIGEgZmllbGRcbiAgICAgKiBAcGFyYW0gZmllbGQgVGhlIHRhcmdldCBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyBCdWNrZXQgYXJyYXlcbiAgICAgKi9cbiAgICBnZXRVc2VyRmFjZXRCdWNrZXRzKGZpZWxkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZF0gfHwgW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyBidWNrZXQgZnJvbSBhIGZpZWxkLlxuICAgICAqIEBwYXJhbSBmaWVsZCBUaGUgdGFyZ2V0IGZpZWxkXG4gICAgICogQHBhcmFtIGJ1Y2tldCBCdWNrZXQgdG8gcmVtb3ZlXG4gICAgICovXG4gICAgcmVtb3ZlVXNlckZhY2V0QnVja2V0KGZpZWxkOiBGYWNldEZpZWxkLCBidWNrZXQ6IEZhY2V0RmllbGRCdWNrZXQpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGZpZWxkLmZpZWxkICYmIGJ1Y2tldCkge1xuICAgICAgICAgICAgY29uc3QgYnVja2V0cyA9IHRoaXMudXNlckZhY2V0QnVja2V0c1tmaWVsZC5maWVsZF0gfHwgW107XG4gICAgICAgICAgICB0aGlzLnVzZXJGYWNldEJ1Y2tldHNbZmllbGQuZmllbGRdID0gYnVja2V0c1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGZhY2V0QnVja2V0KSA9PiBmYWNldEJ1Y2tldC5sYWJlbCAhPT0gYnVja2V0LmxhYmVsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmaWx0ZXIgcXVlcnkgdG8gdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHBhcmFtIHF1ZXJ5IFF1ZXJ5IHN0cmluZyB0byBhZGRcbiAgICAgKi9cbiAgICBhZGRGaWx0ZXJRdWVyeShxdWVyeTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmZpbHRlclF1ZXJpZXMuZmluZCgoZmlsdGVyUXVlcnkpID0+IGZpbHRlclF1ZXJ5LnF1ZXJ5ID09PSBxdWVyeSk7XG4gICAgICAgICAgICBpZiAoIWV4aXN0aW5nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJRdWVyaWVzLnB1c2goeyBxdWVyeTogcXVlcnkgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGZpbHRlciBxdWVyeS5cbiAgICAgKiBAcGFyYW0gcXVlcnkgVGhlIHF1ZXJ5IHRvIHJlbW92ZVxuICAgICAqL1xuICAgIHJlbW92ZUZpbHRlclF1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclF1ZXJpZXMgPSB0aGlzLmZpbHRlclF1ZXJpZXNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChmaWx0ZXJRdWVyeSkgPT4gZmlsdGVyUXVlcnkucXVlcnkgIT09IHF1ZXJ5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBxdWVyeSBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIHF1ZXJ5XG4gICAgICogQHJldHVybnMgRmFjZXQgcXVlcnkgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0UXVlcnkobGFiZWw6IHN0cmluZyk6IEZhY2V0UXVlcnkge1xuICAgICAgICBpZiAobGFiZWwgJiYgdGhpcy5oYXNGYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzLmZpbmQoKHF1ZXJ5KSA9PiBxdWVyeS5sYWJlbCA9PT0gbGFiZWwpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLnJlc3VsdCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYSBmYWNldCBmaWVsZCBieSBsYWJlbC5cbiAgICAgKiBAcGFyYW0gbGFiZWwgTGFiZWwgb2YgdGhlIGZhY2V0IGZpZWxkXG4gICAgICogQHJldHVybnMgRmFjZXQgZmllbGQgZGF0YVxuICAgICAqL1xuICAgIGdldEZhY2V0RmllbGQobGFiZWw6IHN0cmluZyk6IEZhY2V0RmllbGQge1xuICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuY29uZmlnLmZhY2V0RmllbGRzLmZpZWxkcyB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQubGFiZWwgPT09IGxhYmVsKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQubGFiZWwgPSB0aGlzLmdldFN1cHBvcnRlZExhYmVsKHJlc3VsdC5sYWJlbCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ucmVzdWx0IH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgc2V0U2NvcGUoc2NvcGU6IFJlcXVlc3RTY29wZSkge1xuICAgICAgICB0aGlzLnNjb3BlID0gc2NvcGU7XG4gICAgfVxuXG4gICAgZ2V0U2NvcGUoKTogUmVxdWVzdFNjb3BlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2NvcGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnVpbGRzIHRoZSBjdXJyZW50IHF1ZXJ5IGFuZCB0cmlnZ2VycyB0aGUgYHVwZGF0ZWRgIGV2ZW50LlxuICAgICAqL1xuICAgIHVwZGF0ZShxdWVyeUJvZHk/OiBRdWVyeUJvZHkpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSBxdWVyeUJvZHkgPyBxdWVyeUJvZHkgOiB0aGlzLmJ1aWxkUXVlcnkoKTtcbiAgICAgICAgdGhpcy51cGRhdGVkLm5leHQocXVlcnkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyBhbmQgZXhlY3V0ZXMgdGhlIGN1cnJlbnQgcXVlcnkuXG4gICAgICogQHJldHVybnMgTm90aGluZ1xuICAgICAqL1xuICAgIGFzeW5jIGV4ZWN1dGUocXVlcnlCb2R5PzogUXVlcnlCb2R5KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBxdWVyeSA9IHF1ZXJ5Qm9keSA/IHF1ZXJ5Qm9keSA6IHRoaXMuYnVpbGRRdWVyeSgpO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0U2V0UGFnaW5nOiBSZXN1bHRTZXRQYWdpbmcgPSBhd2FpdCB0aGlzLmFsZnJlc2NvQXBpU2VydmljZS5nZXRJbnN0YW5jZSgpLnNlYXJjaC5zZWFyY2hBcGkuc2VhcmNoKHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuZXJyb3IubmV4dChlcnJvcik7XG5cbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZWQubmV4dCh7XG4gICAgICAgICAgICAgICAgbGlzdDoge1xuICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEl0ZW1zOiAwXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGVudHJpZXM6IFtdXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZWFyY2gocXVlcnlCb2R5OiBRdWVyeUJvZHkpOiBPYnNlcnZhYmxlPFJlc3VsdFNldFBhZ2luZz4ge1xuICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5hbGZyZXNjb0FwaVNlcnZpY2Uuc2VhcmNoQXBpLnNlYXJjaChxdWVyeUJvZHkpO1xuXG4gICAgICAgIHByb21pc2UudGhlbigocmVzdWx0U2V0UGFnaW5nKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGVkLm5leHQocmVzdWx0U2V0UGFnaW5nKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZyb20ocHJvbWlzZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnVpbGRzIHRoZSBjdXJyZW50IHF1ZXJ5LlxuICAgICAqIEByZXR1cm5zIFRoZSBmaW5pc2hlZCBxdWVyeVxuICAgICAqL1xuICAgIGJ1aWxkUXVlcnkoKTogUXVlcnlCb2R5IHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLmdldEZpbmFsUXVlcnkoKTtcblxuICAgICAgICBjb25zdCBpbmNsdWRlID0gdGhpcy5jb25maWcuaW5jbHVkZSB8fCBbXTtcbiAgICAgICAgaWYgKGluY2x1ZGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBpbmNsdWRlLnB1c2goJ3BhdGgnLCAnYWxsb3dhYmxlT3BlcmF0aW9ucycpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogUXVlcnlCb2R5ID0gPFF1ZXJ5Qm9keT4ge1xuICAgICAgICAgICAgICAgIHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2U6ICdhZnRzJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaW5jbHVkZTogaW5jbHVkZSxcbiAgICAgICAgICAgICAgICBwYWdpbmc6IHRoaXMucGFnaW5nLFxuICAgICAgICAgICAgICAgIGZpZWxkczogdGhpcy5jb25maWcuZmllbGRzLFxuICAgICAgICAgICAgICAgIGZpbHRlclF1ZXJpZXM6IHRoaXMuZmlsdGVyUXVlcmllcyxcbiAgICAgICAgICAgICAgICBmYWNldFF1ZXJpZXM6IHRoaXMuZmFjZXRRdWVyaWVzLFxuICAgICAgICAgICAgICAgIGZhY2V0SW50ZXJ2YWxzOiB0aGlzLmZhY2V0SW50ZXJ2YWxzLFxuICAgICAgICAgICAgICAgIGZhY2V0RmllbGRzOiB0aGlzLmZhY2V0RmllbGRzLFxuICAgICAgICAgICAgICAgIHNvcnQ6IHRoaXMuc29ydCxcbiAgICAgICAgICAgICAgICBoaWdobGlnaHQ6IHRoaXMuaGlnaGxpZ2h0XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zY29wZSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdFsnc2NvcGUnXSA9IHRoaXMuc2NvcGU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc3VsdFsnZmFjZXRGb3JtYXQnXSA9ICdWMic7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgcHJpbWFyeSBzb3J0aW5nIGRlZmluaXRpb24uXG4gICAgICogQHJldHVybnMgVGhlIHByaW1hcnkgc29ydGluZyBkZWZpbml0aW9uXG4gICAgICovXG4gICAgZ2V0UHJpbWFyeVNvcnRpbmcoKTogU2VhcmNoU29ydGluZ0RlZmluaXRpb24ge1xuICAgICAgICBpZiAodGhpcy5zb3J0aW5nICYmIHRoaXMuc29ydGluZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zb3J0aW5nWzBdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgYWxsIHByZS1jb25maWd1cmVkIHNvcnRpbmcgb3B0aW9ucyB0aGF0IHVzZXJzIGNhbiBjaG9vc2UgZnJvbS5cbiAgICAgKiBAcmV0dXJucyBQcmUtY29uZmlndXJlZCBzb3J0aW5nIG9wdGlvbnNcbiAgICAgKi9cbiAgICBnZXRTb3J0aW5nT3B0aW9ucygpOiBTZWFyY2hTb3J0aW5nRGVmaW5pdGlvbltdIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLnNvcnRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5zb3J0aW5nLm9wdGlvbnMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHF1ZXJ5IGdyb3VwLlxuICAgICAqIEBwYXJhbSBxdWVyeSBUYXJnZXQgcXVlcnlcbiAgICAgKiBAcmV0dXJucyBRdWVyeSBncm91cFxuICAgICAqL1xuICAgIGdldFF1ZXJ5R3JvdXAocXVlcnkpIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5Lmdyb3VwIHx8IHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5sYWJlbCB8fCAnRmFjZXQgUXVlcmllcyc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIEZhY2V0UXVlcmllcyBoYXMgYmVlbiBkZWZpbmVkXG4gICAgICogQHJldHVybnMgVHJ1ZSBpZiBkZWZpbmVkLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBnZXQgaGFzRmFjZXRRdWVyaWVzKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodGhpcy5jb25maWdcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0UXVlcmllc1xuICAgICAgICAgICAgJiYgdGhpcy5jb25maWcuZmFjZXRRdWVyaWVzLnF1ZXJpZXNcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0UXVlcmllcy5xdWVyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgaWYgRmFjZXRJbnRlcnZhbHMgaGFzIGJlZW4gZGVmaW5lZFxuICAgICAqIEByZXR1cm5zIFRydWUgaWYgZGVmaW5lZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgZ2V0IGhhc0ZhY2V0SW50ZXJ2YWxzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25maWdcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0SW50ZXJ2YWxzXG4gICAgICAgICAgICAmJiB0aGlzLmNvbmZpZy5mYWNldEludGVydmFscy5pbnRlcnZhbHNcbiAgICAgICAgICAgICYmIHRoaXMuY29uZmlnLmZhY2V0SW50ZXJ2YWxzLmludGVydmFscy5sZW5ndGggPiAwO1xuXG4gICAgfVxuXG4gICAgZ2V0IGhhc0ZhY2V0SGlnaGxpZ2h0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuaGlnaGxpZ2h0ID8gdHJ1ZSA6IGZhbHNlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgc29ydCgpOiBSZXF1ZXN0U29ydERlZmluaXRpb25Jbm5lcltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc29ydGluZy5tYXAoKGRlZikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZXF1ZXN0U29ydERlZmluaXRpb25Jbm5lcih7XG4gICAgICAgICAgICAgICAgdHlwZTogZGVmLnR5cGUsXG4gICAgICAgICAgICAgICAgZmllbGQ6IGRlZi5maWVsZCxcbiAgICAgICAgICAgICAgICBhc2NlbmRpbmc6IGRlZi5hc2NlbmRpbmdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IGZhY2V0UXVlcmllcygpOiBGYWNldFF1ZXJ5W10ge1xuICAgICAgICBpZiAodGhpcy5oYXNGYWNldFF1ZXJpZXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5mYWNldFF1ZXJpZXMucXVlcmllcy5tYXAoKHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgcXVlcnkuZ3JvdXAgPSB0aGlzLmdldFF1ZXJ5R3JvdXAocXVlcnkpO1xuICAgICAgICAgICAgICAgIHJldHVybiA8RmFjZXRRdWVyeT4geyAuLi5xdWVyeSB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IGZhY2V0SW50ZXJ2YWxzKCk6IGFueSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0ZhY2V0SW50ZXJ2YWxzKSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWdJbnRlcnZhbHMgPSB0aGlzLmNvbmZpZy5mYWNldEludGVydmFscztcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpbnRlcnZhbHM6IGNvbmZpZ0ludGVydmFscy5pbnRlcnZhbHMubWFwKChpbnRlcnZhbCkgPT4gPGFueT4ge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbDogdGhpcy5nZXRTdXBwb3J0ZWRMYWJlbChpbnRlcnZhbC5sYWJlbCksXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkOiBpbnRlcnZhbC5maWVsZCxcbiAgICAgICAgICAgICAgICAgICAgc2V0czogaW50ZXJ2YWwuc2V0cy5tYXAoKHNldCkgPT4gPGFueT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMuZ2V0U3VwcG9ydGVkTGFiZWwoc2V0LmxhYmVsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzZXQuc3RhcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQ6IHNldC5lbmQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydEluY2x1c2l2ZTogc2V0LnN0YXJ0SW5jbHVzaXZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kSW5jbHVzaXZlOiBzZXQuZW5kSW5jbHVzaXZlXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IGhpZ2hsaWdodCgpOiBSZXF1ZXN0SGlnaGxpZ2h0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzRmFjZXRIaWdobGlnaHQgPyB0aGlzLmNvbmZpZy5oaWdobGlnaHQgOiBudWxsO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRGaW5hbFF1ZXJ5KCk6IHN0cmluZyB7XG4gICAgICAgIGxldCBxdWVyeSA9ICcnO1xuXG4gICAgICAgIHRoaXMuY2F0ZWdvcmllcy5mb3JFYWNoKChmYWNldCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY3VzdG9tUXVlcnkgPSB0aGlzLnF1ZXJ5RnJhZ21lbnRzW2ZhY2V0LmlkXTtcbiAgICAgICAgICAgIGlmIChjdXN0b21RdWVyeSkge1xuICAgICAgICAgICAgICAgIGlmIChxdWVyeS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5ICs9ICcgQU5EICc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHF1ZXJ5ICs9IGAoJHtjdXN0b21RdWVyeX0pYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IFt0aGlzLnVzZXJRdWVyeSwgcXVlcnldXG4gICAgICAgICAgICAuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkpXG4gICAgICAgICAgICAuam9pbignIEFORCAnKTtcblxuICAgICAgICBpZiAodGhpcy51c2VyRmFjZXRCdWNrZXRzKSB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLnVzZXJGYWNldEJ1Y2tldHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YlF1ZXJ5ID0gKHRoaXMudXNlckZhY2V0QnVja2V0c1trZXldIHx8IFtdKVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChidWNrZXQpID0+IGJ1Y2tldC5maWx0ZXJRdWVyeSlcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgoYnVja2V0KSA9PiBidWNrZXQuZmlsdGVyUXVlcnkpXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKCcgT1IgJyk7XG4gICAgICAgICAgICAgICAgaWYgKHN1YlF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICcgQU5EICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IGAoJHtzdWJRdWVyeX0pYDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBmYWNldEZpZWxkcygpOiBSZXF1ZXN0RmFjZXRGaWVsZHMge1xuICAgICAgICBjb25zdCBmYWNldEZpZWxkcyA9IHRoaXMuY29uZmlnLmZhY2V0RmllbGRzICYmIHRoaXMuY29uZmlnLmZhY2V0RmllbGRzLmZpZWxkcztcblxuICAgICAgICBpZiAoZmFjZXRGaWVsZHMgJiYgZmFjZXRGaWVsZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBmYWNldHM6IGZhY2V0RmllbGRzLm1hcCgoZmFjZXQpID0+IDxSZXF1ZXN0RmFjZXRGaWVsZD4ge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZDogZmFjZXQuZmllbGQsXG4gICAgICAgICAgICAgICAgICAgIG1pbmNvdW50OiBmYWNldC5taW5jb3VudCxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHRoaXMuZ2V0U3VwcG9ydGVkTGFiZWwoZmFjZXQubGFiZWwpLFxuICAgICAgICAgICAgICAgICAgICBsaW1pdDogZmFjZXQubGltaXQsXG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogZmFjZXQub2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICBwcmVmaXg6IGZhY2V0LnByZWZpeFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRW5jbG9zZXMgYSBsYWJlbCBuYW1lIHdpdGggZG91YmxlIHF1b3RlcyBpZiBpdCBjb250YWlucyB3aGl0ZXNwYWNlIGNoYXJhY3RlcnMuXG4gICAgICogQHBhcmFtIGNvbmZpZ0xhYmVsIE9yaWdpbmFsIGxhYmVsIHRleHRcbiAgICAgKiBAcmV0dXJucyBMYWJlbCwgcG9zc2libHkgd2l0aCBxdW90ZXMgaWYgaXQgY29udGFpbnMgc3BhY2VzXG4gICAgICovXG4gICAgZ2V0U3VwcG9ydGVkTGFiZWwoY29uZmlnTGFiZWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHNwYWNlSW5zaWRlTGFiZWxJbmRleCA9IGNvbmZpZ0xhYmVsLnNlYXJjaCgvXFxzL2cpO1xuICAgICAgICBpZiAoc3BhY2VJbnNpZGVMYWJlbEluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIHJldHVybiBgXCIke2NvbmZpZ0xhYmVsfVwiYDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29uZmlnTGFiZWw7XG4gICAgfVxufVxuIl19
import { AlfrescoApiService, LogService } from '@alfresco/adf-core';
import { SearchRequest, SiteMemberPaging, PeopleApi, SitesApi, SearchApi, FavoritesApi, SharedlinksApi, TrashcanApi, NodesApi } from '@alfresco/js-api';
import { Injectable } from '@angular/core';
import { Observable, from, of, throwError } from 'rxjs';
import { catchError, map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@alfresco/adf-core";
export class CustomResourcesService {
    constructor(apiService, logService) {
        this.apiService = apiService;
        this.logService = logService;
        this.CREATE_PERMISSION = 'create';
    }
    get api() {
        return this.apiService.getInstance();
    }
    get peopleApi() {
        return this._peopleApi || (this._peopleApi = new PeopleApi(this.api));
    }
    get sitesApi() {
        return this._sitesApi || (this._sitesApi = new SitesApi(this.api));
    }
    get searchApi() {
        return this._searchApi || (this._searchApi = new SearchApi(this.api));
    }
    get favoritesApi() {
        return this._favoritesApi || (this._favoritesApi = new FavoritesApi(this.api));
    }
    get sharedLinksApi() {
        return this._sharedLinksApi || (this._sharedLinksApi = new SharedlinksApi(this.api));
    }
    get trashcanApi() {
        return this._trashcanApi || (this._trashcanApi = new TrashcanApi(this.api));
    }
    get nodesApi() {
        return this._nodesApi || (this._nodesApi = new NodesApi(this.api));
    }
    getRecentFiles(personId, pagination, filters) {
        const defaultFilter = [
            'TYPE:"content"',
            '-PNAME:"0/wiki"',
            '-TYPE:"app:filelink"',
            '-TYPE:"cm:thumbnail"',
            '-TYPE:"cm:failedThumbnail"',
            '-TYPE:"cm:rating"',
            '-TYPE:"dl:dataList"',
            '-TYPE:"dl:todoList"',
            '-TYPE:"dl:issue"',
            '-TYPE:"dl:contact"',
            '-TYPE:"dl:eventAgenda"',
            '-TYPE:"dl:event"',
            '-TYPE:"dl:task"',
            '-TYPE:"dl:simpletask"',
            '-TYPE:"dl:meetingAgenda"',
            '-TYPE:"dl:location"',
            '-TYPE:"fm:topic"',
            '-TYPE:"fm:post"',
            '-TYPE:"ia:calendarEvent"',
            '-TYPE:"lnk:link"'
        ];
        return new Observable((observer) => {
            this.peopleApi.getPerson(personId)
                .then((person) => {
                const username = person.entry.id;
                const filterQueries = [
                    { query: `cm:modified:[NOW/DAY-30DAYS TO NOW/DAY+1DAY]` },
                    { query: `cm:modifier:${username} OR cm:creator:${username}` },
                    { query: defaultFilter.join(' AND ') }
                ];
                if (filters && filters.length > 0) {
                    filterQueries.push({
                        query: filters.join()
                    });
                }
                const query = new SearchRequest({
                    query: {
                        query: '*',
                        language: 'afts'
                    },
                    filterQueries,
                    include: ['path', 'properties', 'allowableOperations'],
                    sort: [{
                            type: 'FIELD',
                            field: 'cm:modified',
                            ascending: false
                        }],
                    paging: {
                        maxItems: pagination.maxItems,
                        skipCount: pagination.skipCount
                    }
                });
                return this.searchApi.search(query)
                    .then((searchResult) => {
                    observer.next(searchResult);
                    observer.complete();
                }, (err) => {
                    observer.error(err);
                    observer.complete();
                });
            }, (err) => {
                observer.error(err);
                observer.complete();
            });
        }).pipe(catchError((err) => this.handleError(err)));
    }
    loadFavorites(pagination, includeFields = [], where) {
        const includeFieldsRequest = this.getIncludesFields(includeFields);
        const defaultPredicate = '(EXISTS(target/file) OR EXISTS(target/folder))';
        const options = {
            maxItems: pagination.maxItems,
            skipCount: pagination.skipCount,
            where: where ? `${where} AND ${defaultPredicate}` : defaultPredicate,
            include: includeFieldsRequest
        };
        return new Observable((observer) => {
            this.favoritesApi.listFavorites('-me-', options)
                .then((result) => {
                const page = {
                    list: {
                        entries: result.list.entries
                            .map(({ entry }) => {
                            const target = entry.target.file || entry.target.folder;
                            target.properties = Object.assign(Object.assign({}, (target.properties || {
                                'cm:title': entry.title || target.title,
                                'cm:description': entry.description || target.description
                            })), (entry.properties || {}));
                            return {
                                entry: target
                            };
                        }),
                        pagination: result.list.pagination
                    }
                };
                observer.next(page);
                observer.complete();
            }, (err) => {
                observer.error(err);
                observer.complete();
            });
        }).pipe(catchError((err) => this.handleError(err)));
    }
    loadMemberSites(pagination, where) {
        const options = {
            include: ['properties'],
            maxItems: pagination.maxItems,
            skipCount: pagination.skipCount,
            where
        };
        return new Observable((observer) => {
            this.sitesApi.listSiteMembershipsForPerson('-me-', options)
                .then((result) => {
                const page = new SiteMemberPaging({
                    list: {
                        entries: result.list.entries
                            .map(({ entry: { site } }) => {
                            site.allowableOperations = site.allowableOperations ? site.allowableOperations : [this.CREATE_PERMISSION];
                            site.name = site.name || site.title;
                            return {
                                entry: site
                            };
                        }),
                        pagination: result.list.pagination
                    }
                });
                observer.next(page);
                observer.complete();
            }, (err) => {
                observer.error(err);
                observer.complete();
            });
        }).pipe(catchError((err) => this.handleError(err)));
    }
    loadSites(pagination, where) {
        const options = {
            include: ['properties', 'aspectNames'],
            maxItems: pagination.maxItems,
            skipCount: pagination.skipCount,
            where
        };
        return new Observable((observer) => {
            this.sitesApi
                .listSites(options)
                .then((page) => {
                page.list.entries.map(({ entry }) => {
                    entry.name = entry.name || entry.title;
                    return { entry };
                });
                observer.next(page);
                observer.complete();
            }, (err) => {
                observer.error(err);
                observer.complete();
            });
        }).pipe(catchError((err) => this.handleError(err)));
    }
    loadTrashcan(pagination, includeFields = []) {
        const includeFieldsRequest = this.getIncludesFields(includeFields);
        const options = {
            include: includeFieldsRequest,
            maxItems: pagination.maxItems,
            skipCount: pagination.skipCount
        };
        return from(this.trashcanApi.listDeletedNodes(options))
            .pipe(catchError((err) => this.handleError(err)));
    }
    loadSharedLinks(pagination, includeFields = [], where) {
        const includeFieldsRequest = this.getIncludesFields(includeFields);
        const options = {
            include: includeFieldsRequest,
            maxItems: pagination.maxItems,
            skipCount: pagination.skipCount,
            where
        };
        return from(this.sharedLinksApi.listSharedLinks(options))
            .pipe(catchError((err) => this.handleError(err)));
    }
    isCustomSource(folderId) {
        let isCustomSources = false;
        const sources = ['-trashcan-', '-sharedlinks-', '-sites-', '-mysites-', '-favorites-', '-recent-'];
        if (sources.indexOf(folderId) > -1) {
            isCustomSources = true;
        }
        return isCustomSources;
    }
    isSupportedSource(folderId) {
        let isSupportedSources = false;
        const sources = ['-my-', '-root-', '-shared-'];
        if (sources.indexOf(folderId) > -1) {
            isSupportedSources = true;
        }
        return isSupportedSources;
    }
    loadFolderByNodeId(nodeId, pagination, includeFields = [], where) {
        if (nodeId === '-trashcan-') {
            return this.loadTrashcan(pagination, includeFields);
        }
        else if (nodeId === '-sharedlinks-') {
            return this.loadSharedLinks(pagination, includeFields, where);
        }
        else if (nodeId === '-sites-') {
            return this.loadSites(pagination, where);
        }
        else if (nodeId === '-mysites-') {
            return this.loadMemberSites(pagination, where);
        }
        else if (nodeId === '-favorites-') {
            return this.loadFavorites(pagination, includeFields, where);
        }
        else if (nodeId === '-recent-') {
            return this.getRecentFiles('-me-', pagination);
        }
    }
    getCorrespondingNodeIds(nodeId, pagination = {}) {
        if (this.isCustomSource(nodeId)) {
            return this.loadFolderByNodeId(nodeId, pagination)
                .pipe(map((result) => {
                return result.list.entries.map((node) => this.getIdFromEntry(node, nodeId));
            }));
        }
        else if (nodeId) {
            return from(this.nodesApi.getNode(nodeId)
                .then((node) => [node.entry.id]));
        }
        return of([]);
    }
    getIdFromEntry(node, nodeId) {
        if (nodeId === '-sharedlinks-') {
            return node.entry.nodeId;
        }
        else if (nodeId === '-sites-' || nodeId === '-mysites-') {
            return node.entry.guid;
        }
        else if (nodeId === '-favorites-') {
            return node.entry.targetGuid;
        }
        else {
            return node.entry.id;
        }
    }
    hasCorrespondingNodeIds(nodeId) {
        return this.isCustomSource(nodeId) || this.isSupportedSource(nodeId);
    }
    getIncludesFields(includeFields) {
        return ['path', 'properties', 'allowableOperations', 'permissions', 'aspectNames', ...includeFields]
            .filter((element, index, array) => index === array.indexOf(element));
    }
    handleError(error) {
        this.logService.error(error);
        return throwError(error || 'Server error');
    }
}
CustomResourcesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function CustomResourcesService_Factory() { return new CustomResourcesService(i0.ɵɵinject(i1.AlfrescoApiService), i0.ɵɵinject(i1.LogService)); }, token: CustomResourcesService, providedIn: "root" });
CustomResourcesService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
CustomResourcesService.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: LogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLXJlc291cmNlcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL3RyYXZpcy9idWlsZC9BbGZyZXNjby9hbGZyZXNjby1uZzItY29tcG9uZW50cy9saWIvY29udGVudC1zZXJ2aWNlcy9zcmMvIiwic291cmNlcyI6WyJsaWIvZG9jdW1lbnQtbGlzdC9zZXJ2aWNlcy9jdXN0b20tcmVzb3VyY2VzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBaUJBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQW1CLE1BQU0sb0JBQW9CLENBQUM7QUFDckYsT0FBTyxFQUdILGFBQWEsRUFHYixnQkFBZ0IsRUFFaEIsU0FBUyxFQUNULFFBQVEsRUFDUixTQUFTLEVBQ1QsWUFBWSxFQUNaLGNBQWMsRUFDZCxXQUFXLEVBQ1gsUUFBUSxFQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQUdqRCxNQUFNLE9BQU8sc0JBQXNCO0lBWS9CLFlBQW9CLFVBQThCLEVBQVUsVUFBc0I7UUFBOUQsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBVjFFLHNCQUFpQixHQUFHLFFBQVEsQ0FBQztJQVVnRCxDQUFDO0lBRXRGLElBQVksR0FBRztRQUNYLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN6QyxDQUFDO0lBRUQsSUFBSSxTQUFTO1FBQ1QsT0FBTyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxD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Q0FBQztJQUM3RSxDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQWU7UUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsT0FBTyxVQUFVLENBQUMsS0FBSyxJQUFJLGNBQWMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7Ozs7WUE3WkosVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7O1lBckJ6QixrQkFBa0I7WUFBRSxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMTkgQWxmcmVzY28gU29mdHdhcmUsIEx0ZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQWxmcmVzY29BcGlTZXJ2aWNlLCBMb2dTZXJ2aWNlLCBQYWdpbmF0aW9uTW9kZWwgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHtcbiAgICBOb2RlUGFnaW5nLFxuICAgIERlbGV0ZWROb2Rlc1BhZ2luZyxcbiAgICBTZWFyY2hSZXF1ZXN0LFxuICAgIFNoYXJlZExpbmtQYWdpbmcsXG4gICAgRmF2b3JpdGVQYWdpbmcsXG4gICAgU2l0ZU1lbWJlclBhZ2luZyxcbiAgICBTaXRlUm9sZVBhZ2luZyxcbiAgICBQZW9wbGVBcGksXG4gICAgU2l0ZXNBcGksXG4gICAgU2VhcmNoQXBpLFxuICAgIEZhdm9yaXRlc0FwaSxcbiAgICBTaGFyZWRsaW5rc0FwaSxcbiAgICBUcmFzaGNhbkFwaSxcbiAgICBOb2Rlc0FwaVxufSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgQ3VzdG9tUmVzb3VyY2VzU2VydmljZSB7XG5cbiAgICBwcml2YXRlIENSRUFURV9QRVJNSVNTSU9OID0gJ2NyZWF0ZSc7XG5cbiAgICBwcml2YXRlIF9wZW9wbGVBcGk6IFBlb3BsZUFwaTtcbiAgICBwcml2YXRlIF9zaXRlc0FwaTogU2l0ZXNBcGk7XG4gICAgcHJpdmF0ZSBfdHJhc2hjYW5BcGk6IFRyYXNoY2FuQXBpO1xuICAgIHByaXZhdGUgX3NlYXJjaEFwaTogU2VhcmNoQXBpO1xuICAgIHByaXZhdGUgX3NoYXJlZExpbmtzQXBpOiBTaGFyZWRsaW5rc0FwaTtcbiAgICBwcml2YXRlIF9mYXZvcml0ZXNBcGk6IEZhdm9yaXRlc0FwaTtcbiAgICBwcml2YXRlIF9ub2Rlc0FwaTogTm9kZXNBcGk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSwgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7fVxuXG4gICAgcHJpdmF0ZSBnZXQgYXBpKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgfVxuXG4gICAgZ2V0IHBlb3BsZUFwaSgpOiBQZW9wbGVBcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcGVvcGxlQXBpIHx8ICh0aGlzLl9wZW9wbGVBcGkgPSBuZXcgUGVvcGxlQXBpKHRoaXMuYXBpKSk7XG4gICAgfVxuXG4gICAgZ2V0IHNpdGVzQXBpKCk6IFNpdGVzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpdGVzQXBpIHx8ICh0aGlzLl9zaXRlc0FwaSA9IG5ldyBTaXRlc0FwaSh0aGlzLmFwaSkpO1xuICAgIH1cblxuICAgIGdldCBzZWFyY2hBcGkoKTogU2VhcmNoQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlYXJjaEFwaSB8fCAodGhpcy5fc2VhcmNoQXBpID0gbmV3IFNlYXJjaEFwaSh0aGlzLmFwaSkpO1xuICAgIH1cblxuICAgIGdldCBmYXZvcml0ZXNBcGkoKTogRmF2b3JpdGVzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Zhdm9yaXRlc0FwaSB8fCAodGhpcy5fZmF2b3JpdGVzQXBpID0gbmV3IEZhdm9yaXRlc0FwaSh0aGlzLmFwaSkpO1xuICAgIH1cblxuICAgIGdldCBzaGFyZWRMaW5rc0FwaSgpOiBTaGFyZWRsaW5rc0FwaSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zaGFyZWRMaW5rc0FwaSB8fCAodGhpcy5fc2hhcmVkTGlua3NBcGkgPSBuZXcgU2hhcmVkbGlua3NBcGkodGhpcy5hcGkpKTtcbiAgICB9XG5cbiAgICBnZXQgdHJhc2hjYW5BcGkoKTogVHJhc2hjYW5BcGkge1xuICAgICAgICByZXR1cm4gdGhpcy5fdHJhc2hjYW5BcGkgfHwgKHRoaXMuX3RyYXNoY2FuQXBpID0gbmV3IFRyYXNoY2FuQXBpKHRoaXMuYXBpKSk7XG4gICAgfVxuXG4gICAgZ2V0IG5vZGVzQXBpKCk6IE5vZGVzQXBpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX25vZGVzQXBpIHx8ICh0aGlzLl9ub2Rlc0FwaSA9IG5ldyBOb2Rlc0FwaSh0aGlzLmFwaSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZmlsZXMgcmVjZW50bHkgYWNjZXNzZWQgYnkgYSB1c2VyLlxuICAgICAqIEBwYXJhbSBwZXJzb25JZCBJRCBvZiB0aGUgdXNlclxuICAgICAqIEBwYXJhbSBwYWdpbmF0aW9uIFNwZWNpZmllcyBob3cgdG8gcGFnaW5hdGUgdGhlIHJlc3VsdHNcbiAgICAgKiBAcGFyYW0gZmlsdGVycyBTcGVjaWZpZXMgYWRkaXRpb25hbCBmaWx0ZXJzIHRvIGFwcGx5IChqb2luZWQgd2l0aCAqKkFORCoqKVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2Ygbm9kZXMgZm9yIHRoZSByZWNlbnRseSB1c2VkIGZpbGVzXG4gICAgICovXG4gICAgZ2V0UmVjZW50RmlsZXMocGVyc29uSWQ6IHN0cmluZywgcGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsLCBmaWx0ZXJzPzogc3RyaW5nW10pOiBPYnNlcnZhYmxlPE5vZGVQYWdpbmc+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEZpbHRlciA9IFtcbiAgICAgICAgICAgICdUWVBFOlwiY29udGVudFwiJyxcbiAgICAgICAgICAgICctUE5BTUU6XCIwL3dpa2lcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJhcHA6ZmlsZWxpbmtcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJjbTp0aHVtYm5haWxcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJjbTpmYWlsZWRUaHVtYm5haWxcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJjbTpyYXRpbmdcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJkbDpkYXRhTGlzdFwiJyxcbiAgICAgICAgICAgICctVFlQRTpcImRsOnRvZG9MaXN0XCInLFxuICAgICAgICAgICAgJy1UWVBFOlwiZGw6aXNzdWVcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJkbDpjb250YWN0XCInLFxuICAgICAgICAgICAgJy1UWVBFOlwiZGw6ZXZlbnRBZ2VuZGFcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJkbDpldmVudFwiJyxcbiAgICAgICAgICAgICctVFlQRTpcImRsOnRhc2tcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJkbDpzaW1wbGV0YXNrXCInLFxuICAgICAgICAgICAgJy1UWVBFOlwiZGw6bWVldGluZ0FnZW5kYVwiJyxcbiAgICAgICAgICAgICctVFlQRTpcImRsOmxvY2F0aW9uXCInLFxuICAgICAgICAgICAgJy1UWVBFOlwiZm06dG9waWNcIicsXG4gICAgICAgICAgICAnLVRZUEU6XCJmbTpwb3N0XCInLFxuICAgICAgICAgICAgJy1UWVBFOlwiaWE6Y2FsZW5kYXJFdmVudFwiJyxcbiAgICAgICAgICAgICctVFlQRTpcImxuazpsaW5rXCInXG4gICAgICAgIF07XG5cbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5wZW9wbGVBcGkuZ2V0UGVyc29uKHBlcnNvbklkKVxuICAgICAgICAgICAgICAgIC50aGVuKChwZXJzb24pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJuYW1lID0gcGVyc29uLmVudHJ5LmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyUXVlcmllcyA9IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHF1ZXJ5OiBgY206bW9kaWZpZWQ6W05PVy9EQVktMzBEQVlTIFRPIE5PVy9EQVkrMURBWV1gIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBxdWVyeTogYGNtOm1vZGlmaWVyOiR7dXNlcm5hbWV9IE9SIGNtOmNyZWF0b3I6JHt1c2VybmFtZX1gIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBxdWVyeTogZGVmYXVsdEZpbHRlci5qb2luKCcgQU5EICcpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclF1ZXJpZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBmaWx0ZXJzLmpvaW4oKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWVyeSA9IG5ldyBTZWFyY2hSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVyeTogJyonLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5ndWFnZTogJ2FmdHMnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJRdWVyaWVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGU6IFsncGF0aCcsICdwcm9wZXJ0aWVzJywgJ2FsbG93YWJsZU9wZXJhdGlvbnMnXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0OiBbe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnRklFTEQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogJ2NtOm1vZGlmaWVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNjZW5kaW5nOiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luZzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhJdGVtczogcGFnaW5hdGlvbi5tYXhJdGVtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2tpcENvdW50OiBwYWdpbmF0aW9uLnNraXBDb3VudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoQXBpLnNlYXJjaChxdWVyeSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoc2VhcmNoUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHNlYXJjaFJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSkucGlwZShjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgZmF2b3JpdGUgZmlsZXMgZm9yIHRoZSBjdXJyZW50IHVzZXIuXG4gICAgICogQHBhcmFtIHBhZ2luYXRpb24gU3BlY2lmaWVzIGhvdyB0byBwYWdpbmF0ZSB0aGUgcmVzdWx0c1xuICAgICAqIEBwYXJhbSBpbmNsdWRlRmllbGRzIExpc3Qgb2YgZGF0YSBmaWVsZCBuYW1lcyB0byBpbmNsdWRlIGluIHRoZSByZXN1bHRzXG4gICAgICogQHBhcmFtIHdoZXJlIEEgc3RyaW5nIHRvIHJlc3RyaWN0IHRoZSByZXR1cm5lZCBvYmplY3RzIGJ5IHVzaW5nIGEgcHJlZGljYXRlXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBmYXZvcml0ZSBmaWxlc1xuICAgICAqL1xuICAgIGxvYWRGYXZvcml0ZXMocGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsLCBpbmNsdWRlRmllbGRzOiBzdHJpbmdbXSA9IFtdLCB3aGVyZT86IHN0cmluZyk6IE9ic2VydmFibGU8Tm9kZVBhZ2luZz4ge1xuICAgICAgICBjb25zdCBpbmNsdWRlRmllbGRzUmVxdWVzdCA9IHRoaXMuZ2V0SW5jbHVkZXNGaWVsZHMoaW5jbHVkZUZpZWxkcyk7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRQcmVkaWNhdGUgPSAnKEVYSVNUUyh0YXJnZXQvZmlsZSkgT1IgRVhJU1RTKHRhcmdldC9mb2xkZXIpKSc7XG5cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG1heEl0ZW1zOiBwYWdpbmF0aW9uLm1heEl0ZW1zLFxuICAgICAgICAgICAgc2tpcENvdW50OiBwYWdpbmF0aW9uLnNraXBDb3VudCxcbiAgICAgICAgICAgIHdoZXJlOiB3aGVyZSA/IGAke3doZXJlfSBBTkQgJHtkZWZhdWx0UHJlZGljYXRlfWAgOiBkZWZhdWx0UHJlZGljYXRlICxcbiAgICAgICAgICAgIGluY2x1ZGU6IGluY2x1ZGVGaWVsZHNSZXF1ZXN0XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5mYXZvcml0ZXNBcGkubGlzdEZhdm9yaXRlcygnLW1lLScsIG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdDogRmF2b3JpdGVQYWdpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhZ2U6IEZhdm9yaXRlUGFnaW5nID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cmllczogcmVzdWx0Lmxpc3QuZW50cmllc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgoeyBlbnRyeSB9OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZW50cnkudGFyZ2V0LmZpbGUgfHwgZW50cnkudGFyZ2V0LmZvbGRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnByb3BlcnRpZXMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi4odGFyZ2V0LnByb3BlcnRpZXMgfHwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY206dGl0bGUnOiBlbnRyeS50aXRsZSB8fCB0YXJnZXQudGl0bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbTpkZXNjcmlwdGlvbic6IGVudHJ5LmRlc2NyaXB0aW9uIHx8IHRhcmdldC5kZXNjcmlwdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uKGVudHJ5LnByb3BlcnRpZXMgfHwge30pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5OiB0YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiByZXN1bHQubGlzdC5wYWdpbmF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChwYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSkucGlwZShjYXRjaEVycm9yKChlcnIpID0+IHRoaXMuaGFuZGxlRXJyb3IoZXJyKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgc2l0ZXMgdGhhdCB0aGUgY3VycmVudCB1c2VyIGlzIGEgbWVtYmVyIG9mLlxuICAgICAqIEBwYXJhbSBwYWdpbmF0aW9uIFNwZWNpZmllcyBob3cgdG8gcGFnaW5hdGUgdGhlIHJlc3VsdHNcbiAgICAgKiBAcGFyYW0gd2hlcmUgQSBzdHJpbmcgdG8gcmVzdHJpY3QgdGhlIHJldHVybmVkIG9iamVjdHMgYnkgdXNpbmcgYSBwcmVkaWNhdGVcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHNpdGVzXG4gICAgICovXG4gICAgbG9hZE1lbWJlclNpdGVzKHBhZ2luYXRpb246IFBhZ2luYXRpb25Nb2RlbCwgd2hlcmU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNpdGVNZW1iZXJQYWdpbmc+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IFsncHJvcGVydGllcyddLFxuICAgICAgICAgICAgbWF4SXRlbXM6IHBhZ2luYXRpb24ubWF4SXRlbXMsXG4gICAgICAgICAgICBza2lwQ291bnQ6IHBhZ2luYXRpb24uc2tpcENvdW50LFxuICAgICAgICAgICAgd2hlcmVcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNpdGVzQXBpLmxpc3RTaXRlTWVtYmVyc2hpcHNGb3JQZXJzb24oJy1tZS0nLCBvcHRpb25zKVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHQ6IFNpdGVSb2xlUGFnaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYWdlOiBTaXRlTWVtYmVyUGFnaW5nID0gbmV3IFNpdGVNZW1iZXJQYWdpbmcoIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXM6IHJlc3VsdC5saXN0LmVudHJpZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKHsgZW50cnk6IHsgc2l0ZSB9IH06IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpdGUuYWxsb3dhYmxlT3BlcmF0aW9ucyA9IHNpdGUuYWxsb3dhYmxlT3BlcmF0aW9ucyA/IHNpdGUuYWxsb3dhYmxlT3BlcmF0aW9ucyA6IFt0aGlzLkNSRUFURV9QRVJNSVNTSU9OXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXRlLm5hbWUgPSBzaXRlLm5hbWUgfHwgc2l0ZS50aXRsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeTogc2l0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbjogcmVzdWx0Lmxpc3QucGFnaW5hdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHBhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5waXBlKGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgc2l0ZXMgaW4gdGhlIHJlcG9zaXRvcnkuXG4gICAgICogQHBhcmFtIHBhZ2luYXRpb24gU3BlY2lmaWVzIGhvdyB0byBwYWdpbmF0ZSB0aGUgcmVzdWx0c1xuICAgICAqIEBwYXJhbSB3aGVyZSBBIHN0cmluZyB0byByZXN0cmljdCB0aGUgcmV0dXJuZWQgb2JqZWN0cyBieSB1c2luZyBhIHByZWRpY2F0ZVxuICAgICAqIEByZXR1cm5zIExpc3Qgb2Ygc2l0ZXNcbiAgICAgKi9cbiAgICBsb2FkU2l0ZXMocGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsLCB3aGVyZT86IHN0cmluZyk6IE9ic2VydmFibGU8Tm9kZVBhZ2luZz4ge1xuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAgaW5jbHVkZTogWydwcm9wZXJ0aWVzJywgJ2FzcGVjdE5hbWVzJ10sXG4gICAgICAgICAgICBtYXhJdGVtczogcGFnaW5hdGlvbi5tYXhJdGVtcyxcbiAgICAgICAgICAgIHNraXBDb3VudDogcGFnaW5hdGlvbi5za2lwQ291bnQsXG4gICAgICAgICAgICB3aGVyZVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2l0ZXNBcGlcbiAgICAgICAgICAgICAgICAubGlzdFNpdGVzKG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICAgICAgIChwYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlLmxpc3QuZW50cmllcy5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHsgZW50cnkgfTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5Lm5hbWUgPSBlbnRyeS5uYW1lIHx8IGVudHJ5LnRpdGxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBlbnRyeSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHBhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5waXBlKGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBhbGwgaXRlbXMgY3VycmVudGx5IGluIHRoZSB0cmFzaC5cbiAgICAgKiBAcGFyYW0gcGFnaW5hdGlvbiBTcGVjaWZpZXMgaG93IHRvIHBhZ2luYXRlIHRoZSByZXN1bHRzXG4gICAgICogQHBhcmFtIGluY2x1ZGVGaWVsZHMgTGlzdCBvZiBkYXRhIGZpZWxkIG5hbWVzIHRvIGluY2x1ZGUgaW4gdGhlIHJlc3VsdHNcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIGRlbGV0ZWQgaXRlbXNcbiAgICAgKi9cbiAgICBsb2FkVHJhc2hjYW4ocGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsLCBpbmNsdWRlRmllbGRzOiBzdHJpbmdbXSA9IFtdKTogT2JzZXJ2YWJsZTxEZWxldGVkTm9kZXNQYWdpbmc+IHtcbiAgICAgICAgY29uc3QgaW5jbHVkZUZpZWxkc1JlcXVlc3QgPSB0aGlzLmdldEluY2x1ZGVzRmllbGRzKGluY2x1ZGVGaWVsZHMpO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICBpbmNsdWRlOiBpbmNsdWRlRmllbGRzUmVxdWVzdCxcbiAgICAgICAgICAgIG1heEl0ZW1zOiBwYWdpbmF0aW9uLm1heEl0ZW1zLFxuICAgICAgICAgICAgc2tpcENvdW50OiBwYWdpbmF0aW9uLnNraXBDb3VudFxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMudHJhc2hjYW5BcGkubGlzdERlbGV0ZWROb2RlcyhvcHRpb25zKSlcbiAgICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IoKGVycikgPT4gdGhpcy5oYW5kbGVFcnJvcihlcnIpKSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHNoYXJlZCBsaW5rcyBmb3IgdGhlIGN1cnJlbnQgdXNlci5cbiAgICAgKiBAcGFyYW0gcGFnaW5hdGlvbiBTcGVjaWZpZXMgaG93IHRvIHBhZ2luYXRlIHRoZSByZXN1bHRzXG4gICAgICogQHBhcmFtIGluY2x1ZGVGaWVsZHMgTGlzdCBvZiBkYXRhIGZpZWxkIG5hbWVzIHRvIGluY2x1ZGUgaW4gdGhlIHJlc3VsdHNcbiAgICAgKiBAcGFyYW0gd2hlcmUgQSBzdHJpbmcgdG8gcmVzdHJpY3QgdGhlIHJldHVybmVkIG9iamVjdHMgYnkgdXNpbmcgYSBwcmVkaWNhdGVcbiAgICAgKiBAcmV0dXJucyBMaXN0IG9mIHNoYXJlZCBsaW5rc1xuICAgICAqL1xuICAgIGxvYWRTaGFyZWRMaW5rcyhwYWdpbmF0aW9uOiBQYWdpbmF0aW9uTW9kZWwsIGluY2x1ZGVGaWVsZHM6IHN0cmluZ1tdID0gW10sIHdoZXJlPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxTaGFyZWRMaW5rUGFnaW5nPiB7XG4gICAgICAgIGNvbnN0IGluY2x1ZGVGaWVsZHNSZXF1ZXN0ID0gdGhpcy5nZXRJbmNsdWRlc0ZpZWxkcyhpbmNsdWRlRmllbGRzKTtcblxuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAgaW5jbHVkZTogaW5jbHVkZUZpZWxkc1JlcXVlc3QsXG4gICAgICAgICAgICBtYXhJdGVtczogcGFnaW5hdGlvbi5tYXhJdGVtcyxcbiAgICAgICAgICAgIHNraXBDb3VudDogcGFnaW5hdGlvbi5za2lwQ291bnQsXG4gICAgICAgICAgICB3aGVyZVxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmcm9tKHRoaXMuc2hhcmVkTGlua3NBcGkubGlzdFNoYXJlZExpbmtzKG9wdGlvbnMpKVxuICAgICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcigoZXJyKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycikpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJcyB0aGUgZm9sZGVyIElEIG9uZSBvZiB0aGUgd2VsbC1rbm93biBhbGlhc2VzP1xuICAgICAqIEBwYXJhbSBmb2xkZXJJZCBGb2xkZXIgSUQgbmFtZSB0byBjaGVja1xuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIElEIGlzIGEgd2VsbC1rbm93biBuYW1lLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBpc0N1c3RvbVNvdXJjZShmb2xkZXJJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBpc0N1c3RvbVNvdXJjZXMgPSBmYWxzZTtcbiAgICAgICAgY29uc3Qgc291cmNlcyA9IFsnLXRyYXNoY2FuLScsICctc2hhcmVkbGlua3MtJywgJy1zaXRlcy0nLCAnLW15c2l0ZXMtJywgJy1mYXZvcml0ZXMtJywgJy1yZWNlbnQtJ107XG5cbiAgICAgICAgaWYgKHNvdXJjZXMuaW5kZXhPZihmb2xkZXJJZCkgPiAtMSkge1xuICAgICAgICAgICAgaXNDdXN0b21Tb3VyY2VzID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpc0N1c3RvbVNvdXJjZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSXMgdGhlIGZvbGRlciBJRCBhIFwiLW15XCIsIFwiLXJvb3QtXCIsIG9yIFwiLXNoYXJlZC1cIiBhbGlhcz9cbiAgICAgKiBAcGFyYW0gZm9sZGVySWQgRm9sZGVyIElEIG5hbWUgdG8gY2hlY2tcbiAgICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBJRCBpcyBvbmUgb2YgdGhlIHN1cHBvcnRlZCBzb3VyY2VzLCBmYWxzZSBvdGhlcndpc2VcbiAgICAgKi9cbiAgICBpc1N1cHBvcnRlZFNvdXJjZShmb2xkZXJJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBpc1N1cHBvcnRlZFNvdXJjZXMgPSBmYWxzZTtcbiAgICAgICAgY29uc3Qgc291cmNlcyA9IFsnLW15LScsICctcm9vdC0nLCAnLXNoYXJlZC0nXTtcblxuICAgICAgICBpZiAoc291cmNlcy5pbmRleE9mKGZvbGRlcklkKSA+IC0xKSB7XG4gICAgICAgICAgICBpc1N1cHBvcnRlZFNvdXJjZXMgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkU291cmNlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXRzIGEgZm9sZGVyJ3MgY29udGVudHMuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IGZvbGRlciBub2RlXG4gICAgICogQHBhcmFtIHBhZ2luYXRpb24gU3BlY2lmaWVzIGhvdyB0byBwYWdpbmF0ZSB0aGUgcmVzdWx0c1xuICAgICAqIEBwYXJhbSBpbmNsdWRlRmllbGRzIExpc3Qgb2YgZGF0YSBmaWVsZCBuYW1lcyB0byBpbmNsdWRlIGluIHRoZSByZXN1bHRzXG4gICAgICogQHBhcmFtIHdoZXJlICBGaWx0ZXJzIHRoZSBOb2RlIGxpc3QgdXNpbmcgdGhlICp3aGVyZSogY29uZGl0aW9uIG9mIHRoZSBSRVNUIEFQSSAoZm9yIGV4YW1wbGUsIGlzRm9sZGVyPXRydWUpLiBTZWUgdGhlIFJFU1QgQVBJIGRvY3VtZW50YXRpb24gZm9yIG1vcmUgaW5mb3JtYXRpb24uXG4gICAgICogQHJldHVybnMgTGlzdCBvZiBpdGVtcyBjb250YWluZWQgaW4gdGhlIGZvbGRlclxuICAgICAqL1xuICAgIGxvYWRGb2xkZXJCeU5vZGVJZChub2RlSWQ6IHN0cmluZywgcGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsLCBpbmNsdWRlRmllbGRzOiBzdHJpbmdbXSA9IFtdLCB3aGVyZT86IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGlmIChub2RlSWQgPT09ICctdHJhc2hjYW4tJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9hZFRyYXNoY2FuKHBhZ2luYXRpb24sIGluY2x1ZGVGaWVsZHMpO1xuICAgICAgICB9IGVsc2UgaWYgKG5vZGVJZCA9PT0gJy1zaGFyZWRsaW5rcy0nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2FkU2hhcmVkTGlua3MocGFnaW5hdGlvbiwgaW5jbHVkZUZpZWxkcywgd2hlcmUpO1xuICAgICAgICB9IGVsc2UgaWYgKG5vZGVJZCA9PT0gJy1zaXRlcy0nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2FkU2l0ZXMocGFnaW5hdGlvbiwgd2hlcmUpO1xuICAgICAgICB9IGVsc2UgaWYgKG5vZGVJZCA9PT0gJy1teXNpdGVzLScpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvYWRNZW1iZXJTaXRlcyhwYWdpbmF0aW9uLCB3aGVyZSk7XG4gICAgICAgIH0gZWxzZSBpZiAobm9kZUlkID09PSAnLWZhdm9yaXRlcy0nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2FkRmF2b3JpdGVzKHBhZ2luYXRpb24sIGluY2x1ZGVGaWVsZHMsIHdoZXJlKTtcbiAgICAgICAgfSBlbHNlIGlmIChub2RlSWQgPT09ICctcmVjZW50LScpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFJlY2VudEZpbGVzKCctbWUtJywgcGFnaW5hdGlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBUT0RPOiByZW1vdmUgaXQgZnJvbSBoZXJlXG5cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBjb250ZW50cyBvZiBvbmUgb2YgdGhlIHdlbGwta25vd24gYWxpYXNlcyBpbiB0aGUgZm9ybSBvZiBub2RlIElEIHN0cmluZ3MuXG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgdGFyZ2V0IGZvbGRlciBub2RlXG4gICAgICogQHBhcmFtIHBhZ2luYXRpb24gU3BlY2lmaWVzIGhvdyB0byBwYWdpbmF0ZSB0aGUgcmVzdWx0c1xuICAgICAqIEByZXR1cm5zIExpc3Qgb2Ygbm9kZSBJRHNcbiAgICAgKi9cbiAgICBnZXRDb3JyZXNwb25kaW5nTm9kZUlkcyhub2RlSWQ6IHN0cmluZywgcGFnaW5hdGlvbjogUGFnaW5hdGlvbk1vZGVsID0ge30pOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgICAgIGlmICh0aGlzLmlzQ3VzdG9tU291cmNlKG5vZGVJZCkpIHtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9hZEZvbGRlckJ5Tm9kZUlkKG5vZGVJZCwgcGFnaW5hdGlvbilcbiAgICAgICAgICAgICAgICAucGlwZShtYXAoKHJlc3VsdDogYW55KTogc3RyaW5nW10gPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0Lmxpc3QuZW50cmllcy5tYXAoKG5vZGU6IGFueSk6IHN0cmluZyA9PiB0aGlzLmdldElkRnJvbUVudHJ5KG5vZGUsIG5vZGVJZCkpO1xuICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICB9IGVsc2UgaWYgKG5vZGVJZCkge1xuICAgICAgICAgICAgLy8gY2FzZXMgd2hlbiBub2RlSWQgaXMgJy1teS0nLCAnLXJvb3QtJyBvciAnLXNoYXJlZC0nXG4gICAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLm5vZGVzQXBpLmdldE5vZGUobm9kZUlkKVxuICAgICAgICAgICAgICAgIC50aGVuKChub2RlKSA9PiBbbm9kZS5lbnRyeS5pZF0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hvb3NlcyB0aGUgY29ycmVjdCBJRCBmb3IgYSBub2RlIGVudHJ5LlxuICAgICAqIEBwYXJhbSBub2RlIE5vZGUgb2JqZWN0XG4gICAgICogQHBhcmFtIG5vZGVJZCBJRCBvZiB0aGUgbm9kZSBvYmplY3RcbiAgICAgKiBAcmV0dXJucyBJRCB2YWx1ZVxuICAgICAqL1xuICAgIGdldElkRnJvbUVudHJ5KG5vZGU6IGFueSwgbm9kZUlkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAobm9kZUlkID09PSAnLXNoYXJlZGxpbmtzLScpIHtcbiAgICAgICAgICAgIHJldHVybiBub2RlLmVudHJ5Lm5vZGVJZDtcbiAgICAgICAgfSBlbHNlIGlmIChub2RlSWQgPT09ICctc2l0ZXMtJyB8fCBub2RlSWQgPT09ICctbXlzaXRlcy0nKSB7XG4gICAgICAgICAgICByZXR1cm4gbm9kZS5lbnRyeS5ndWlkO1xuICAgICAgICB9IGVsc2UgaWYgKG5vZGVJZCA9PT0gJy1mYXZvcml0ZXMtJykge1xuICAgICAgICAgICAgcmV0dXJuIG5vZGUuZW50cnkudGFyZ2V0R3VpZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBub2RlLmVudHJ5LmlkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRG9lcyB0aGUgd2VsbC1rbm93biBhbGlhcyBoYXZlIGEgY29ycmVzcG9uZGluZyBub2RlIElEP1xuICAgICAqIEBwYXJhbSBub2RlSWQgTm9kZSB0byBjaGVja1xuICAgICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIGFsaWFzIGhhcyBhIGNvcnJlc3BvbmRpbmcgbm9kZSBJRCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICovXG4gICAgaGFzQ29ycmVzcG9uZGluZ05vZGVJZHMobm9kZUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNDdXN0b21Tb3VyY2Uobm9kZUlkKSB8fCB0aGlzLmlzU3VwcG9ydGVkU291cmNlKG5vZGVJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRJbmNsdWRlc0ZpZWxkcyhpbmNsdWRlRmllbGRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIFsncGF0aCcsICdwcm9wZXJ0aWVzJywgJ2FsbG93YWJsZU9wZXJhdGlvbnMnLCAncGVybWlzc2lvbnMnLCAnYXNwZWN0TmFtZXMnLCAuLi5pbmNsdWRlRmllbGRzXVxuICAgICAgICAgICAgLmZpbHRlcigoZWxlbWVudCwgaW5kZXgsIGFycmF5KSA9PiBpbmRleCA9PT0gYXJyYXkuaW5kZXhPZihlbGVtZW50KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogUmVzcG9uc2UpIHtcbiAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IgfHwgJ1NlcnZlciBlcnJvcicpO1xuICAgIH1cbn1cbiJdfQ==